import { auth, database } from './firebase-config.js';
import { createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©
setPersistence(auth, browserLocalPersistence)
    .then(() => {
        console.log("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    })
    .catch((error) => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©:", error);
    });

// ===== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª =====
document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab');
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
        button.classList.add('active');
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
        document.querySelectorAll('.auth-form').forEach(form => {
            form.classList.remove('active');
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯
        document.getElementById(tab + 'Form').classList.add('active');
    });
});

// ===== Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ =====
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const errorElement = document.getElementById('registerError');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (password.length < 6) {
        errorElement.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        return;
    }
    
    if (username.length < 3) {
        errorElement.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        return;
    }
    
    if (!email.includes('@') || !email.includes('.')) {
        errorElement.textContent = 'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
        return;
    }
    
    errorElement.textContent = '';
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
    submitBtn.disabled = true;
    
    try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨...');
        
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹
        const usernameRef = ref(database, 'usernames/' + username);
        const usernameSnapshot = await get(usernameRef);
        
        if (usernameSnapshot.exists()) {
            errorElement.textContent = 'âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ² Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø±';
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Authentication
        console.log('ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Authentication...');
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Authentication:', user.uid);
        
        // 3. Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ€ "Ù…Ø­Ø¬ÙˆØ²" ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await set(usernameRef, user.uid);
        console.log('âœ… ØªÙ… Ø­Ø¬Ø² Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', username);
        
        // 4. Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const userData = {
            uid: user.uid,
            username: username,
            email: email,
            createdAt: Date.now(),
            lastLogin: Date.now(),
            status: 'active'
        };
        
        await set(ref(database, 'users/' + user.uid), userData);
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        
        // 5. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        console.log('ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
        await signInWithEmailAndPassword(auth, email, password);
        
        // 6. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage
        localStorage.setItem('currentUser', JSON.stringify(userData));
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage');
        
        // 7. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        console.log('ğŸ”„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
        submitBtn.textContent = 'âœ… ØªÙ…! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';
        
        // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… ØªÙˆØ¬ÙŠÙ‡
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 1500);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', error);
        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
        
        switch(error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹';
                break;
            case 'auth/invalid-email':
                errorMessage = 'ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
                break;
            case 'auth/weak-password':
                errorMessage = 'ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
                break;
            case 'auth/operation-not-allowed':
                errorMessage = 'â›” Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…ÙØ¹Ù„ ÙÙŠ Firebase';
                break;
            default:
                errorMessage = `âŒ ${error.message}`;
        }
        
        errorElement.textContent = errorMessage;
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.textContent = '';
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
    submitBtn.disabled = true;
    
    try {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
        
        // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const usersRef = ref(database, 'users');
        const usersSnapshot = await get(usersRef);
        
        let userEmail = null;
        let userData = null;
        
        usersSnapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            if (data.username && data.username.toLowerCase() === username.toLowerCase()) {
                userEmail = data.email;
                userData = data;
                console.log('âœ… ÙˆØ¬Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', data.username);
            }
        });
        
        if (!userEmail) {
            errorElement.textContent = 'ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        console.log('ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:', userEmail);
        const userCredential = await signInWithEmailAndPassword(auth, userEmail, password);
        const user = userCredential.user;
        console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­:', user.uid);
        
        // 3. ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
        if (userData) {
            await set(ref(database, 'users/' + user.uid + '/lastLogin'), Date.now());
            userData.lastLogin = Date.now();
            
            // 4. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage
            localStorage.setItem('currentUser', JSON.stringify(userData));
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage');
        }
        
        // 5. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        submitBtn.textContent = 'âœ… ØªÙ…! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';
        
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 1000);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        
        switch(error.code) {
            case 'auth/user-not-found':
                errorMessage = 'ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                break;
            case 'auth/wrong-password':
                errorMessage = 'ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                break;
            case 'auth/invalid-credential':
                errorMessage = 'âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'â³ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„';
                break;
            case 'auth/user-disabled':
                errorMessage = 'ğŸš« ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨';
                break;
            default:
                errorMessage = `âŒ ${error.message}`;
        }
        
        errorElement.textContent = errorMessage;
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
onAuthStateChanged(auth, (user) => {
    console.log('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', user ? 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…');
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ‡Ùˆ ÙÙŠ ØµÙØ­Ø© authØŒ ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if (user && window.location.pathname.includes('auth.html')) {
        console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ØªÙˆØ¬ÙŠÙ‡ Ù„Ù€ index.html');
        window.location.href = 'index.html';
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ ÙˆÙ‡Ùˆ ÙÙŠ index.htmlØŒ ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù„Ù„ØªØ³Ø¬ÙŠÙ„
    if (!user && window.location.pathname.includes('index.html')) {
        console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ØŒ ØªÙˆØ¬ÙŠÙ‡ Ù„Ù€ auth.html');
        window.location.href = 'auth.html';
    }
});

// ===== ÙØ­Øµ localStorage Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­ =====
console.log('ğŸ“¦ localStorage Ø§Ù„Ø­Ø§Ù„ÙŠ:', {
    currentUser: localStorage.getItem('currentUser'),
    authState: auth.currentUser ? 'Ù…Ø³Ø¬Ù„' : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'
});
