<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">
<style>
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Progress Bar System ===== */
.top-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: transparent;
    z-index: 9999;
    display: none;
}

.progress-bar-line {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #38bdf8, #0ea5e9, #0284c7);
    transition: width 0.4s ease;
    position: relative;
    overflow: hidden;
}

.progress-bar-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent);
    animation: progressShine 1.5s infinite;
}

@keyframes progressShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* ===== Skeleton Loading ===== */
.skeleton-card {
    background: #1c1f27;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #2d3748;
    margin-bottom: 15px;
}

.skeleton-line {
    height: 16px;
    background: #2d3748;
    border-radius: 4px;
    margin-bottom: 10px;
}

/* ===== Button Loading State ===== */
.btn.loading {
    position: relative;
    color: transparent !important;
    pointer-events: none;
}

.btn.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== Budget Dialog ===== */
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
  z-index:103;
  display:none;
  opacity:0;
  transition: opacity 0.3s ease;
  border: 1px solid #374151;
  max-width: 400px;
  width: 90%;
}
.budget-dialog.show{
  display:block;
  opacity:1;
}
.budget-dialog input {
  width:100%;
  padding:10px;
  margin:10px 0;
  border-radius:6px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
  transition: border-color 0.2s;
}
.budget-dialog input:focus{
  outline:none;
  border-color:#38bdf8;
}
.budget-dialog button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition: all 0.2s;
  min-width: 80px;
}
.budget-dialog button:not(.close-btn){
  background:#38bdf8;
  color:#000;
}
.budget-dialog button:not(.close-btn):hover{
  background:#0ea5e9;
  transform: translateY(-1px);
}
.budget-dialog button:not(.close-btn):active{
  transform: translateY(0);
}
.budget-dialog .close-btn{
  background:#ef4444;
  margin-left:10px;
  color:#fff;
}
.budget-dialog .close-btn:hover{
  background:#dc2626;
  transform: translateY(-1px);
}
.budget-dialog .close-btn:active{
  transform: translateY(0);
}

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#1c1f27;
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
  color:#e5e7eb;
  z-index:104;
  display:none;
  max-width:450px;
  width:90%;
  border: 1px solid #374151;
}
.details-dialog h2 {
  color:#38bdf8;
  margin-bottom:15px;
  border-bottom:2px solid #374151;
  padding-bottom:15px;
  font-size:22px;
}
.details-dialog p {
  margin:10px 0;
  font-size:14px;
  line-height:1.6;
}
.details-dialog p strong {
  color: #9ca3af;
  display: inline-block;
  width: 90px;
  font-weight: 600;
}
.details-dialog button {
  margin-top:20px;
  padding:12px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:linear-gradient(135deg, #38bdf8, #0ea5e9);
  color:#000;
  font-weight:bold;
  width:100%;
  transition: all 0.2s;
  font-size:16px;
}
.details-dialog button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
}
.details-dialog button:active {
  transform: translateY(0);
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
  border: 1px solid #374151;
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
  cursor: pointer;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}
.user-info p:hover { 
  color: #0ea5e9; 
}
.user-info small {
  color: #9ca3af;
  font-size: 12px;
  display: block;
  margin-bottom: 10px;
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
  transition: background 0.2s, transform 0.1s;
}
.logout-btn:hover { 
  background: #dc2626; 
}
.logout-btn:active {
  transform: scale(0.98);
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
  transition: background 0.2s, transform 0.1s;
}
.auth-btn:hover { 
  background: #374151; 
  transform: translateY(-2px);
}
.auth-btn:active {
  transform: translateY(0);
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
  position: relative;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<!-- Progress Bar -->
<div class="top-progress-bar" id="topProgressBar">
    <div class="progress-bar-line" id="progressBarLine"></div>
</div>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Progress Manager
class ProgressManager {
    constructor() {
        this.topProgressBar = document.getElementById('topProgressBar');
        this.progressBarLine = document.getElementById('progressBarLine');
        this.totalItems = 0;
        this.loadedItems = 0;
    }
    
    startLoading(totalItems) {
        this.totalItems = totalItems;
        this.loadedItems = 0;
        this.topProgressBar.style.display = 'block';
        this.progressBarLine.style.width = '0%';
    }
    
    updateProgress() {
        this.loadedItems++;
        const percent = (this.loadedItems / this.totalItems) * 100;
        this.progressBarLine.style.width = `${Math.min(percent, 100)}%`;
        
        if (this.loadedItems >= this.totalItems) {
            this.completeLoading();
        }
    }
    
    completeLoading() {
        this.progressBarLine.style.width = '100%';
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.progressBarLine.style.width = '0%';
        }, 500);
    }
    
    showError() {
        this.progressBarLine.style.background = '#ef4444';
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.progressBarLine.style.width = '0%';
            this.progressBarLine.style.background = '';
        }, 1500);
    }
}

const progressManager = new ProgressManager();

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebaseapp.com",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const db = firebase.database();
firebase.auth().signInAnonymously().catch(err=>console.error(err));

let userUID = null;
firebase.auth().onAuthStateChanged(u=>{
    if(u) userUID = u.uid;
});

const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
let budget = null;
let budgetActive = false;

let currentPage = 1;
const postsPerPage = 6;

let currentUser = null;
let userDisplayName = null;
let userFullName = null;

// Sidebar
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}
function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// Home
function showHome(){
  closeSidebar();
  
  const budgetText = budgetActive ? `ğŸ’° ${budget.toLocaleString()} Ø¯.Ø¹` : 'ğŸ’° Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ';
  const budgetBtnClass = budgetActive ? 'budget-btn active' : 'budget-btn';
  
  document.getElementById("content").innerHTML = `
    <div class="search-bar">
      <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()">
      <select id="cat" onchange="loadProducts()">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
        ${categories.map(c=>`<option>${c}</option>`).join("")}
      </select>
      <button onclick="showBudgetDialog()" class="${budgetBtnClass}">${budgetText}</button>
      ${budgetActive ? `<button onclick="clearBudget()" class="clear-budget-btn" style="background:#ef4444; color:white; padding:10px 15px; border-radius:6px; border:none; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>` : ''}
    </div>
    <div class="cards" id="products"></div>
    <div id="pagination" style="text-align:center;margin:20px"></div>
  `;
  
  loadProducts();
}

function clearBudget() {
  budget = null;
  budgetActive = false;
  showHome();
}

// Budget Dialog
function showBudgetDialog(){
  document.getElementById("budgetDialog").classList.add("show");
}
function closeBudget(){
  document.getElementById("budgetDialog").classList.remove("show");
}
function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  budget = !isNaN(val) ? val : null;
  budgetActive = budget !== null;
  closeBudget();
  showHome();
}

// Load Products
function loadProducts(){
  const search = document.getElementById("search")?.value.toLowerCase() || '';
  const category = document.getElementById("cat")?.value || '';
  
  db.ref("products").once("value",snap=>{
    const data = snap.val() || {};
    let allProducts = [];
    
    Object.keys(data).forEach(key=>{
      const product = data[key];
      const price = parseFloat(product.price) || 0;
      
      if((!category || product.category===category) && product.name.toLowerCase().includes(search)){
        if(budgetActive && price > budget) return;
        
        allProducts.push({
          key: key,
          product: product,
          price: price
        });
      }
    });
    
    // Sort by user's products first
    if(userUID){
      allProducts.sort((a,b)=>{
        if(a.product.uid === userUID && b.product.uid !== userUID) return -1;
        if(a.product.uid !== userUID && b.product.uid === userUID) return 1;
        return 0;
      });
    }
    
    const totalProducts = allProducts.length;
    const totalPages = Math.ceil(totalProducts / postsPerPage);
    
    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„ØµÙØ­Ø© 1 ØªØ¸Ù‡Ø± 2 Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙ‚Ø·
    // Ø§Ù„Ø³Ø¨Ø¨: ÙƒØ§Ù† currentPage > totalPages ÙÙŠØ¹ÙˆØ¯ currentPage = 1 Ù„ÙƒÙ† Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ ÙŠÙƒÙˆÙ† Ø®Ø§Ø·Ø¦
    if(currentPage > totalPages) {
      currentPage = Math.max(1, totalPages);
    }
    
    const startIndex = (currentPage - 1) * postsPerPage;
    const endIndex = Math.min(startIndex + postsPerPage, totalProducts);
    
    console.log(`Ø§Ù„ØµÙØ­Ø© ${currentPage}: Ù…Ù† ${startIndex} Ø¥Ù„Ù‰ ${endIndex} (${endIndex - startIndex} Ù…Ù†Ø´ÙˆØ±)`);
    
    // Ø¨Ø¯Ø¡ Progress Bar Ø¨Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
    progressManager.startLoading(allProducts.length);
    
    const productsContainer = document.getElementById('products');
    if (!productsContainer) return;
    
    // Ø¹Ø±Ø¶ Skeleton Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    productsContainer.innerHTML = `
      <div class="skeleton-card"><div class="skeleton-line" style="width:70%"></div><div class="skeleton-line" style="width:40%"></div><div class="skeleton-line" style="width:60%"></div></div>
      <div class="skeleton-card"><div class="skeleton-line" style="width:70%"></div><div class="skeleton-line" style="width:40%"></div><div class="skeleton-line" style="width:60%"></div></div>
      <div class="skeleton-card"><div class="skeleton-line" style="width:70%"></div><div class="skeleton-line" style="width:40%"></div><div class="skeleton-line" style="width:60%"></div></div>
    `;
    
    setTimeout(() => {
      let productsHTML = '';
      const currentPageProducts = allProducts.slice(startIndex, endIndex);
      
      currentPageProducts.forEach(item => {
        const p = item.product;
        
        const sellerSection = userDisplayName ? 
          `<div class="seller">
            ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">${p.seller}</span> | â˜ ${p.phone}
            <br><small style="color:#9ca3af; font-size:11px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
          </div>` :
          `<div class="seller">
            ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
          </div>`;
        
        // Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù€ hover
        const actionsHTML = p.uid === userUID ? 
          `<div class="actions" style="opacity: 1; display: flex;">
            <button class="edit" onclick="event.stopPropagation(); editProduct('${item.key}')">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="del" onclick="event.stopPropagation(); deleteProduct('${item.key}')">Ø­Ø°Ù</button>
          </div>` : 
          `<div class="actions" style="opacity: 1; display: flex;">
            <button class="edit" onclick="event.stopPropagation(); showDetails('${item.key}')">Ø¹Ø±Ø¶</button>
          </div>`;
        
        productsHTML += `
          <div class="card" onclick="showDetails('${item.key}')">
            <h3>${p.name}</h3>
            <span class="price">${p.price} Ø¯.Ø¹</span>
            <div class="meta">
              <span>${p.category}</span>
              <span>${p.province}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery}</span>
            </div>
            ${sellerSection}
            ${actionsHTML}
          </div>`;
        
        // ØªØ­Ø¯ÙŠØ« Progress Ø¨Ø¹Ø¯ ÙƒÙ„ Ù…Ù†ØªØ¬
        progressManager.updateProgress();
      });
      
      if(productsHTML === ''){
        productsHTML = `<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ${budgetActive ? 'Ø¶Ù…Ù† Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ' : ''}</p>`;
        progressManager.completeLoading();
      }
      
      productsContainer.innerHTML = productsHTML;
      renderPagination(totalPages);
      
    }, 300);
    
  }).catch(error => {
    console.error("Error loading products:", error);
    const productsContainer = document.getElementById('products');
    if(productsContainer){
      productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    }
    progressManager.showError();
  });
}

// Render Pagination Buttons
function renderPagination(total){
  const pagination = document.getElementById('pagination');
  if(!pagination) return;
  
  let html = "";
  
  if(total > 1){
    if(currentPage > 1){
      html += `<button onclick="goPage(${currentPage - 1})" style="margin:3px; padding:6px 10px; border-radius:5px; border:none; cursor:pointer; background:#1f2937; color:#fff;">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>`;
    }
    
    for(let i = 1; i <= total; i++){
      html += `<button onclick="goPage(${i})" style="margin:3px; padding:6px 10px; border-radius:5px; border:none; cursor:pointer; background:${i===currentPage?'#38bdf8':'#1f2937'}; color:${i===currentPage?'#000':'#fff'};">${i}</button>`;
    }
    
    if(currentPage < total){
      html += `<button onclick="goPage(${currentPage + 1})" style="margin:3px; padding:6px 10px; border-radius:5px; border:none; cursor:pointer; background:#1f2937; color:#fff;">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
    }
  }
  
  pagination.innerHTML = html;
}

function goPage(page){
  currentPage = page;
  loadProducts();
  window.scrollTo(0, 0);
}

// Delete Product
function deleteProduct(key){ 
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹
    db.ref("products/" + key).once('value', (snapshot) => {
      const product = snapshot.val();
      if (product) {
        // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (product.uid) {
          db.ref('users/' + product.uid).once('value', (userSnapshot) => {
            const userData = userSnapshot.val();
            if (userData) {
              const currentCount = userData.totalProducts || 0;
              if (currentCount > 0) {
                db.ref('users/' + product.uid).update({
                  totalProducts: currentCount - 1
                });
              }
            }
          });
        }
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬
        db.ref("products/"+key).remove().then(() => {
          loadProducts();
        });
      }
    });
  } 
}

function editProduct(key){
  db.ref("products/"+key).once("value",snap=>{
    showPublish(snap.val(),key);
  });
}

// Show Publish Form
function showPublish(product=null, key=null){
  closeSidebar();
  
  const sellerName = userDisplayName || (product ? product.seller : "");
  const sellerField = userDisplayName ? 
    `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
     <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
    `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}">`;
  
  document.getElementById("content").innerHTML=`
    <div class="form-box">
      <h2>${product?"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†":"Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${product?product.name:""}">
      <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${product?product.price:""}">
      <select id="category">${categories.map(c=>`<option ${product&&product.category===c?"selected":""}>${c}</option>`).join("")}</select>
      ${sellerField}
      <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${product?product.phone:""}">
      <input id="province" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" value="${product?product.province:""}">
      <select id="delivery">
        <option ${product&&product.delivery==="Ù†Ø¹Ù…"?"selected":""}>Ù†Ø¹Ù…</option>
        <option ${product&&product.delivery==="Ù„Ø§"?"selected":""}>Ù„Ø§</option>
      </select>
      <button onclick="save('${key||""}')">ğŸ’¾ Ø­ÙØ¸</button>
    </div>`;
}

// Save Product
function save(key){
  const phone = document.getElementById("phone").value.trim();
  if(!/^[0][0-9]{10}$/.test(phone)){
    alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±.");
    return;
  }

  const seller = userDisplayName || document.getElementById("seller").value;

  const data = {
    name: document.getElementById("name").value,
    price: document.getElementById("price").value,
    category: document.getElementById("category").value,
    seller: seller,
    phone: phone,
    province: document.getElementById("province").value,
    delivery: document.getElementById("delivery").value,
    uid: userUID,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  };
  
  const ref = key ? db.ref("products/"+key) : db.ref("products").push();
  
  ref.set(data).then(() => {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·)
    if (!key && userUID) {
      db.ref('users/' + userUID).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          db.ref('users/' + userUID).update({
            totalProducts: currentCount + 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        } else {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§
          db.ref('users/' + userUID).update({
            totalProducts: 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    }
    showHome();
  }).catch(error => {
    console.error("Error saving product:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  });
}

// Show Details
function showDetails(key){
  db.ref("products/"+key).once("value",snap=>{
    const product = snap.val();
    if(!product) return;
    
    const sellerWithLink = userDisplayName ? 
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${product.uid}', '${product.seller}')" style="font-weight:bold;">${product.seller}</span></p>
       <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${product.seller}</p>`;
    
    document.getElementById("detailsContent").innerHTML = `
      <h2>${product.name}</h2>
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${product.price} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${product.category}</p>
      ${sellerWithLink}
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${product.phone}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${product.province}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${product.delivery}</p>
      ${product.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
      <div style="margin-top:20px; display:flex; gap:10px;">
        ${product.uid === userUID ? `
          <button onclick="editProduct('${key}')" style="flex:1; padding:10px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer;">ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteProduct('${key}')" style="flex:1; padding:10px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer;">Ø­Ø°Ù</button>
        ` : ''}
      </div>
    `;
    document.getElementById("detailsDialog").style.display="block";
  });
}

function closeDetails(){
  document.getElementById("detailsDialog").style.display="none";
}

// Update Auth UI
function updateAuthUI() {
  const authSection = document.getElementById("authSection");
  if (!authSection) return;
  
  if (currentUser && userDisplayName) {
    const displayName = userFullName || userDisplayName;
    authSection.innerHTML = `
      <div class="user-info">
        <p class="profile-link" onclick="viewMyProfile()">ğŸ‘¤ ${displayName}</p>
        <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
        <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    `;
  } else {
    authSection.innerHTML = `
      <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    `;
  }
}

function logoutUser() {
  firebase.auth().signOut()
    .then(() => {
      currentUser = null;
      userDisplayName = null;
      userFullName = null;
      updateAuthUI();
      showHome();
    })
    .catch((error) => {
      console.error("Logout error:", error);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    });
}

// View Profile
function viewProfile(userId, sellerName) {
  if (sellerName) {
    localStorage.setItem('profileSellerName', sellerName);
  }
  
  window.location.href = `profile.html?id=${userId}`;
}

function viewMyProfile() {
  if (currentUser && currentUser.uid) {
    window.location.href = `profile.html?id=${currentUser.uid}`;
  } else {
    alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    window.location.href = 'login.html';
  }
}

// Auth State Changed
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    userUID = user.uid;
    
    db.ref("users/" + user.uid).once("value", snapshot => {
      const userData = snapshot.val();
      if (userData) {
        userDisplayName = userData.username;
        userFullName = userData.fullName || userData.username;
        updateAuthUI();
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
        db.ref("users/" + user.uid).update({
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
      }
    });
  } else {
    currentUser = null;
    userDisplayName = null;
    userFullName = null;
    updateAuthUI();
  }
});

// Init
document.addEventListener("DOMContentLoaded",function(){
  showHome();
  updateAuthUI();
});
</script>
</body>
</html>