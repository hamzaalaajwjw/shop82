# أمن وتعزيز موقع a3len.store
RewriteEngine On

# ===== نظام الروابط الجديد p/ =====
# يجب أن تكون في الأعلى - معالجة الروابط المباشرة /p/ID
RewriteRule ^p/([a-zA-Z0-9]+)$ index.html [L,QSA]

# ===== ريداكت من الروابط القديمة =====
# تحويل الروابط القديمة (?post=) إلى الجديدة (/p/)
RewriteCond %{QUERY_STRING} ^post=([^&]+)
RewriteRule ^index\.html$ /p/%1? [R=301,L]

# ===== إعادة التوجيه لصفحات الملفات الشخصية =====
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^profile/([a-zA-Z0-9_-]+)/?$ profile.html?slug=$1 [L,QSA]

# ===== حماية ضد هجمات الملفات الحساسة =====
<FilesMatch "\.(env|log|ini|sql|bak|old|config|py|sh|key)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# حماية دليل البيانات
<FilesMatch "^\.(.*)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# حماية مجلدات معينة
RewriteRule ^(database|config|logs|backups|includes)/.*$ - [F,L]

# ===== أمان HTTP Headers =====
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy محسنة لجميع الخدمات
    Header set Content-Security-Policy "default-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net https://*.supabase.co; script-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://*.firebaseio.com https://*.supabase.co wss://*.firebaseio.com https://a3len-3ad54.firebasestorage.app; frame-src 'self' https://*.supabase.co;"
</IfModule>

# ===== ضغط Gzip للملفات =====
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    AddOutputFilter DEFLATE js css
</IfModule>

# ===== تعطيل فهرسة المجلدات =====
Options -Indexes

# ===== إعدادات الكاش =====
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/json "access plus 1 month"
</IfModule>

# ===== النظام الأساسي (يجب أن يكون في الأخير) =====
# إعادة توجيه جميع الطلبات إلى index.html إلا الملفات الحقيقية
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule ^(.*)$ index.html [L,QSA]

# ===== صفحات أخطاء مخصصة =====
ErrorDocument 404 /index.html
ErrorDocument 403 /index.html
ErrorDocument 500 /index.html

# ===== حماية ضد hotlinking =====
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https://a3len\.store/.*$ [NC]
RewriteCond %{HTTP_REFERER} !^https://www\.a3len\.store/.*$ [NC]
RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,NC,L]

# ===== إعدادات UTF-8 =====
AddDefaultCharset UTF-8

# ===== منع الوصول لملفات معينة =====
<FilesMatch "^(README\.md|CHANGELOG\.txt|composer\.json|package\.json|\.htaccess)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ===== حماية ضد هجمات SQL injection =====
RewriteCond %{QUERY_STRING} (;|<|>|'|"|\)|%0A|%0D|%22|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{QUERY_STRING} (cmd|command|exec|execute|passthru|shell) [NC,OR]
RewriteCond %{QUERY_STRING} (base64_encode|localhost|mosconfig) [NC,OR]
RewriteCond %{QUERY_STRING} (GLOBALS|REQUEST)(=|\[|%) [NC]
RewriteRule ^(.*)$ - [F,L]

# ===== تحسين SEO - Canonical URL =====
RewriteCond %{HTTP_HOST} ^www\.a3len\.store [NC]
RewriteRule ^(.*)$ https://a3len.store/$1 [L,R=301]

# ===== منع هجمات User-Agent السيئة =====
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00) [NC]
RewriteRule ^(.*)$ - [F,L]

# ===== إعدادات CORS للملفات الثابتة =====
<FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font\.css)$">
    <IfModule mod_headers.c>
        Header set Access-Control-Allow-Origin "*"
    </IfModule>
</FilesMatch>