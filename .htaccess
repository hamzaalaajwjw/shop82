# أمن وتعزيز موقع a3len.store
RewriteEngine On

# ===== 1. منع www وفرض HTTPS =====
RewriteCond %{HTTP_HOST} ^www\.a3len\.store [NC]
RewriteRule ^(.*)$ https://a3len.store/$1 [L,R=301]

# ===== 2. ريداكت من الروابط القديمة إلى الجديدة =====
RewriteCond %{QUERY_STRING} ^post=([a-zA-Z0-9_-]+)
RewriteRule ^(.*)$ /#p%1? [R=301,L]

# ===== 3. إعادة توجيه لصفحات الملفات الشخصية =====
RewriteRule ^profile/([a-zA-Z0-9_-]+)/?$ profile.html?slug=$1 [L,QSA]

# ===== 4. النظام الأساسي - SPAs (يجب أن يكون في الأخير) =====
# إعادة توجيه جميع الطلبات إلى index.html إلا الملفات الحقيقية
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule ^(.*)$ index.html [L,QSA]

# ===== حماية الملفات الحساسة =====
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|env|key|bak|config|py|old)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# حماية الملفات المخفية
<FilesMatch "^\.(.*)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# حماية مجلدات خاصة
<IfModule mod_rewrite.c>
    RewriteRule ^(database|config|logs|backups|includes|private)/.*$ - [F,L]
</IfModule>

# ===== أمان HTTP Headers =====
<IfModule mod_headers.c>
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy مبسطة وآمنة
    Header set Content-Security-Policy "default-src 'self' https://*.gstatic.com https://cdn.jsdelivr.net https://*.supabase.co; script-src 'self' https://*.gstatic.com https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self' https://*.firebaseio.com https://*.supabase.co wss://*.firebaseio.com https://a3len-3ad54.firebasestorage.app; frame-src 'self' https://*.supabase.co;"
    
    # إعدادات HSTS (لمواقع HTTPS)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# ===== تحسين الأداء =====
<IfModule mod_deflate.c>
    # ضغط Gzip للأنواع الشائعة
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml application/rss+xml
    AddOutputFilter DEFLATE js css
</IfModule>

<IfModule mod_expires.c>
    ExpiresActive On
    
    # الصور
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # الملفات النصية
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/json "access plus 1 month"
    
    # الخطوط
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# ===== إعدادات أساسية =====
# تعطيل فهرسة المجلدات
Options -Indexes

# صفحات أخطاء مخصصة
ErrorDocument 404 /index.html
ErrorDocument 403 /index.html
ErrorDocument 500 /index.html

# إعدادات UTF-8
AddDefaultCharset UTF-8
AddDefaultCharset UTF-8 .html .css .js .json

# ===== حماية ضد hotlinking =====
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https://a3len\.store/.*$ [NC]
    RewriteCond %{HTTP_REFERER} !^https://www\.a3len\.store/.*$ [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [F,NC,L]
</IfModule>

# ===== منع الوصول لملفات معينة =====
<FilesMatch "^(README\.md|CHANGELOG\.txt|composer\.json|package\.json|\.gitignore|\.env|\.env\.example)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# ===== حماية ضد هجمات شائعة =====
<IfModule mod_rewrite.c>
    # حماية ضد SQL injection
    RewriteCond %{QUERY_STRING} (;|<|>|'|"|\)|%0A|%0D|%22|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{QUERY_STRING} (cmd|command|exec|execute|passthru|shell|sql) [NC,OR]
    RewriteCond %{QUERY_STRING} (base64_encode|localhost|mosconfig|\.\./) [NC,OR]
    RewriteCond %{QUERY_STRING} (GLOBALS|REQUEST|_GET|_POST|_COOKIE)(=|\[|%) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # حماية ضد User-Agent السيئة
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ===== إعدادات CORS =====
<IfModule mod_headers.c>
    # للخطوط والصور
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font\.css)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
    
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# ===== إعدادات إضافية =====
# إعدادات PHP (إذا كان المستخدم)
<IfModule mod_php.c>
    php_value upload_max_filesize 16M
    php_value post_max_size 16M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>

# تحسين لـ SVG
<IfModule mod_headers.c>
    <FilesMatch "\.svg$">
        Header set Content-Type "image/svg+xml"
    </FilesMatch>
</IfModule>
