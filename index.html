<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ===== */
.verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #10b981;
    font-size: 11px;
    padding: 2px 8px 2px 6px;
    border-radius: 12px;
    margin-right: 6px;
    vertical-align: middle;
    font-weight: 600;
    line-height: 1;
}

.verified-badge img {
    width: 14px;
    height: 14px;
    object-fit: contain;
    filter: brightness(0) saturate(100%) invert(51%) sepia(98%) saturate(348%) hue-rotate(116deg) brightness(94%) contrast(94%);
}

.user-name-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
  width: 90%;
  max-width: 500px;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ===== */
.product-status {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

.status-pending { 
  background: rgba(245, 158, 11, 0.2); 
  color: #f59e0b; 
  animation: pulse 1.5s infinite;
}
.status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.status-sold { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.status-rejected { background: rgba(239, 68, 68, 0.3); color: #ef4444; }

.admin-badge {
  background: #8b5cf6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.security-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  text-align: center;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØµÙˆØ± ===== */
.image-upload-container {
  margin: 15px 0;
}

.image-preview {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.preview-image {
  width: 180px;
  height: 180px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid #374151;
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s;
}

.preview-image:hover {
  transform: scale(1.05);
  border-color: #38bdf8;
}

.remove-image-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-size: 12px;
  cursor: pointer;
  display: none;
}

.image-preview-item {
  position: relative;
}

.image-preview-item:hover .remove-image-btn {
  display: block;
}

.file-input-label {
  display: inline-block;
  background: #1f2937;
  color: #e5e7eb;
  padding: 10px 15px;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  margin: 5px 0;
  border: 2px dashed #374151;
  transition: all 0.3s;
  width: 100%;
}

.file-input-label:hover {
  background: #374151;
  border-color: #38bdf8;
}

#images {
  display: none;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ===== */
.product-images {
  margin: 10px 0;
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  background: #1a1a1a;
}

.slider-image {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px;
}

.no-image {
  width: 100%;
  height: 180px;
  background: linear-gradient(135deg, #1f2937, #374151);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #9ca3af;
  font-size: 14px;
  text-align: center;
  padding: 20px;
}

/* ===== Progress Bar System ===== */
.top-progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: transparent;
  z-index: 9999;
  display: none;
}

.progress-bar-line {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #38bdf8, #0ea5e9);
  transition: width 0.3s;
}

.circular-progress {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  z-index: 9998;
  display: none;
}

.progress-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.95);
  z-index: 9997;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.progress-overlay.active {
  opacity: 1;
  visibility: visible;
}

.progress-overlay-content {
  text-align: center;
  color: white;
}

.progress-overlay-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid #374151;
  border-top-color: #38bdf8;
  border-radius: 50%;
  margin: 0 auto 20px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.progress-overlay-text {
  font-size: 18px;
  margin-bottom: 10px;
}

.progress-overlay-subtext {
  font-size: 14px;
  color: #9ca3af;
}

/* ===== Skeleton Loading ===== */
.skeleton-card {
  background: #1f2937;
  border-radius: 8px;
  padding: 15px;
  margin: 10px;
  animation: pulse 1.5s infinite;
}

.skeleton-line {
  background: #374151;
  border-radius: 4px;
  margin-bottom: 10px;
}

/* ===== Publish Timer ===== */
.publish-timer {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 14px;
  text-align: center;
}

.publish-timer.active {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: #10b981;
}

.timer-disabled {
  opacity: 0.6;
  cursor: not-allowed !important;
}

.timer-disabled button {
  background: #6b7280 !important;
  cursor: not-allowed !important;
}

/* ===== Ù†Ø¸Ø§Ù… Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± ===== */
.publish-timer {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 14px;
  text-align: center;
  direction: ltr;
}

.publish-timer.active {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: #10b981;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ===== */
.pending-badge {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 11px;
  font-weight: bold;
  margin-left: 5px;
  animation: pulse 1.5s infinite;
}

.waiting-approval {
  background: rgba(245, 158, 11, 0.1);
  border: 2px dashed #f59e0b;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  text-align: center;
  animation: pulse 2s infinite;
}

.waiting-approval h4 {
  color: #f59e0b;
  margin: 0 0 10px 0;
}

.waiting-approval p {
  color: #9ca3af;
  margin: 0;
  font-size: 13px;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
@media (max-width: 768px) {
    .user-name-wrapper {
        flex-wrap: wrap;
    }
    
    .verified-badge {
        font-size: 9px;
        padding: 1px 4px;
    }
    
    .verified-badge img {
        width: 10px;
        height: 10px;
    }
    
    .seller-link {
        font-size: 14px;
    }
    
    .slider-image {
        height: 150px;
    }
    
    .preview-image {
        width: 140px;
        height: 140px;
    }
    
    .details-dialog {
        width: 95%;
        padding: 15px;
    }
    
    .logo-image {
        width: 80px;
        height: 40px;
    }
}

/* ===== Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… ===== */
.topbar {
    display: flex;
    align-items: center;
    background: #0f1115;
    padding: 10px 20px;
    border-bottom: 1px solid #374151;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    height: 60px;
}

.menu-toggle {
    font-size: 24px;
    cursor: pointer;
    color: white;
    margin-left: 15px;
}

.logo {
    display: flex;
    align-items: center;
    margin-left: 20px;
}

.logo-image {
    height: 40px;
    width: auto;
    object-fit: contain;
}

.tagline {
    color: #9ca3af;
    font-size: 14px;
    margin-right: auto;
}

.overlay {
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.overlay.active {
    display: block;
}

.layout {
    display: flex;
    margin-top: 60px;
    min-height: calc(100vh - 60px);
}

.sidebar {
    width: 250px;
    background: #111827;
    padding: 20px 0;
    position: fixed;
    top: 60px;
    right: -250px;
    bottom: 0;
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
}

.sidebar.active {
    right: 0;
}

.sidebar button {
    display: block;
    width: 90%;
    margin: 10px auto;
    padding: 12px;
    background: #1f2937;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-align: right;
    font-size: 16px;
    transition: background 0.2s;
}

.sidebar button:hover {
    background: #374151;
}

main {
    flex: 1;
    padding: 20px;
    width: 100%;
}

/* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===== */
.search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-bar input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 1px solid #374151;
    background: #1f2937;
    color: white;
    border-radius: 6px;
    font-size: 16px;
}

.search-bar select {
    padding: 10px 15px;
    border: 1px solid #374151;
    background: #1f2937;
    color: white;
    border-radius: 6px;
    font-size: 16px;
    min-width: 150px;
}

.cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.card {
    background: #1f2937;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #374151;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border-color: #38bdf8;
}

.card h3 {
    margin: 10px 0;
    color: #e5e7eb;
    font-size: 18px;
}

.price {
    font-size: 20px;
    font-weight: bold;
    color: #10b981;
    display: block;
    margin: 10px 0;
}

.meta {
    display: flex;
    gap: 10px;
    margin: 10px 0;
    font-size: 14px;
    color: #9ca3af;
    flex-wrap: wrap;
}

.meta span {
    background: #374151;
    padding: 4px 8px;
    border-radius: 4px;
}

.seller {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #374151;
    color: #9ca3af;
    font-size: 14px;
}

.actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.actions button {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.actions .edit {
    background: #f59e0b;
    color: white;
}

.actions .del {
    background: #ef4444;
    color: white;
}

.empty {
    text-align: center;
    color: #9ca3af;
    font-size: 18px;
    padding: 40px;
    grid-column: 1 / -1;
}

.form-box {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: #1f2937;
    border-radius: 10px;
    border: 1px solid #374151;
}

.form-box input,
.form-box select,
.form-box textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid #374151;
    background: #111827;
    color: white;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
}

.form-box button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    background: #38bdf8;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    font-weight: bold;
}

.form-box button:hover {
    background: #0ea5e9;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">
    <img src="img/a3len.png" alt="a3len" class="logo-image">
  </div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<!-- Progress Bar System -->
<div class="top-progress-bar" id="topProgressBar">
    <div class="progress-bar-line" id="progressBarLine"></div>
</div>

<div class="circular-progress" id="circularProgress">
    <svg viewBox="0 0 36 36">
        <circle class="progress-bg" cx="18" cy="18" r="16"></circle>
        <circle class="progress-fill" cx="18" cy="18" r="16" 
                stroke-dasharray="100" stroke-dashoffset="100"></circle>
    </svg>
</div>

<div class="progress-overlay" id="progressOverlay">
    <div class="progress-overlay-content">
        <div class="progress-overlay-spinner"></div>
        <div class="progress-overlay-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="progress-overlay-subtext" id="progressSubtext">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>
</div>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ===== ØªÙ‡ÙŠØ¦Ø© Supabase =====
const supabaseUrl = 'https://dnclbdvdzvtdjpgxwnrl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuY2xiZHZkenZ0ZGpwZ3h3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjY5OTcsImV4cCI6MjA4MjgwMjk5N30.alGg61mAPLLqLM2LlQRq2K2o_eOOnJwNuaIJiAXB7Wg';

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
} else {
    firebase.app();
}

const auth = firebase.auth();
const db = firebase.database();

// ===== Progress Bar System =====
class ProgressManager {
    constructor() {
        this.topProgressBar = document.getElementById('topProgressBar');
        this.progressBarLine = document.getElementById('progressBarLine');
        this.circularProgress = document.getElementById('circularProgress');
        this.progressOverlay = document.getElementById('progressOverlay');
        this.progressText = document.getElementById('progressText');
        this.progressSubtext = document.getElementById('progressSubtext');
        
        this.currentProgress = 0;
        this.progressInterval = null;
        this.isLoading = false;
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    showTopProgressBar() {
        if (!this.topProgressBar) return;
        this.topProgressBar.style.display = 'block';
        this.progressBarLine.style.width = '0%';
        this.progressBarLine.className = 'progress-bar-line';
        
        this.currentProgress = 0;
        clearInterval(this.progressInterval);
        
        this.progressInterval = setInterval(() => {
            if (this.currentProgress < 90) {
                this.currentProgress += Math.random() * 10;
                this.updateTopProgress(this.currentProgress);
            }
        }, 200);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ
    updateTopProgress(percent) {
        if (!this.progressBarLine) return;
        this.progressBarLine.style.width = `${Math.min(percent, 100)}%`;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    hideTopProgressBar() {
        if (!this.topProgressBar) return;
        clearInterval(this.progressInterval);
        this.updateTopProgress(100);
        
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.currentProgress = 0;
        }, 300);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Overlay ÙƒØ§Ù…Ù„
    showOverlay(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', subtext = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
        if (!this.progressOverlay) return;
        this.isLoading = true;
        this.progressText.textContent = text;
        this.progressSubtext.textContent = subtext;
        this.progressOverlay.classList.add('active');
        
        document.body.style.overflow = 'hidden';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù€ Overlay
    updateOverlayText(text, subtext = null) {
        if (!this.progressText) return;
        this.progressText.textContent = text;
        if (subtext !== null && this.progressSubtext) {
            this.progressSubtext.textContent = subtext;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Overlay
    hideOverlay() {
        if (!this.progressOverlay) return;
        this.isLoading = false;
        this.progressOverlay.classList.remove('active');
        
        setTimeout(() => {
            document.body.style.overflow = '';
        }, 300);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showSuccess(message = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!') {
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø®Ø·Ø£
    showError(message = 'Ø­Ø¯Ø« Ø®Ø·Ø£!') {
        this.updateOverlayText(message, 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 2000);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Skeleton Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    createSkeletonCards(count = 6) {
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
                <div class="skeleton-card">
                    <div class="skeleton-line" style="height: 20px; width: 70%"></div>
                    <div class="skeleton-line" style="height: 16px; width: 40%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 60%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 50%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 80%"></div>
                </div>
            `;
        }
        return skeletonHTML;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Progress Manager
const progressManager = new ProgressManager();

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =====
let userUid = null;
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;
let budget = null;
let currentPage = 1;
const postsPerPage = 6;

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];

// ===== Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± =====
let canPublish = true;
let publishTimer = null;
let publishTimeLeft = 0;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± =====
let selectedImages = [];
let imagePreviewUrls = [];

// ===== Ø¯Ø§Ù„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Canvas API =====
async function compressImage(imageFile) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const img = new Image();
            
            img.onload = function() {
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚ØµÙˆÙ‰ Ù„Ù„ØµÙˆØ±Ø©
                const MAX_WIDTH = 1200;
                const MAX_HEIGHT = 1200;
                
                let width = img.width;
                let height = img.height;
                
                // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
                if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = Math.round(height * (MAX_WIDTH / width));
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = Math.round(width * (MAX_HEIGHT / height));
                            height = MAX_HEIGHT;
                        }
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¶ØºØ· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
                let quality = 0.8; // Ø¬ÙˆØ¯Ø© 80% Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ¨Ø± Ù…Ù† 2MB)ØŒ Ù†Ø®ÙØ¶ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø£ÙƒØ«Ø±
                if (imageFile.size > 2 * 1024 * 1024) {
                    quality = 0.6;
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ¨Ø± Ù…Ù† 5MB)ØŒ Ù†Ø®ÙØ¶ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø£ÙƒØ«Ø±
                if (imageFile.size > 5 * 1024 * 1024) {
                    quality = 0.4;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Canvas
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                
                // ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ø³Ù…
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Canvas
                ctx.drawImage(img, 0, 0, width, height);
                
                // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ Blob Ù…Ø¹ Ø¶ØºØ·
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        reject(new Error('ÙØ´Ù„ ÙÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©'));
                        return;
                    }
                    
                    console.log(`âœ… ØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©: ${(imageFile.size / 1024 / 1024).toFixed(2)}MB â†’ ${(blob.size / 1024 / 1024).toFixed(2)}MB`);
                    console.log(`ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶ØºØ·: ${Math.round((1 - (blob.size / imageFile.size)) * 100)}%`);
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ File Ø¬Ø¯ÙŠØ¯ Ù…Ù† Blob Ø§Ù„Ù…Ø¶ØºÙˆØ·
                    const compressedFile = new File([blob], imageFile.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    
                    resolve(compressedFile);
                }, 'image/jpeg', quality);
            };
            
            img.onerror = function() {
                reject(new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
            };
            
            img.src = event.target.result;
        };
        
        reader.onerror = function() {
            reject(new Error('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        };
        
        reader.readAsDataURL(imageFile);
    });
}

// ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª =====
class ApprovalSystem {
    static STATUS = {
        PENDING: 'pending',
        APPROVED: 'approved',
        REJECTED: 'rejected',
        EDITED_PENDING: 'edited_pending'
    };
    
    // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
    static async logApprovalAction(adminId, productId, action, reason = '') {
        try {
            const logRef = db.ref('approval_logs').push();
            await logRef.set({
                adminId: adminId,
                productId: productId,
                action: action,
                reason: reason,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            return true;
        } catch (error) {
            console.error('Error logging approval action:', error);
            return false;
        }
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    static async sendNotification(userId, title, message) {
        try {
            const notificationRef = db.ref('notifications/' + userId).push();
            await notificationRef.set({
                title: title,
                message: message,
                read: false,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            return true;
        } catch (error) {
            console.error('Error sending notification:', error);
            return false;
        }
    }
}

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± =====
class ImageManager {
    static async uploadProductImages(images) {
        const imageUrls = [];
        console.log('ğŸ“¤ Ø¨Ø¯Ø¡ Ø±ÙØ¹', images.length, 'ØµÙˆØ±Ø©');
        
        for (let i = 0; i < images.length; i++) {
            let file = images[i];
            const originalSize = file.size;
            
            // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
            console.log(`ğŸ”§ Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ${i + 1}...`);
            progressManager.updateOverlayText("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
            
            try {
                // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£ÙƒØ¨Ø± Ù…Ù† 500KB
                if (file.size > 500 * 1024) {
                    console.log(`ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠ: ${(file.size / 1024).toFixed(1)}KB`);
                    file = await compressImage(file);
                    console.log(`âœ… ØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­`);
                } else {
                    console.log(`ğŸ“¦ Ø§Ù„ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© (${(file.size / 1024).toFixed(1)}KB)ØŒ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ø¶ØºØ·`);
                }
            } catch (compressError) {
                console.error('âš ï¸ ÙØ´Ù„ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø£ØµÙ„:', compressError.message);
                // Ù†Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
            }
            
            // Ø§Ø³Ù… Ù…Ù„Ù Ø¨Ø³ÙŠØ· Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 10);
            const fileExtension = 'jpg'; // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø³ØªØ®Ø¯Ù… jpeg Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·
            const fileName = `${timestamp}_${random}.${fileExtension}`;
            
            try {
                progressManager.updateOverlayText("Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...", "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
                
                // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Supabase
                const { data, error } = await supabaseClient.storage
                    .from('ads-images')
                    .upload(`products/${fileName}`, file);
                
                if (error) {
                    console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹:', error.message);
                    continue;
                }
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·
                const { data: urlData } = await supabaseClient.storage
                    .from('ads-images')
                    .getPublicUrl(`products/${fileName}`);
                
                if (urlData?.publicUrl) {
                    imageUrls.push(urlData.publicUrl);
                    console.log(`âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹: ${(file.size / 1024).toFixed(1)}KB`);
                }
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', err.message || err);
            }
        }
        
        console.log('ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©:', imageUrls.length, 'Ù…Ù†', images.length, 'ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø©');
        return imageUrls;
    }
    
    // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Supabase
    static async deleteImage(imageUrl) {
        try {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            const urlParts = imageUrl.split('/');
            const fileName = urlParts[urlParts.length - 1];
            
            if (!fileName) {
                console.error('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:', imageUrl);
                return false;
            }
            
            const { error } = await supabaseClient.storage
                .from('ads-images')
                .remove([`products/${fileName}`]);
            
            if (error) {
                console.error('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©:', error.message);
                return false;
            }
            
            console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©: ${fileName}`);
            return true;
        } catch (err) {
            console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©:', err.message || err);
            return false;
        }
    }
    
    static createImageDisplay(images) {
        if (!images || images.length === 0) {
            return '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·
        return `
            <div class="product-images">
                <img src="${images[0]}" class="slider-image" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" 
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/300x180/1f2937/9ca3af?text=Ù„Ø§+ØªÙˆØ¬Ø¯+ØµÙˆØ±Ø©'">
            </div>
        `;
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± =====
function handleImageSelect(event) {
    const files = Array.from(event.target.files);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± - ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    if (files.length > 1) {
        alert("ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰");
        event.target.value = '';
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
    const invalidFiles = files.filter(file => !validTypes.includes(file.type));
    
    if (invalidFiles.length > 0) {
        alert("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù†ÙˆØ¹ ØµÙˆØ±Ø© (JPEG, PNG, WebP)");
        event.target.value = '';
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 15MB)
    const maxSize = 15 * 1024 * 1024; // 15MB
    const oversizedFiles = files.filter(file => file.size > maxSize);
    
    if (oversizedFiles.length > 0) {
        alert("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 15MB");
        event.target.value = '';
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© - ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    selectedImages = files.slice(0, 1);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    displayImagePreview();
}

function displayImagePreview() {
    const previewContainer = document.getElementById('imagePreview');
    if (!previewContainer) return;
    
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    imagePreviewUrls = [];
    previewContainer.innerHTML = '';
    
    if (selectedImages.length === 0) {
        previewContainer.innerHTML = '<div style="color:#9ca3af; text-align:center; padding:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±</div>';
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const url = e.target.result;
            imagePreviewUrls.push(url);
            
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${url}" class="preview-image" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
                <div style="text-align:center; margin-top:5px; font-size:11px; color:#9ca3af;">
                    ${(file.size / 1024).toFixed(1)}KB
                </div>
                <button class="remove-image-btn" onclick="removeImage(${index})">Ã—</button>
            `;
            
            previewContainer.appendChild(previewItem);
        };
        
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    imagePreviewUrls.splice(index, 1);
    displayImagePreview();
    
    // ØªØ­Ø¯ÙŠØ« input file
    const imageInput = document.getElementById('images');
    if (imageInput) {
        imageInput.value = '';
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø© =====
function toggleSidebar() {
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.querySelector(".overlay");
    
    if (sidebar && overlay) {
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
        document.body.style.overflow = sidebar.classList.contains("active") ? "hidden" : "";
    }
}

function closeSidebar() {
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.querySelector(".overlay");
    
    if (sidebar && overlay) {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
        document.body.style.overflow = "";
    }
}

function showHome() {
    closeSidebar();
    progressManager.showTopProgressBar();
    
    setTimeout(() => {
        const content = document.getElementById("content");
        if (!content) return;
        
        content.innerHTML = `
            <div class="search-bar">
                <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
                <select id="cat" onchange="loadProducts()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                    ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
                </select>
                <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
            </div>
            <div class="cards" id="products"></div>
            <div id="pagination" style="text-align:center; margin:20px"></div>
        `;
        
        loadProducts();
        progressManager.hideTopProgressBar();
    }, 300);
}

function showBudgetDialog() { 
    const dialog = document.getElementById("budgetDialog");
    if (dialog) {
        dialog.style.display = "block";
        document.body.style.overflow = "hidden";
    }
}

function closeBudget() { 
    const dialog = document.getElementById("budgetDialog");
    if (dialog) {
        dialog.style.display = "none";
        document.body.style.overflow = "";
    }
}

function applyBudget() {
    const input = document.getElementById("maxBudget");
    if (!input) return;
    
    const val = parseFloat(input.value);
    
    if (isNaN(val) || val < 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");
        return;
    }
    
    if (val > 10000000) {
        alert("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");
        return;
    }
    
    budget = val;
    closeBudget();
    loadProducts();
}

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª =====
function loadProducts() {
    const searchInput = document.getElementById("search");
    const catSelect = document.getElementById("cat");
    
    const s = searchInput ? searchInput.value.toLowerCase() : '';
    const c = catSelect ? catSelect.value : '';
    
    // Ø¹Ø±Ø¶ Skeleton Loading
    const productsContainer = document.getElementById('products');
    if (productsContainer) {
        productsContainer.innerHTML = progressManager.createSkeletonCards(6);
    }
    
    progressManager.showTopProgressBar();
    
    db.ref("products").once("value", snap => {
        const d = snap.val() || {};
        let htmlCards = [];

        Object.keys(d).forEach(k => {
            const p = d[k];
            
            if (!p || !p.name || !p.price) {
                return;
            }
            
            const price = parseFloat(p.price) || 0;
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            let showPost = false;
            
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
            const status = p.status || ApprovalSystem.STATUS.PENDING;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹
            if (userUid) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙŠØ±Ù‰ ÙƒÙ„ Ø´ÙŠØ¡
                if (isAdmin) {
                    showPost = true;
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙŠØ±Ù‰ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙ‡ Ø¨Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§ØªÙ‡Ø§
                else if (p.uid === userUid) {
                    showPost = true;
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ØªÙ…Ø¯Ø§Ù‹ØŒ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹
                else if (status === ApprovalSystem.STATUS.APPROVED) {
                    showPost = true;
                }
            }
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ ÙŠØ±Ù‰ ÙÙ‚Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
            else if (status === ApprovalSystem.STATUS.APPROVED) {
                showPost = true;
            }
            
            if (!showPost) return;
            
            if ((!c || p.category === c) && p.name.toLowerCase().includes(s)) {
                if (budget && price > budget) return;
                
                // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† ÙˆØ´ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
                let statusBadge = '';
                let statusClass = '';
                let statusText = '';
                
                // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙØ¹Ù„ÙŠØ© (status2) Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¹ØªÙ…Ø¯Ø©
                if (status === ApprovalSystem.STATUS.APPROVED) {
                    const actualStatus = p.status2 || 'available';
                    
                    switch(actualStatus) {
                        case 'available':
                            statusClass = 'status-available';
                            statusText = 'âœ… Ù…ØªØ§Ø­';
                            break;
                        case 'sold':
                            statusClass = 'status-sold';
                            statusText = 'âœ… Ù…Ø¨Ø§Ø¹';
                            break;
                        case 'reserved':
                            statusClass = 'status-reserved';
                            statusText = 'âœ… Ù…Ø­Ø¬ÙˆØ²';
                            break;
                        default:
                            statusClass = 'status-available';
                            statusText = 'âœ… Ù…ØªØ§Ø­';
                    }
                } else {
                    // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
                    switch(status) {
                        case ApprovalSystem.STATUS.PENDING:
                            statusClass = 'status-pending';
                            statusText = 'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                            break;
                        case ApprovalSystem.STATUS.EDITED_PENDING:
                            statusClass = 'status-pending';
                            statusText = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                            break;
                        case ApprovalSystem.STATUS.REJECTED:
                            statusClass = 'status-rejected';
                            statusText = 'âŒ Ù…Ø±ÙÙˆØ¶';
                            break;
                        default:
                            statusClass = 'status-available';
                            statusText = 'âœ… Ù…ØªØ§Ø­';
                    }
                }
                
                // Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£ØµÙØ± Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                const pendingBar = (status === ApprovalSystem.STATUS.PENDING || status === ApprovalSystem.STATUS.EDITED_PENDING) ? 
                    `<div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 8px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-size: 13px; font-weight: bold; animation: pulse 2s infinite;">
                        â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                    </div>` : '';
                
                statusBadge = `<div class="product-status ${statusClass}">${statusText}</div>`;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹
                let isVerified = false;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹
                if (p.uid) {
                    db.ref('users/' + p.uid).once('value', (userSnap) => {
                        const userData = userSnap.val();
                        if (userData) {
                            isVerified = userData.isVerified || false;
                        }
                    });
                }
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                const imagesHTML = p.images && p.images.length > 0 
                    ? ImageManager.createImageDisplay(p.images)
                    : '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
                
                const sellerSection = userDisplayName ? 
                    `<div class="seller">
                        ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">
                            <span class="user-name-wrapper">
                                ${isVerified ? '<span class="verified-badge"><img src="img/verify.png" alt="âœ“"> Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                                ${p.seller}
                            </span>
                        </span> 
                        | â˜ ${p.phone}
                    </div>` :
                    `<div class="seller">
                        ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
                    </div>`;
                
                htmlCards.push({
                    uid: p.uid,
                    key: k,
                    html: `
                        <div class="card" onclick="showDetails('${k}')">
                            ${pendingBar}
                            ${imagesHTML}
                            <h3>${escapeHTML(p.name)}</h3>
                            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
                            ${statusBadge}
                            <div class="meta">
                                <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
                            </div>
                            ${sellerSection}
                            <div class="actions">
                                ${(p.uid === userUid || isAdmin) ? `
                                <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
                            </div>
                        </div>
                    `
                });
            }
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        if (userUid) {
            htmlCards = htmlCards.sort((a, b) => {
                if (a.uid === userUid && b.uid !== userUid) return -1;
                if (a.uid !== userUid && b.uid === userUid) return 1;
                return 0;
            });
        }

        const totalPages = Math.ceil(htmlCards.length / postsPerPage);
        if (currentPage > totalPages) currentPage = 1;
        const start = (currentPage - 1) * postsPerPage;
        const pageItems = htmlCards.slice(start, start + postsPerPage);

        let finalHTML = pageItems.map(p => p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
        
        if (productsContainer) {
            productsContainer.style.opacity = '0';
            setTimeout(() => {
                productsContainer.innerHTML = finalHTML;
                productsContainer.style.opacity = '1';
                renderPagination(totalPages);
                progressManager.hideTopProgressBar();
            }, 300);
        }
    }).catch(error => {
        console.error("Error loading products:", error);
        if (productsContainer) {
            productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
        }
        progressManager.hideTopProgressBar();
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
    });
}

function renderPagination(total) {
    let html = "";
    for (let i = 1; i <= total; i++) {
        html += `
            <button onclick="goPage(${i})"
                style="
                    margin: 3px;
                    padding: 6px 10px;
                    border-radius: 5px;
                    border: none;
                    cursor: pointer;
                    background: ${i === currentPage ? '#38bdf8' : '#1f2937'};
                    color: ${i === currentPage ? '#000' : '#fff'};
                    font-weight: ${i === currentPage ? 'bold' : 'normal'};
                ">
                ${i}
            </button>`;
    }
    
    const pagination = document.getElementById('pagination');
    if (pagination) {
        pagination.innerHTML = html;
    }
}

function goPage(p) {
    currentPage = p;
    loadProducts();
}

// ===== Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© =====
async function deleteProduct(k) { 
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
        return;
    }
    
    progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
    
    db.ref("products/" + k).once('value', async (snapshot) => {
        const product = snapshot.val();
        if (!product) {
            progressManager.hideOverlay();
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            return;
        }
        
        if (product.uid !== userUid && !isAdmin) {
            progressManager.hideOverlay();
            alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
            return;
        }
        
        // Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ù…Ù† Supabase
        if (product.images && product.images.length > 0) {
            for (let imageUrl of product.images) {
                await ImageManager.deleteImage(imageUrl);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (product.uid) {
            db.ref('users/' + product.uid).once('value', (userSnapshot) => {
                const userData = userSnapshot.val();
                if (userData) {
                    const currentCount = userData.totalProducts || 0;
                    if (currentCount > 0) {
                        db.ref('users/' + product.uid).update({
                            totalProducts: currentCount - 1
                        });
                    }
                }
            });
        }
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Firebase
        db.ref("products/" + k).remove().then(() => {
            progressManager.showSuccess("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
            loadProducts();
        }).catch(error => {
            console.error("Delete error:", error);
            progressManager.hideOverlay();
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
        });
    });
}

function editProduct(k) { 
    progressManager.showTopProgressBar();
    
    db.ref("products/" + k).once("value", s => {
        const product = s.val();
        if (!product) {
            progressManager.hideTopProgressBar();
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            return;
        }
        
        if (product.uid !== userUid && !isAdmin) {
            progressManager.hideTopProgressBar();
            alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
            return;
        }
        
        showPublish(product, k);
        progressManager.hideTopProgressBar();
    });
}

// ===== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø± =====
async function showPublish(p = null, k = null) {
    closeSidebar();
    
    progressManager.showTopProgressBar();
    
    setTimeout(async () => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± (Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·)
        let canPublishNow = true;
        if (!k) {
            canPublishNow = await checkPublishPermission();
        }
        
        const sellerName = userDisplayName || (p ? p.seller : "");
        const sellerField = userDisplayName ? 
            `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
             <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
            `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" maxlength="30">`;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        selectedImages = [];
        imagePreviewUrls = [];
        
        const content = document.getElementById("content");
        if (!content) return;
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ
        const currentStatus = p ? (p.status || ApprovalSystem.STATUS.PENDING) : ApprovalSystem.STATUS.PENDING;
        let statusMessage = '';
        
        if (currentStatus === ApprovalSystem.STATUS.PENDING) {
            statusMessage = `
                <div class="waiting-approval">
                    <h4>â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
                    <p>Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡</p>
                </div>
            `;
        } else if (currentStatus === ApprovalSystem.STATUS.EDITED_PENDING) {
            statusMessage = `
                <div class="waiting-approval">
                    <h4>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h4>
                    <p>ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡Ø§</p>
                </div>
            `;
        } else if (currentStatus === ApprovalSystem.STATUS.REJECTED) {
            statusMessage = `
                <div class="security-warning">
                    <h4>âŒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø±ÙÙˆØ¶</h4>
                    <p>ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                </div>
            `;
        }
        
        content.innerHTML = `
            <div class="form-box">
                <h2>${p ? "ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†" : "Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
                
                ${statusMessage}
                
                ${!p && !canPublishNow ? `<div id="publishTimer"></div>` : ''}
                
                ${p ? '' : '<small style="color:#9ca3af; margin-bottom:15px; display:block;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ ÙƒÙ„ Ø³Ø§Ø¹Ø©</small>'}
                
                <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p ? escapeHTML(p.name) : ""}" maxlength="50" required>
                <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p ? p.price : ""}" min="0" max="10000000" required>
                <select id="category">${categories.map(c => `<option value="${c}" ${p && p.category === c ? "selected" : ""}>${c}</option>`).join("")}</select>
                ${sellerField}
                <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p ? p.phone : ""}" pattern="[0][0-9]{10}" required>
                <small style="color:#9ca3af; font-size:12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…</small>
                <select id="province">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                    ${provinces.map(pr => `<option value="${pr}" ${p && p.province === pr ? "selected" : ""}>${pr}</option>`).join("")}
                </select>
                <select id="delivery">
                    <option value="Ù†Ø¹Ù…" ${p && p.delivery === "Ù†Ø¹Ù…" ? "selected" : ""}>Ù†Ø¹Ù…</option>
                    <option value="Ù„Ø§" ${p && p.delivery === "Ù„Ø§" ? "selected" : ""}>Ù„Ø§</option>
                </select>
                
                <!-- Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„Ø­Ø§Ù„Ø© (Ù…ØªØ§Ø­/Ù…Ø¨Ø§Ø¹/Ù…Ø­Ø¬ÙˆØ²) -->
                <select id="status" ${isAdmin || (p && p.uid === userUid) ? '' : 'disabled'}>
                    <option value="available" ${(p && (p.status2 === "available" || (!p.status2 && p.status === "approved"))) ? "selected" : ""}>Ù…ØªØ§Ø­</option>
                    <option value="sold" ${p && p.status2 === "sold" ? "selected" : ""}>Ù…Ø¨Ø§Ø¹</option>
                    <option value="reserved" ${p && p.status2 === "reserved" ? "selected" : ""}>Ù…Ø­Ø¬ÙˆØ²</option>
                </select>
                <small style="color:#9ca3af; font-size:12px;">${isAdmin ? 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†' : 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±'}</small>
                
                <!-- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± - ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· -->
                <div class="image-upload-container">
                    <label class="file-input-label">
                        ğŸ“· Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
                        <input type="file" id="images" accept="image/*" onchange="handleImageSelect(event)">
                    </label>
                    <small style="color:#9ca3af; font-size:12px; display:block; margin-top:5px;">
                        ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (JPEG, PNG, WebP) - Ø³ÙŠØªÙ… Ø¶ØºØ·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    </small>
                    <div class="image-preview" id="imagePreview">
                        ${p && p.images && p.images.length > 0 ? 
                            p.images.slice(0, 1).map((img, idx) => `
                                <div class="image-preview-item">
                                    <img src="${img}" class="preview-image" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
                                    <small style="display:block; text-align:center; color:#9ca3af;">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                                </div>
                            `).join('') : 
                            '<div style="color:#9ca3af; text-align:center; padding:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±</div>'
                        }
                    </div>
                </div>

                <button onclick="saveProduct('${k || ""}')" id="saveBtn" ${!p && !canPublishNow ? 'disabled class="timer-disabled"' : ''}>
                    ğŸ’¾ ${p ? "ØªØ­Ø¯ÙŠØ«" : "Ù†Ø´Ø±"}
                </button>
                
                ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
            </div>`;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…ØªØ§Ø­
            if (!p && !canPublishNow) {
                updatePublishTimerDisplay();
            }
            
            progressManager.hideTopProgressBar();
    }, 300);
}

// ===== Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© =====
async function saveProduct(k) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
    if (!k) {
        const canPublishNow = await checkPublishPermission();
        if (!canPublishNow) {
            alert("ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯");
            return;
        }
    }
    
    const name = document.getElementById("name")?.value.trim();
    const price = document.getElementById("price")?.value.trim();
    const phone = document.getElementById("phone")?.value.trim();
    const province = document.getElementById("province")?.value;
    const status = document.getElementById("status")?.value || "available";
    
    if (!name || !price || !phone || !province) {
        alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
    }
    
    if (name.length < 3 || name.length > 50) {
        alert("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
        return;
    }
    
    const priceNum = parseFloat(price);
    if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
        alert("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
        return;
    }
    
    if (!/^[0][0-9]{10}$/.test(phone)) {
        alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
        return;
    }
    
    if (!province) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
        return;
    }

    const seller = userDisplayName || document.getElementById("seller")?.value.trim();
    
    if (!seller || seller.length < 2) {
        alert("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
        return;
    }

    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    saveBtn.disabled = true;
    
    progressManager.showOverlay(k ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..." : "Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
    
    try {
        let imageUrls = [];
        let oldImages = [];
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„Ø§Ù‹ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (k) {
            const productRef = db.ref("products/" + k);
            const snapshot = await productRef.once("value");
            const existingProduct = snapshot.val();
            if (existingProduct && existingProduct.images && existingProduct.images.length > 0) {
                imageUrls = [existingProduct.images[0]];
                oldImages = [existingProduct.images[0]];
            }
        }
        
        // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (selectedImages.length > 0) {
            progressManager.updateOverlayText("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...", "Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
            
            // Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (oldImages.length > 0) {
                for (let oldImage of oldImages) {
                    await ImageManager.deleteImage(oldImage);
                }
            }
            
            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø³ÙŠØªÙ… Ø¶ØºØ·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ uploadProductImages)
            const uploadedUrls = await ImageManager.uploadProductImages(selectedImages.slice(0, 1));
            
            if (uploadedUrls.length > 0) {
                imageUrls = [uploadedUrls[0]];
            }
        }
        
        // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
        const data = {
            name: name,
            price: priceNum,
            category: document.getElementById("category").value,
            seller: seller,
            phone: phone,
            province: province,
            delivery: document.getElementById("delivery").value,
            status2: status,
            uid: userUid,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
        };
        
        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ø§Ù‹
        if (!k) {
            // Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯: Ø­Ø§Ù„Ø© Ù…Ø¹Ù„Ù‚Ø©
            data.status = ApprovalSystem.STATUS.PENDING;
            data.createdAt = firebase.database.ServerValue.TIMESTAMP;
            data.timestamp = firebase.database.ServerValue.TIMESTAMP;
        } else {
            // ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯
            const productRef = db.ref("products/" + k);
            const snapshot = await productRef.once("value");
            const existingProduct = snapshot.val();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ØªÙ…Ø¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ÙŠØµØ¨Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„Ù‚Ø§Ù‹
            if (existingProduct && existingProduct.status === ApprovalSystem.STATUS.APPROVED) {
                data.status = ApprovalSystem.STATUS.EDITED_PENDING;
                data.originalData = {
                    name: existingProduct.name,
                    price: existingProduct.price,
                    category: existingProduct.category,
                    seller: existingProduct.seller,
                    phone: existingProduct.phone,
                    province: existingProduct.province,
                    delivery: existingProduct.delivery,
                    status2: existingProduct.status2 || "available",
                    images: existingProduct.images || []
                };
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ù„Ù‚Ø§Ù‹ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ ÙŠØ¨Ù‚Ù‰ Ù…Ø¹Ù„Ù‚Ø§Ù‹
                data.status = existingProduct?.status || ApprovalSystem.STATUS.PENDING;
            }
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (imageUrls.length > 0) {
            data.images = imageUrls;
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Firebase
        const ref = k ? db.ref("products/" + k) : db.ref("products").push();
        await ref.set(data);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
        if (!k && userUid) {
            // Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ±
            saveLastPublishTime();
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            db.ref('users/' + userUid).once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    const currentCount = userData.totalProducts || 0;
                    db.ref('users/' + userUid).update({
                        totalProducts: currentCount + 1,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    db.ref('users/' + userUid).update({
                        totalProducts: 1,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
        if (userUid && isAdmin) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù‡Ùˆ Ù…Ù† ÙŠÙ†Ø´Ø±ØŒ ÙŠØ¹ØªÙ…Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©
            db.ref("products/" + ref.key).update({
                status: ApprovalSystem.STATUS.APPROVED,
                approvedAt: firebase.database.ServerValue.TIMESTAMP,
                approvedBy: userUid
            });
            
            progressManager.showSuccess("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹");
        } else {
            progressManager.showSuccess(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©");
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        selectedImages = [];
        imagePreviewUrls = [];
        
        setTimeout(() => {
            showHome();
        }, 1000);
        
    } catch (error) {
        console.error("Error saving product:", error);
        progressManager.hideOverlay();
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// ===== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ =====
function showDetails(k) {
    progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", "Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹");
    
    db.ref("products/" + k).once("value", snap => {
        const p = snap.val();
        if (!p) {
            progressManager.hideOverlay();
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹
        let isVerified = false;
        if (p.uid) {
            db.ref('users/' + p.uid).once('value', (userSnap) => {
                const userData = userSnap.val();
                if (userData) {
                    isVerified = userData.isVerified || false;
                }
            });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        const imagesHTML = p.images && p.images.length > 0 
            ? ImageManager.createImageDisplay(p.images)
            : '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
        
        const sellerWithLink = userDisplayName ? 
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">
                <span class="user-name-wrapper">
                    ${isVerified ? '<span class="verified-badge"><img src="img/verify.png" alt="âœ“"> Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                    ${p.seller}
                </span>
            </span></p>` :
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> 
                <span class="user-name-wrapper">
                    ${isVerified ? '<span class="verified-badge"><img src="img/verify.png" alt="âœ“"> Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                    ${p.seller}
                </span>
            </p>`;
        
        const approvalStatus = p.status || ApprovalSystem.STATUS.PENDING;
        let approvalStatusText = '';
        
        switch(approvalStatus) {
            case ApprovalSystem.STATUS.PENDING:
                approvalStatusText = 'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                break;
            case ApprovalSystem.STATUS.EDITED_PENDING:
                approvalStatusText = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©';
                break;
            case ApprovalSystem.STATUS.APPROVED:
                approvalStatusText = 'âœ… Ù…Ø¹ØªÙ…Ø¯';
                break;
            case ApprovalSystem.STATUS.REJECTED:
                approvalStatusText = 'âŒ Ù…Ø±ÙÙˆØ¶';
                break;
            default:
                approvalStatusText = 'âœ… Ù…Ø¹ØªÙ…Ø¯';
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬
        const actualStatus = p.status2 || 'available';
        let actualStatusText = '';
        let actualStatusColor = '#10b981';
        
        switch(actualStatus) {
            case 'available':
                actualStatusText = 'Ù…ØªØ§Ø­';
                actualStatusColor = '#10b981';
                break;
            case 'sold':
                actualStatusText = 'Ù…Ø¨Ø§Ø¹';
                actualStatusColor = '#38bdf8';
                break;
            case 'reserved':
                actualStatusText = 'Ù…Ø­Ø¬ÙˆØ²';
                actualStatusColor = '#f59e0b';
                break;
            default:
                actualStatusText = 'Ù…ØªØ§Ø­';
                actualStatusColor = '#10b981';
        }
        
        const detailsContent = document.getElementById("detailsContent");
        if (detailsContent) {
            detailsContent.innerHTML = `
                <h2>${escapeHTML(p.name)}</h2>
                ${imagesHTML}
                <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©:</strong> <span style="font-weight:bold; color:${approvalStatus === ApprovalSystem.STATUS.PENDING || approvalStatus === ApprovalSystem.STATUS.EDITED_PENDING ? '#f59e0b' : approvalStatus === ApprovalSystem.STATUS.REJECTED ? '#ef4444' : '#10b981'}">${approvalStatusText}</span></p>
                <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬:</strong> <span style="font-weight:bold; color:${actualStatusColor}">${actualStatusText}</span></p>
                <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
                <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                ${sellerWithLink}
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
                <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
                ${p.uid === userUid ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
            `;
        }
        
        const dialog = document.getElementById("detailsDialog");
        if (dialog) {
            dialog.style.display = "block";
        }
        
        progressManager.hideOverlay();
    }).catch(error => {
        console.error("Error loading details:", error);
        progressManager.hideOverlay();
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
    });
}

function closeDetails() {
    const dialog = document.getElementById("detailsDialog");
    if (dialog) {
        dialog.style.display = "none";
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
    const authSection = document.getElementById("authSection");
    
    if (!authSection) return;
    
    if (currentUser && userDisplayName) {
        db.ref("users/" + currentUser.uid).once("value", snapshot => {
            const userData = snapshot.val();
            const displayName = userData ? (userData.fullName || userDisplayName) : userDisplayName;
            
            isAdmin = userData && userData.isAdmin === true;
            const isVerified = userData && userData.isVerified === true;
            
            authSection.innerHTML = `
                <div class="user-info">
                    <p class="profile-link" onclick="viewMyProfile()">
                        <span class="user-name-wrapper">
                            ${isVerified ? '<span class="verified-badge"><img src="img/verify.png" alt="âœ“"></span>' : ''}
                            ${displayName}
                            ${isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
                        </span>
                    </p>
                    <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
                    <small style="color:#9ca3af; font-size:11px; display:block; margin:5px 0;">${userData ? userData.totalProducts || 0 : 0} Ø¥Ø¹Ù„Ø§Ù†</small>
                    <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            `;
        });
    } else {
        authSection.innerHTML = `
            <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        `;
    }
}

function logoutUser() {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...", "Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹");
        
        auth.signOut()
            .then(() => {
                currentUser = null;
                userDisplayName = null;
                userFullName = null;
                isAdmin = false;
                userUid = null;
                updateAuthUI();
                showHome();
                progressManager.showSuccess("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
            })
            .catch((error) => {
                console.error("Logout error:", error);
                progressManager.hideOverlay();
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
            });
    }
}

function viewProfile(userId, sellerName) {
    if (sellerName) {
        localStorage.setItem('profileSellerName', sellerName);
    }
    
    progressManager.showTopProgressBar();
    setTimeout(() => {
        window.location.href = `profile.html?id=${userId}`;
    }, 300);
}

function viewMyProfile() {
    if (currentUser && currentUser.uid) {
        progressManager.showTopProgressBar();
        setTimeout(() => {
            window.location.href = `profile.html?id=${currentUser.uid}`;
        }, 300);
    } else {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1500);
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± =====
async function checkPublishPermission() {
    if (!userUid) {
        canPublish = true;
        return true;
    }
    
    return new Promise((resolve) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase
        db.ref('users/' + userUid + '/lastPublish').once('value', (userSnap) => {
            const lastPublish = userSnap.val();
            if (!lastPublish) {
                canPublish = true;
                resolve(true);
                return;
            }
            
            const timeDiff = Date.now() - lastPublish;
            const oneHour = 60 * 60 * 1000;
            
            if (timeDiff < oneHour) {
                canPublish = false;
                publishTimeLeft = Math.ceil((oneHour - timeDiff) / 1000);
                startPublishTimer();
                resolve(false);
            } else {
                canPublish = true;
                resolve(true);
            }
        }).catch((error) => {
            console.error("Error checking publish permission:", error);
            canPublish = true;
            resolve(true);
        });
    });
}

function startPublishTimer() {
    if (publishTimer) {
        clearInterval(publishTimer);
    }
    
    updatePublishTimerDisplay();
    
    publishTimer = setInterval(() => {
        if (publishTimeLeft > 0) {
            publishTimeLeft--;
            updatePublishTimerDisplay();
            
            if (publishTimeLeft <= 0) {
                clearInterval(publishTimer);
                canPublish = true;
                updatePublishTimerDisplay();
                
                if (document.getElementById('publishTimer')) {
                    const timerElement = document.getElementById('publishTimer');
                    timerElement.innerHTML = `
                        <div class="publish-timer active">
                            âœ“ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                            <br><small style="color:#9ca3af;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</small>
                        </div>
                    `;
                    
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('timer-disabled');
                        saveBtn.innerHTML = 'ğŸ’¾ Ù†Ø´Ø±';
                    }
                }
            }
        }
    }, 1000);
}

function updatePublishTimerDisplay() {
    const minutes = Math.floor(publishTimeLeft / 60);
    const seconds = publishTimeLeft % 60;
    
    const timerElement = document.getElementById('publishTimer');
    if (timerElement) {
        timerElement.innerHTML = `
            <div class="publish-timer">
                â° ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} 
                Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                <br><small style="color:#9ca3af;">Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±</small>
            </div>
        `;
    }
}

function saveLastPublishTime() {
    if (!userUid) return;
    
    db.ref('users/' + userUid).update({
        lastPublish: Date.now()
    }).then(() => {
        console.log("Publish time saved to Firebase");
    }).catch((error) => {
        console.error("Error saving publish time:", error);
    });
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPrice(price) {
    return parseInt(price).toLocaleString('ar-SA');
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        userUid = user.uid;
        
        db.ref("users/" + user.uid).once("value", snapshot => {
            const userData = snapshot.val();
            if (userData) {
                userDisplayName = userData.username;
                userFullName = userData.fullName;
                isAdmin = userData.isAdmin === true;
                updateAuthUI();
                
                db.ref("users/" + user.uid).update({
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
    } else {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        userUid = null;
        updateAuthUI();
    }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
    showHome();
    updateAuthUI();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ ESC Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSidebar();
            closeBudget();
            closeDetails();
        }
    });
});
</script>
</body>
</html>
