<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ===== */
.verified-badge {
  background: #10b981;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.product-status {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

.status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.status-sold { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

.admin-badge {
  background: #8b5cf6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.security-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  text-align: center;
}

.session-timeout {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(245, 158, 11, 0.9);
  color: #000;
  padding: 10px 15px;
  border-radius: 6px;
  z-index: 2000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ===== */
.phone-reveal {
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-block;
  color: #38bdf8;
  text-decoration: underline dotted;
}
.phone-reveal:hover {
  color: #0ea5e9;
  text-decoration: underline;
}
.phone-reveal::after {
  content: "ğŸ”“ Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†";
  position: absolute;
  bottom: -25px;
  right: 0;
  background: rgba(56, 189, 248, 0.1);
  color: #38bdf8;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  z-index: 100;
}
.phone-reveal:hover::after {
  opacity: 1;
}
.phone-unlocked {
  color: #10b981 !important;
  cursor: default;
  text-decoration: none !important;
}
.phone-unlocked:hover {
  color: #10b981 !important;
}
.phone-unlocked::after {
  content: "âœ… ØªÙ… ÙƒØ´Ù Ø§Ù„Ø±Ù‚Ù…" !important;
  background: rgba(16, 185, 129, 0.1) !important;
  color: #10b981 !important;
}

/* ===== Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ===== */
.ad-confirm-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #0f1115;
  color: #e5e7eb;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  z-index: 2000;
  display: none;
  width: 90%;
  max-width: 400px;
  text-align: center;
  border: 1px solid #374151;
}
.ad-confirm-dialog h3 {
  margin-top: 0;
  color: #38bdf8;
  margin-bottom: 15px;
}
.ad-confirm-dialog p {
  margin-bottom: 20px;
  color: #9ca3af;
  font-size: 14px;
  line-height: 1.5;
}
.ad-confirm-dialog-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}
.ad-confirm-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
  min-width: 120px;
}
.ad-confirm-btn.primary {
  background: #10b981;
  color: white;
}
.ad-confirm-btn.primary:hover {
  background: #0da271;
}
.ad-confirm-btn.secondary {
  background: #6b7280;
  color: white;
}
.ad-confirm-btn.secondary:hover {
  background: #4b5563;
}
.ad-confirm-countdown {
  font-size: 24px;
  font-weight: bold;
  color: #38bdf8;
  margin: 15px 0;
}

/* ===== Ù†Ø§ÙØ°Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ===== */
.ad-watch-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #0f1115;
  color: #e5e7eb;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  z-index: 2001;
  display: none;
  width: 90%;
  max-width: 500px;
  text-align: center;
  border: 1px solid #374151;
}
.ad-watch-dialog h3 {
  margin-top: 0;
  color: #f59e0b;
  margin-bottom: 15px;
}
.ad-watch-timer {
  font-size: 32px;
  font-weight: bold;
  color: #f59e0b;
  margin: 20px 0;
  padding: 15px;
  background: rgba(245, 158, 11, 0.1);
  border-radius: 10px;
  border: 2px solid #f59e0b;
}
.ad-watch-message {
  color: #9ca3af;
  font-size: 14px;
  margin: 15px 0;
}
.ad-watch-loader {
  width: 50px;
  height: 50px;
  border: 5px solid #374151;
  border-top: 5px solid #38bdf8;
  border-radius: 50%;
  margin: 20px auto;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== Ø¥Ø·Ø§Ø± Ø¥Ø¹Ù„Ø§Ù† RichAds ===== */
.richads-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.98);
  z-index: 9999;
  display: none;
}
.richads-frame {
  width: 95%;
  height: 85%;
  max-width: 1100px;
  max-height: 750px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border: 2px solid #38bdf8;
  border-radius: 12px;
  box-shadow: 0 0 40px rgba(56, 189, 248, 0.4);
  background: #000;
}
.richads-header {
  position: absolute;
  top: -50px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 10px;
}
.richads-timer {
  background: #38bdf8;
  color: #000;
  padding: 8px 20px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 18px;
  font-family: monospace;
}
.richads-close {
  background: #ef4444;
  color: white;
  border: none;
  padding: 10px 25px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.3s;
}
.richads-close:hover {
  background: #dc2626;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<!-- Progress Bar System -->
<div class="top-progress-bar" id="topProgressBar">
    <div class="progress-bar-line" id="progressBarLine"></div>
</div>

<div class="circular-progress" id="circularProgress">
    <svg viewBox="0 0 36 36">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#38bdf8" />
                <stop offset="100%" stop-color="#0ea5e9" />
            </linearGradient>
        </defs>
        <circle class="progress-bg" cx="18" cy="18" r="16"></circle>
        <circle class="progress-fill" cx="18" cy="18" r="16" 
                stroke-dasharray="100" stroke-dashoffset="100"></circle>
</svg>
</div>

<div class="progress-overlay" id="progressOverlay">
    <div class="progress-overlay-content">
        <div class="progress-overlay-spinner"></div>
        <div class="progress-overlay-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="progress-overlay-subtext" id="progressSubtext">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
<div class="ad-confirm-dialog" id="adConfirmDialog">
  <h3>ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</h3>
  <p>Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„.</p>
  <div class="ad-confirm-countdown" id="adCountdown">5</div>
  <p>Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŒ Ø³ÙŠØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙƒØ§Ù…Ù„Ø§Ù‹.</p>
  <div class="ad-confirm-dialog-buttons">
    <button class="ad-confirm-btn secondary" onclick="skipAd()">ØªØ®Ø·ÙŠ</button>
    <button class="ad-confirm-btn primary" onclick="watchAd()" id="watchAdBtn" disabled>Ù…Ø´Ø§Ù‡Ø¯Ø© (5)</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† -->
<div class="ad-watch-dialog" id="adWatchDialog">
  <h3>ğŸ”” Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
  <div class="ad-watch-timer" id="adWatchTimer">30</div>
  <div class="ad-watch-loader"></div>
  <p class="ad-watch-message">ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª</p>
  <p style="color:#9ca3af; font-size:12px;">Ø³ÙŠØªÙ… ÙƒØ´Ù Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</p>
  <div id="adStatus" style="color:#38bdf8; font-size:12px; margin-top:10px;"></div>
</div>

<!-- Ø¥Ø¹Ù„Ø§Ù† RichAds -->
<div class="richads-container" id="richadsContainer">
  <div class="richads-header">
    <div class="richads-timer" id="richadsTimer">30</div>
    <button class="richads-close" onclick="closeRichAds()">âœ• Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
  </div>
  <iframe class="richads-frame" id="richadsFrame"
          sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
          allow="autoplay; fullscreen"
          allowfullscreen>
  </iframe>
</div>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Session Timeout Warning -->
<div class="session-timeout" id="sessionTimeout">
  <span id="timeoutMessage">Ø³ØªÙ†ØªÙ‡ÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„ Ø®Ù„Ø§Ù„ <span id="timeoutTimer">60</span> Ø«Ø§Ù†ÙŠØ©</span>
  <button onclick="extendSession()" style="
    background: #000;
    color: #f59e0b;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 10px;
    cursor: pointer;
    font-size: 12px;
  ">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<!-- RichAds Script -->
<script src="https://richinfo.co/richpartners/pops/js/richads-pu-ob.js" 
        data-pubid="997615" 
        data-siteid="382131" 
        async 
        data-cfasync="false"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const analytics = firebase.analytics();

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ =====
let currentPhoneToReveal = null;
let currentProductKey = null;
let adWatchInProgress = false;
let adCountdownInterval = null;
let adWatchInterval = null;
let richadsTimerInterval = null;

// ===== Ø±ÙˆØ§Ø¨Ø· Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø© =====
const AD_URLS = [
  'https://richinfo.co/redirect?pub=997615&site=382131&type=popunder',
  'https://richinfo.co/redirect?pubid=997615&siteid=382131',
  'https://richinfo.co/richpartners/pops/redirect.php?pub=997615&site=382131',
  'https://ads.example.com/demo-ad.html',
  'https://www.google.com/adsense/start/'
];

// ===== Ø¯Ø§Ù„Ø© ÙƒØ´Ù Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† =====
function revealPhoneNumber(phone, productKey, elementId) {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØ´ÙˆÙØ§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  const revealedPhones = JSON.parse(localStorage.getItem('revealedPhones') || '{}');
  if (revealedPhones[productKey]) {
    showFullPhoneNumber(phone, elementId, productKey);
    return;
  }
  
  currentPhoneToReveal = phone;
  currentProductKey = productKey;
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
  showAdConfirmationDialog(elementId);
}

// ===== Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† =====
function showAdConfirmationDialog(elementId) {
  if (adWatchInProgress) return;
  
  adWatchInProgress = true;
  const dialog = document.getElementById('adConfirmDialog');
  const countdownElement = document.getElementById('adCountdown');
  const watchBtn = document.getElementById('watchAdBtn');
  
  dialog.style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  let countdown = 5;
  countdownElement.textContent = countdown;
  watchBtn.disabled = true;
  watchBtn.textContent = `Ù…Ø´Ø§Ù‡Ø¯Ø© (${countdown})`;
  
  // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
  adCountdownInterval = setInterval(() => {
    countdown--;
    countdownElement.textContent = countdown;
    watchBtn.textContent = `Ù…Ø´Ø§Ù‡Ø¯Ø© (${countdown})`;
    
    if (countdown <= 0) {
      clearInterval(adCountdownInterval);
      watchBtn.disabled = false;
      watchBtn.textContent = 'Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†';
    }
  }, 1000);
}

// ===== ØªØ®Ø·ÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† =====
function skipAd() {
  clearInterval(adCountdownInterval);
  closeAllAdDialogs();
  adWatchInProgress = false;
  
  progressManager.showWarning("Ù„Ù… ÙŠØªÙ… ÙƒØ´Ù Ø§Ù„Ø±Ù‚Ù…. ÙŠØ¬Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙƒØ§Ù…Ù„Ø§Ù‹.");
}

// ===== Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† =====
async function watchAd() {
  clearInterval(adCountdownInterval);
  closeAllAdDialogs();
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ù„Ø§Ù† RichAds
  showRichAd();
}

// ===== Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ù„Ø§Ù† RichAds =====
function showRichAd() {
  console.log("ğŸš€ Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† RichAds...");
  
  // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
  document.getElementById('adConfirmDialog').style.display = 'none';
  
  // Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† RichAds
  const container = document.getElementById('richadsContainer');
  const iframe = document.getElementById('richadsFrame');
  const timerElement = document.getElementById('richadsTimer');
  
  // Ø§Ø®ØªÙŠØ§Ø± Ø±Ø§Ø¨Ø· Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  const randomAdUrl = AD_URLS[Math.floor(Math.random() * AD_URLS.length)];
  console.log("Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±:", randomAdUrl);
  
  // ØªØ¹ÙŠÙŠÙ† Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© referrer policy
  iframe.src = randomAdUrl + '?referrer=' + encodeURIComponent(window.location.href);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
  container.style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª (30 Ø«Ø§Ù†ÙŠØ©)
  let timer = 30;
  timerElement.textContent = timer;
  
  richadsTimerInterval = setInterval(() => {
    timer--;
    timerElement.textContent = timer;
    
    if (timer <= 0) {
      clearInterval(richadsTimerInterval);
      onAdCompleted();
    }
  }, 1000);
  
  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ RichAds ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø±
  setTimeout(() => {
    try {
      if (window.RichAds && typeof window.RichAds.show === 'function') {
        console.log("ğŸ¯ ØªØ´ØºÙŠÙ„ RichAds ÙŠØ¯ÙˆÙŠØ§Ù‹");
        window.RichAds.show();
      }
    } catch (e) {
      console.log("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ RichAds:", e);
    }
  }, 2000);
}

// ===== Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø¹Ù„Ø§Ù† RichAds =====
function closeRichAds() {
  const container = document.getElementById('richadsContainer');
  const iframe = document.getElementById('richadsFrame');
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ù‚Øª
  if (richadsTimerInterval) {
    clearInterval(richadsTimerInterval);
  }
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø·Ø§Ø±
  iframe.src = '';
  container.style.display = 'none';
  document.body.style.overflow = '';
  
  // Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  onAdCompleted();
}

// ===== Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† =====
function onAdCompleted() {
  // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ°
  closeAllAdDialogs();
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø¹Ù„Ø§Ù† RichAds
  const container = document.getElementById('richadsContainer');
  const iframe = document.getElementById('richadsFrame');
  
  if (container.style.display !== 'none') {
    iframe.src = '';
    container.style.display = 'none';
    document.body.style.overflow = '';
  }
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
  progressManager.showSuccess("ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØ´ÙˆÙ Ø§Ù„Ø¢Ù†.");
  
  // Ø­ÙØ¸ Ø­Ø§Ù„Ø© ÙƒØ´Ù Ø§Ù„Ø±Ù‚Ù… ÙÙŠ localStorage
  const revealedPhones = JSON.parse(localStorage.getItem('revealedPhones') || '{}');
  revealedPhones[currentProductKey] = {
    phone: currentPhoneToReveal,
    timestamp: Date.now(),
    views: (revealedPhones[currentProductKey]?.views || 0) + 1
  };
  localStorage.setItem('revealedPhones', JSON.stringify(revealedPhones));
  
  // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ù‚Ù…
  showFullPhoneNumber(currentPhoneToReveal, null, currentProductKey);
  
  // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
  updateAllPhoneDisplays(currentProductKey, currentPhoneToReveal);
  
  adWatchInProgress = false;
  currentPhoneToReveal = null;
  currentProductKey = null;
}

// ===== Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† =====
function closeAllAdDialogs() {
  const confirmDialog = document.getElementById('adConfirmDialog');
  const watchDialog = document.getElementById('adWatchDialog');
  const richadsContainer = document.getElementById('richadsContainer');
  
  if (confirmDialog) confirmDialog.style.display = 'none';
  if (watchDialog) watchDialog.style.display = 'none';
  if (richadsContainer) {
    richadsContainer.style.display = 'none';
    document.getElementById('richadsFrame').src = '';
  }
  
  document.body.style.overflow = '';
  
  if (adCountdownInterval) clearInterval(adCountdownInterval);
  if (adWatchInterval) clearInterval(adWatchInterval);
  if (richadsTimerInterval) clearInterval(richadsTimerInterval);
}

// ===== Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ÙƒØ§Ù…Ù„ =====
function showFullPhoneNumber(phone, elementId, productKey) {
  if (elementId) {
    const element = document.getElementById(elementId);
    if (element) {
      element.innerHTML = phone;
      element.className = 'phone-unlocked';
      element.onclick = null;
      element.style.cursor = 'default';
    }
  }
  
  // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  const detailsContent = document.getElementById('detailsContent');
  if (detailsContent && detailsContent.innerHTML.includes(productKey)) {
    const phoneElements = detailsContent.querySelectorAll('.phone-reveal');
    phoneElements.forEach(el => {
      if (el.getAttribute('data-product-key') === productKey) {
        el.innerHTML = phone;
        el.className = 'phone-unlocked';
        el.onclick = null;
        el.style.cursor = 'default';
      }
    });
  }
}

// ===== ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø¹Ø±ÙˆØ¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ Ø§Ù„ØµÙØ­Ø© =====
function updateAllPhoneDisplays(productKey, phoneNumber) {
  // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    const phoneSpans = card.querySelectorAll('.phone-reveal');
    phoneSpans.forEach(span => {
      if (span.getAttribute('data-product-key') === productKey) {
        span.innerHTML = phoneNumber;
        span.className = 'phone-unlocked';
        span.onclick = null;
        span.style.cursor = 'default';
      }
    });
  });
  
  // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
  const detailsDialog = document.getElementById('detailsDialog');
  if (detailsDialog && detailsDialog.style.display === 'block') {
    const phoneSpans = detailsDialog.querySelectorAll('.phone-reveal');
    phoneSpans.forEach(span => {
      if (span.getAttribute('data-product-key') === productKey) {
        span.innerHTML = phoneNumber;
        span.className = 'phone-unlocked';
        span.onclick = null;
        span.style.cursor = 'default';
      }
    });
  }
}

// ===== ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© maskPhoneNumber Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ =====
function maskPhoneNumber(phone, productKey = null, context = 'card') {
  if (!phone || phone.length !== 11) {
    return `<span>${phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span>`;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØ´ÙˆÙØ§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  if (productKey) {
    const revealedPhones = JSON.parse(localStorage.getItem('revealedPhones') || '{}');
    if (revealedPhones[productKey]) {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¹Ù†ØµØ±
      const elementId = `phone-${productKey}-${context}-${Date.now()}`;
      return `<span id="${elementId}" class="phone-unlocked">${phone}</span>`;
    }
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¹Ù†ØµØ±
  const elementId = `phone-${productKey || 'unknown'}-${context}-${Date.now()}`;
  
  // Ø¥Ø±Ø¬Ø§Ø¹ Ø±Ù‚Ù… Ù…Ù‚Ù†Ø¹ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø±
  const masked = phone.substring(0, 4) + '****' + phone.substring(8);
  return `<span id="${elementId}" class="phone-reveal" 
           onclick="event.stopPropagation(); revealPhoneNumber('${escapeHTML(phone)}', '${productKey}', '${elementId}')"
           data-product-key="${productKey}">
           ${masked}
         </span>`;
}

// ===== Progress Bar System =====
class ProgressManager {
    constructor() {
        this.topProgressBar = document.getElementById('topProgressBar');
        this.progressBarLine = document.getElementById('progressBarLine');
        this.circularProgress = document.getElementById('circularProgress');
        this.progressOverlay = document.getElementById('progressOverlay');
        this.progressText = document.getElementById('progressText');
        this.progressSubtext = document.getElementById('progressSubtext');
        
        this.currentProgress = 0;
        this.progressInterval = null;
        this.isLoading = false;
        
        this.init();
    }
    
    init() {
        this.updateCircularProgress(0);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    showTopProgressBar() {
        this.topProgressBar.style.display = 'block';
        this.progressBarLine.style.width = '0%';
        this.progressBarLine.className = 'progress-bar-line';
        
        this.currentProgress = 0;
        clearInterval(this.progressInterval);
        
        this.progressInterval = setInterval(() => {
            if (this.currentProgress < 90) {
                this.currentProgress += Math.random() * 10;
                this.updateTopProgress(this.currentProgress);
            }
        }, 200);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ
    updateTopProgress(percent) {
        this.progressBarLine.style.width = `${Math.min(percent, 100)}%`;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    hideTopProgressBar() {
        clearInterval(this.progressInterval);
        this.updateTopProgress(100);
        
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.currentProgress = 0;
        }, 300);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    showCircularProgress() {
        this.circularProgress.style.display = 'block';
        this.updateCircularProgress(0);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            this.updateCircularProgress(progress);
            
            if (progress >= 100) {
                progress = 0;
            }
        }, 200);
        
        return () => clearInterval(interval);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    updateCircularProgress(percent) {
        const circle = this.circularProgress.querySelector('.progress-fill');
        if (circle) {
            const offset = 100 - percent;
            circle.style.strokeDashoffset = offset;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    hideCircularProgress() {
        this.circularProgress.style.display = 'none';
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Overlay ÙƒØ§Ù…Ù„
    showOverlay(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', subtext = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
        this.isLoading = true;
        this.progressText.textContent = text;
        this.progressSubtext.textContent = subtext;
        this.progressOverlay.classList.add('active');
        
        document.body.style.overflow = 'hidden';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù€ Overlay
    updateOverlayText(text, subtext = null) {
        this.progressText.textContent = text;
        if (subtext !== null) {
            this.progressSubtext.textContent = subtext;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Overlay
    hideOverlay() {
        this.isLoading = false;
        this.progressOverlay.classList.remove('active');
        
        setTimeout(() => {
            document.body.style.overflow = '';
        }, 300);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showSuccess(message = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!') {
        this.progressBarLine.className = 'progress-bar-line progress-success';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø®Ø·Ø£
    showError(message = 'Ø­Ø¯Ø« Ø®Ø·Ø£!') {
        this.progressBarLine.className = 'progress-bar-line progress-error';
        this.updateOverlayText(message, 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 2000);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
    showWarning(message = 'ØªØ­Ø°ÙŠØ±!') {
        this.progressBarLine.className = 'progress-bar-line progress-warning';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Skeleton Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    createSkeletonCards(count = 6) {
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
                <div class="skeleton-card">
                    <div class="skeleton-line" style="height: 20px; width: 70%"></div>
                    <div class="skeleton-line" style="height: 16px; width: 40%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 60%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 50%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 80%"></div>
                </div>
            `;
        }
        return skeletonHTML;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Progress Manager
const progressManager = new ProgressManager();

let userUID = null;
auth.onAuthStateChanged(u => {
    if (u) {
        userUID = u.uid;
        if (u.email) {
            db.ref("users/" + u.uid).update({
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }
});

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];
let budget = null;

/* ===== Pagination Variables ===== */
let currentPage = 1;
const postsPerPage = 6;

// ===== Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
let sessionTimeout = null;
let sessionWarning = null;
const SESSION_DURATION = 60 * 60 * 1000;
const SESSION_WARNING = 5 * 60 * 1000;

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† =====
function showSecurityWarning(message) {
    const content = document.getElementById('content');
    if (content) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'security-warning';
        warningDiv.innerHTML = `âš ï¸ ${message}`;
        content.insertBefore(warningDiv, content.firstChild);
        
        setTimeout(() => {
            warningDiv.style.opacity = '0';
            setTimeout(() => warningDiv.remove(), 500);
        }, 5000);
    }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
function initSessionManagement() {
    ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
        document.addEventListener(event, resetSessionTimer);
    });
    
    resetSessionTimer();
}

function resetSessionTimer() {
    if (sessionTimeout) clearTimeout(sessionTimeout);
    if (sessionWarning) clearTimeout(sessionWarning);
    
    document.getElementById('sessionTimeout').style.display = 'none';
    
    sessionWarning = setTimeout(() => {
        showSessionWarning();
    }, SESSION_DURATION - SESSION_WARNING);
    
    sessionTimeout = setTimeout(() => {
        handleSessionTimeout();
    }, SESSION_DURATION);
}

function showSessionWarning() {
    const timeoutDiv = document.getElementById('sessionTimeout');
    const timerSpan = document.getElementById('timeoutTimer');
    
    let secondsLeft = SESSION_WARNING / 1000;
    timerSpan.textContent = secondsLeft;
    timeoutDiv.style.display = 'block';
    
    const countdown = setInterval(() => {
        secondsLeft--;
        timerSpan.textContent = secondsLeft;
        
        if (secondsLeft <= 0) {
            clearInterval(countdown);
        }
    }, 1000);
}

function extendSession() {
    resetSessionTimer();
    showSecurityWarning("ØªÙ… ØªÙˆØ³ÙŠØ¹ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.");
}

function handleSessionTimeout() {
    if (currentUser && !currentUser.isAnonymous) {
        auth.signOut().then(() => {
            showSecurityWarning("Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.");
            showHome();
            updateAuthUI();
        });
    }
    else {
        window.location.reload();
    }
}

// Sidebar
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}
function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function showHome(){
  closeSidebar();
  progressManager.showTopProgressBar();
  
  setTimeout(() => {
    document.getElementById("content").innerHTML = `
      <div class="search-bar">
        <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
        <select id="cat" onchange="loadProducts()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
          ${categories.map(c=>`<option>${c}</option>`).join("")}
        </select>
        <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
      </div>
      <div class="cards" id="products"></div>
      <div id="pagination" style="text-align:center;margin:20px"></div>
    `;
    loadProducts();
    progressManager.hideTopProgressBar();
  }, 300);
}

// Budget Dialog
function showBudgetDialog(){ document.getElementById("budgetDialog").style.display="block"; }
function closeBudget(){ document.getElementById("budgetDialog").style.display="none"; }
function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  
  if (isNaN(val) || val < 0) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");
    return;
  }
  
  if (val > 10000000) {
    progressManager.showError("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");
    return;
  }
  
  budget = val;
  closeBudget();
  loadProducts();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
function loadProducts(){
  const s = document.getElementById("search")?.value.toLowerCase() || '';
  const c = document.getElementById("cat")?.value || '';
  
  // Ø¹Ø±Ø¶ Skeleton Loading
  const productsContainer = document.getElementById('products');
  if (productsContainer) {
    productsContainer.innerHTML = progressManager.createSkeletonCards(6);
  }
  
  progressManager.showTopProgressBar();
  
  db.ref("products").once("value", snap=>{
    const d = snap.val() || {};
    let htmlCards = [];

    Object.keys(d).forEach(k=>{
      const p = d[k];
      
      if (!p || !p.name || !p.price) {
        return;
      }
      
      const price = parseFloat(p.price) || 0;
      if((!c || p.category===c) && p.name.toLowerCase().includes(s)){
        if(budget && price > budget) return;
        
        const status = p.status || 'available';
        let statusBadge = '';
        if (status !== 'available') {
          statusBadge = `<div class="product-status status-${status}">${getStatusText(status)}</div>`;
        }
        
        const sellerSection = userDisplayName ? 
          `<div class="seller">
            ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">${p.seller}</span> 
            ${p.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
            | â˜ ${maskPhoneNumber(p.phone, k, 'card')}
            <br><small style="color:#9ca3af; font-size:11px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
          </div>` :
          `<div class="seller">
            ğŸ‘¤ ${p.seller} | â˜ ${maskPhoneNumber(p.phone, k, 'card')}
          </div>`;
        
        htmlCards.push({uid:p.uid,key:k,html:`
          <div class="card" onclick="showDetails('${k}')">
            <h3>${escapeHTML(p.name)}</h3>
            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
            ${statusBadge}
            <div class="meta">
              <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
            </div>
            ${sellerSection}
            <div class="actions">
              ${(p.uid===userUID || isAdmin)?`
              <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
            </div>
          </div>
        `});
      }
    });

    if(userUID){
      htmlCards = htmlCards.sort((a,b)=> b.uid===userUID ? 1 : -1);
    }

    const totalPages = Math.ceil(htmlCards.length / postsPerPage);
    if(currentPage > totalPages) currentPage = 1;
    const start = (currentPage-1)*postsPerPage;
    const pageItems = htmlCards.slice(start, start+postsPerPage);

    let finalHTML = pageItems.map(p=>p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    
    if (productsContainer) {
      productsContainer.style.opacity = '0';
      setTimeout(() => {
        productsContainer.innerHTML = finalHTML;
        productsContainer.style.opacity = '1';
        renderPagination(totalPages);
        progressManager.hideTopProgressBar();
      }, 300);
    }
  }).catch(error => {
    console.error("Error loading products:", error);
    if (productsContainer) {
      productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    }
    progressManager.hideTopProgressBar();
    progressManager.showError("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
  });
}

// Render Pagination Buttons
function renderPagination(total){
  let html = "";
  for(let i=1;i<=total;i++){
    html += `
      <button onclick="goPage(${i})"
        style="
          margin:3px;
          padding:6px 10px;
          border-radius:5px;
          border:none;
          cursor:pointer;
          background:${i===currentPage?'#38bdf8':'#1f2937'};
          color:${i===currentPage?'#000':'#fff'};
        ">
        ${i}
      </button>`;
  }
  const pagination = document.getElementById('pagination');
  if (pagination) {
    pagination.innerHTML = html;
  }
}

function goPage(p){
  currentPage = p;
  loadProducts();
}

// Ø­Ø°Ù / ØªØ¹Ø¯ÙŠÙ„ / Ù†Ø´Ø±
function deleteProduct(k){ 
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
    return;
  }
  
  progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
  
  db.ref("products/" + k).once('value', (snapshot) => {
    const product = snapshot.val();
    if (!product) {
      progressManager.hideOverlay();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      progressManager.hideOverlay();
      progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    if (product.uid) {
      db.ref('users/' + product.uid).once('value', (userSnapshot) => {
        const userData = userSnapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          if (currentCount > 0) {
            db.ref('users/' + product.uid).update({
              totalProducts: currentCount - 1
            });
          }
        }
      });
    }
    
    db.ref("products/"+k).remove().then(() => {
      progressManager.showSuccess("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
      loadProducts();
      
      if (userUID) {
        db.ref("userActivity/" + userUID).push().set({
          type: 'product_deleted',
          productId: k,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }).catch(error => {
      console.error("Delete error:", error);
      progressManager.hideOverlay();
      progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    });
  });
}

function editProduct(k){ 
  progressManager.showTopProgressBar();
  
  db.ref("products/"+k).once("value", s => {
    const product = s.val();
    if (!product) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    showPublish(product, k);
    progressManager.hideTopProgressBar();
  });
}

// ===== ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© showPublish Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function showPublish(p=null,k=null){
  closeSidebar();
  
  progressManager.showTopProgressBar();
  
  setTimeout(() => {
    if (!userUID && !currentUser) {
      const publishAnyway = confirm("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„ØŸ (Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø³ÙŠØ­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬)");
      if (!publishAnyway) {
        progressManager.hideTopProgressBar();
        showHome();
        return;
      }
    }
    
    const sellerName = userDisplayName || (p ? p.seller : "");
    const sellerField = userDisplayName ? 
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
       <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" maxlength="30">`;
    
    document.getElementById("content").innerHTML = `
      <div class="form-box">
        <h2>${p?"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†":"Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
        <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p?escapeHTML(p.name):""}" maxlength="50" required>
        <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p?p.price:""}" min="0" max="10000000" required>
        <select id="category">${categories.map(c=>`<option ${p&&p.category===c?"selected":""}>${c}</option>`).join("")}</select>
        ${sellerField}
        <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p?p.phone:""}" pattern="[0][0-9]{10}" required>
        <small style="color:#9ca3af; font-size:12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…</small>
        <select id="province">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
          ${provinces.map(pr=>`<option ${p&&p.province===pr?"selected":""}>${pr}</option>`).join("")}
        </select>
        <select id="delivery">
          <option value="Ù†Ø¹Ù…" ${p&&p.delivery==="Ù†Ø¹Ù…"?"selected":""}>Ù†Ø¹Ù…</option>
          <option value="Ù„Ø§" ${p&&p.delivery==="Ù„Ø§"?"selected":""}>Ù„Ø§</option>
        </select>
        <select id="status" ${isAdmin || (p && p.uid === userUID) ? '' : 'disabled'}>
          <option value="available" ${p&&p.status==="available"?"selected":""}>Ù…ØªØ§Ø­</option>
          <option value="sold" ${p&&p.status==="sold"?"selected":""}>Ù…Ø¨Ø§Ø¹</option>
          <option value="reserved" ${p&&p.status==="reserved"?"selected":""}>Ù…Ø­Ø¬ÙˆØ²</option>
        </select>
        <small style="color:#9ca3af; font-size:12px;">${isAdmin ? 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†' : 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±'}</small>
        <button onclick="save('${k||""}')" id="saveBtn">ğŸ’¾ ${p?"ØªØ­Ø¯ÙŠØ«":"Ù†Ø´Ø±"}</button>
        ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
      </div>`;
    
    progressManager.hideTopProgressBar();
  }, 300);
}

function save(k){
  const name = document.getElementById("name").value.trim();
  const price = document.getElementById("price").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const province = document.getElementById("province").value;
  
  if (!name || !price || !phone || !province) {
    progressManager.showError("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }
  
  if (name.length < 3 || name.length > 50) {
    progressManager.showError("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
    return;
  }
  
  const priceNum = parseFloat(price);
  if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
    progressManager.showError("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
    return;
  }
  
  if(!/^[0][0-9]{10}$/.test(phone)){
    progressManager.showError("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
    return;
  }
  
  if (!province) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
    return;
  }

  const seller = userDisplayName || document.getElementById("seller").value.trim();
  
  if (!seller || seller.length < 2) {
    progressManager.showError("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
    return;
  }

  const data = {
    name: name,
    price: priceNum,
    category: document.getElementById("category").value,
    seller: seller,
    phone: phone,
    province: province,
    delivery: document.getElementById("delivery").value,
    status: document.getElementById("status").value || "available",
    uid: userUID,
    lastUpdated: firebase.database.ServerValue.TIMESTAMP
  };
  
  if (!k) {
    data.createdAt = firebase.database.ServerValue.TIMESTAMP;
    data.timestamp = firebase.database.ServerValue.TIMESTAMP;
  }
  
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  saveBtn.classList.add('loading');
  
  progressManager.showOverlay(k ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..." : "Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
  
  const ref = k ? db.ref("products/"+k) : db.ref("products").push();
  
  ref.set(data).then(() => {
    if (!k && userUID) {
      db.ref('users/' + userUID).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          db.ref('users/' + userUID).update({
            totalProducts: currentCount + 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        } else {
          db.ref('users/' + userUID).update({
            totalProducts: 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    }
    
    if (userUID) {
      const activityType = k ? 'product_updated' : 'product_created';
      db.ref("userActivity/" + userUID).push().set({
        type: activityType,
        productId: k || ref.key,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    progressManager.showSuccess(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
    
    saveBtn.innerHTML = originalText;
    saveBtn.classList.remove('loading');
    
    setTimeout(() => {
      showHome();
    }, 1000);
  }).catch(error => {
    console.error("Error saving product:", error);
    progressManager.hideOverlay();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    
    saveBtn.innerHTML = originalText;
    saveBtn.classList.remove('loading');
  });
}

// Product Details - ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
function showDetails(k){
  progressManager.showCircularProgress();
  
  db.ref("products/"+k).once("value",snap=>{
    const p = snap.val();
    if(!p) {
      progressManager.hideCircularProgress();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
      return;
    }
    
    const sellerWithLink = userDisplayName ? 
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">${p.seller}</span>
       ${p.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}</p>
       <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${p.seller} ${p.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}</p>`;
    
    const statusText = p.status ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${p.status}">${getStatusText(p.status)}</span></p>` : '';
    
    document.getElementById("detailsContent").innerHTML = `
      <h2>${escapeHTML(p.name)}</h2>
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      ${statusText}
      ${sellerWithLink}
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${maskPhoneNumber(p.phone, k, 'details')}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
      ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
      ${isAdmin ? `<p style="color:#8b5cf6; font-size:12px; margin-top:10px;">Ø§Ù„Ù…Ø¹Ø±Ù: ${k}</p>` : ""}
    `;
    document.getElementById("detailsDialog").style.display="block";
    progressManager.hideCircularProgress();
  }).catch(error => {
    console.error("Error loading details:", error);
    progressManager.hideCircularProgress();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
  });
}

function closeDetails(){
  document.getElementById("detailsDialog").style.display="none";
}

// ===== Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
  const authSection = document.getElementById("authSection");
  
  if (!authSection) return;
  
  if (currentUser && userDisplayName) {
    db.ref("users/" + currentUser.uid).once("value", snapshot => {
      const userData = snapshot.val();
      const displayName = userData ? (userData.fullName || userDisplayName) : userDisplayName;
      
      isAdmin = userData && userData.isAdmin === true;
      
      authSection.innerHTML = `
        <div class="user-info">
          <p class="profile-link" onclick="viewMyProfile()">
            ğŸ‘¤ ${displayName}
            ${isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
            ${userData && userData.isVerified ? '<span class="verified-badge">âœ“</span>' : ''}
          </p>
          <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
          <small style="color:#9ca3af; font-size:11px; display:block; margin:5px 0;">${userData ? userData.totalProducts || 0 : 0} Ø¥Ø¹Ù„Ø§Ù†</small>
          <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          ${isAdmin ? `
          <button onclick="showAdminPanel()" style="
            width: 100%;
            padding: 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
          ">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>` : ''}
        </div>
      `;
    });
  } else {
    authSection.innerHTML = `
      <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <div style="color:#9ca3af; font-size:12px; text-align:center; padding:10px;">
        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØªÙŠØ­ Ù„Ùƒ:
        <div style="font-size:11px; margin-top:5px;">
          âœ“ Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ<br>
          âœ“ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†<br>
          âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ<br>
          âœ“ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ùƒ
        </div>
      </div>
    `;
  }
}

function logoutUser() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
    progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...", "Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹");
    
    auth.signOut()
      .then(() => {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        updateAuthUI();
        showHome();
        progressManager.showSuccess("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      })
      .catch((error) => {
        console.error("Logout error:", error);
        progressManager.hideOverlay();
        progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      });
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
function viewProfile(userId, sellerName) {
  if (sellerName) {
    localStorage.setItem('profileSellerName', sellerName);
  }
  
  progressManager.showTopProgressBar();
  setTimeout(() => {
    window.location.href = `profile.html?id=${userId}`;
  }, 300);
}

function viewMyProfile() {
  if (currentUser && currentUser.uid) {
    progressManager.showTopProgressBar();
    setTimeout(() => {
      window.location.href = `profile.html?id=${currentUser.uid}`;
    }, 300);
  } else {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1500);
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatPrice(price) {
  return parseInt(price).toLocaleString('ar-SA');
}

function getStatusText(status) {
  const statuses = {
    'available': 'Ù…ØªØ§Ø­',
    'sold': 'Ù…Ø¨Ø§Ø¹',
    'reserved': 'Ù…Ø­Ø¬ÙˆØ²'
  };
  return statuses[status] || status;
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    userUID = user.uid;
    
    if (user.email) {
      db.ref("users/" + user.uid).once("value", snapshot => {
        const userData = snapshot.val();
        if (userData) {
          userDisplayName = userData.username;
          userFullName = userData.fullName;
          isAdmin = userData.isAdmin === true;
          updateAuthUI();
          
          db.ref("users/" + user.uid).update({
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    } else {
      userDisplayName = "Ø²Ø§Ø¦Ø±";
      updateAuthUI();
    }
  } else {
    currentUser = null;
    userDisplayName = null;
    userFullName = null;
    isAdmin = false;
    updateAuthUI();
  }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
  showHome();
  updateAuthUI();
  initSessionManagement();
  
  document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    e.preventDefault();
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
      e.preventDefault();
    }
  });
  
  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
  window.addEventListener('beforeunload', function() {
    closeAllAdDialogs();
  });
});
</script>

</body>
</html>
