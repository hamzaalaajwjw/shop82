<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' https://www.gstatic.com https://apis.google.com; 
                   style-src 'self' 'unsafe-inline'; 
                   img-src 'self' data: https:; 
                   font-src 'self' data:;
                   connect-src 'self' https://*.firebaseio.com https://*.googleapis.com;
                   frame-ancestors 'none';
                   form-action 'self';
                   base-uri 'self'">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* ===== Custom Font ===== */
        @font-face {
            font-family: 'CustomFont';
            src: url('font.ttf') format('truetype');
        }
        
        body, input, select, button, textarea { 
            font-family: 'CustomFont', sans-serif; 
        }
        
        /* ===== Security Badges ===== */
        .security-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #10b981;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .security-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .verified-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .product-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            margin-top: 5px;
            display: inline-block;
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-available { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)); 
            color: #10b981; 
        }
        
        .status-sold { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.3)); 
            color: #ef4444; 
        }
        
        .status-reserved { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3)); 
            color: #f59e0b; 
        }
        
        .publish-timer {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.2));
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            text-align: center;
            direction: ltr;
            font-weight: bold;
        }
        
        .phone-number {
            direction: ltr;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #38bdf8;
            letter-spacing: 1px;
            background: rgba(56, 189, 248, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }
        
        .security-audit {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(15, 23, 42, 0.9);
            color: #9ca3af;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 9999;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <!-- Security Indicator -->
    <div class="security-indicator" id="securityIndicator">
        ğŸ”’ Ø¢Ù…Ù†
    </div>
    
    <!-- Security Audit Monitor -->
    <div class="security-audit" id="securityAudit">
        ğŸ” Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©
    </div>

    <header class="topbar">
        <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
        <div class="logo">a3len</div>
        <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
    </header>

    <!-- Loading System -->
    <div class="progress-overlay" id="progressOverlay">
        <div class="progress-overlay-content">
            <div class="progress-overlay-spinner"></div>
            <div class="progress-overlay-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ...</div>
            <div class="progress-overlay-subtext" id="progressSubtext">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
        </div>
    </div>

    <div class="overlay" onclick="closeSidebar()"></div>

    <div class="layout">
        <aside class="sidebar">
            <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
            <div id="authSection" class="auth-section"></div>
        </aside>

        <main id="content"></main>
    </div>

    <!-- Modals -->
    <div class="details-dialog" id="detailsDialog">
        <div id="detailsContent"></div>
        <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics-compat.js"></script>

    <!-- Security Scripts -->
    <script>
        // ===== FIREBASE CONFIG (PROTECTED VERSION) =====
        // Note: For production, use environment variables or backend proxy
        const firebaseConfig = {
            apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
            authDomain: "a3len-3ad54.firebasestorage.app",
            databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
            projectId: "a3len-3ad54",
            storageBucket: "a3len-3ad54.firebasestorage.app",
            messagingSenderId: "767338034080",
            appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
        };

        // ===== SECURITY MONITOR =====
        class SecurityMonitor {
            constructor() {
                this.auditLog = [];
                this.suspiciousActivities = [];
                this.initializeSecurity();
            }
            
            initializeSecurity() {
                this.detectTampering();
                this.monitorConsole();
                this.preventDevTools();
                this.detectXSS();
                this.logSecurityEvent('SYSTEM_START', 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù† Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„');
            }
            
            logSecurityEvent(type, message, data = null) {
                const event = {
                    timestamp: new Date().toISOString(),
                    type,
                    message,
                    data,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                this.auditLog.push(event);
                
                // Log to console in development only
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log(`ğŸ”’ [${type}] ${message}`, data || '');
                }
                
                // Store in localStorage (limited)
                if (this.auditLog.length > 50) {
                    this.auditLog.shift();
                }
                
                localStorage.setItem('security_audit', JSON.stringify(this.auditLog.slice(-10)));
            }
            
            detectTampering() {
                const originalConsole = {
                    log: console.log,
                    warn: console.warn,
                    error: console.error
                };
                
                // Monitor console usage
                console.log = (...args) => {
                    this.logSecurityEvent('CONSOLE_ACCESS', 'ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„', args);
                    originalConsole.log.apply(console, args);
                };
                
                // Monitor localStorage access
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = function(key, value) {
                    if (key.includes('firebase') || key.includes('auth') || key.includes('token')) {
                        console.warn('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø³Ø© ÙÙŠ localStorage');
                    }
                    return originalSetItem.apply(this, arguments);
                };
            }
            
            monitorConsole() {
                // Detect debugger statements
                setInterval(() => {
                    const start = Date.now();
                    debugger;
                    const end = Date.now();
                    
                    if (end - start > 100) {
                        this.logSecurityEvent('DEBUGGER_DETECTED', 'ØªÙ… Ø§ÙƒØªØ´Ø§Ù debugger');
                        window.location.reload();
                    }
                }, 1000);
            }
            
            preventDevTools() {
                // Prevent F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
                document.addEventListener('keydown', (e) => {
                    if (
                        e.key === 'F12' ||
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                        (e.ctrlKey && e.key === 'U') ||
                        (e.key === 'I' && e.altKey)
                    ) {
                        e.preventDefault();
                        this.logSecurityEvent('DEVTOOLS_BLOCKED', 'ØªÙ… Ù…Ù†Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±');
                        this.showSecurityWarning('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©');
                        return false;
                    }
                });
                
                // Prevent right-click
                document.addEventListener('contextmenu', (e) => {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        this.logSecurityEvent('CONTEXT_MENU_BLOCKED', 'ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');
                        return false;
                    }
                });
            }
            
            detectXSS() {
                // Sanitize all user inputs
                const sanitizeHTML = (str) => {
                    if (typeof str !== 'string') return str;
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };
                
                window.sanitizeInput = sanitizeHTML;
            }
            
            showSecurityWarning(message) {
                const warning = document.createElement('div');
                warning.className = 'security-warning';
                warning.innerHTML = `âš ï¸ ${message}`;
                
                document.body.appendChild(warning);
                
                setTimeout(() => {
                    warning.style.opacity = '0';
                    setTimeout(() => warning.remove(), 500);
                }, 5000);
            }
            
            validatePhoneNumber(phone) {
                // Strong phone validation for Iraq
                const regex = /^(0)(7[0-9]{2}|78[0-9]|79[0-9])[0-9]{7}$/;
                if (!regex.test(phone)) {
                    this.logSecurityEvent('INVALID_PHONE', 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­', { phone });
                    return false;
                }
                return true;
            }
            
            validateProductData(data) {
                const required = ['name', 'price', 'category', 'seller', 'phone', 'province'];
                const missing = required.filter(field => !data[field]);
                
                if (missing.length > 0) {
                    this.logSecurityEvent('INVALID_DATA', 'Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', { missing });
                    return false;
                }
                
                // Price validation
                if (data.price < 0 || data.price > 10000000) {
                    this.logSecurityEvent('INVALID_PRICE', 'Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­', { price: data.price });
                    return false;
                }
                
                // Name validation
                if (data.name.length < 3 || data.name.length > 50) {
                    this.logSecurityEvent('INVALID_NAME', 'Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­', { name: data.name });
                    return false;
                }
                
                return true;
            }
        }

        // ===== APPLICATION CODE WITH ENHANCED SECURITY =====
        class SecureApplication {
            constructor() {
                this.security = new SecurityMonitor();
                this.progressOverlay = document.getElementById('progressOverlay');
                this.progressText = document.getElementById('progressText');
                this.progressSubtext = document.getElementById('progressSubtext');
                
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                this.auth = firebase.auth();
                this.db = firebase.database();
                this.analytics = firebase.analytics();
                
                this.currentUser = null;
                this.userUID = null;
                this.isAdmin = false;
                this.canPublish = true;
                this.publishTimer = null;
                this.publishTimeLeft = 0;
                
                this.categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
                this.provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];
                
                this.init();
            }
            
            async init() {
                this.showProgress('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ...', 'ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…');
                
                try {
                    // Monitor auth state
                    this.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            this.currentUser = user;
                            this.userUID = user.uid;
                            
                            // Get user data with security checks
                            const userRef = this.db.ref('users/' + user.uid);
                            userRef.once('value').then(snapshot => {
                                const userData = snapshot.val();
                                if (userData) {
                                    this.isAdmin = userData.isAdmin === true;
                                    this.security.logSecurityEvent('USER_AUTH', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', { 
                                        uid: user.uid,
                                        isAdmin: this.isAdmin 
                                    });
                                }
                            }).catch(error => {
                                this.security.logSecurityEvent('AUTH_ERROR', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', { error });
                            });
                        } else {
                            this.currentUser = null;
                            this.userUID = null;
                            this.isAdmin = false;
                        }
                        this.updateAuthUI();
                    });
                    
                    // Start security monitoring
                    setInterval(() => this.checkSession(), 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                    
                    this.security.logSecurityEvent('APP_INIT', 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²');
                    this.hideProgress();
                    this.showHome();
                    
                } catch (error) {
                    this.security.logSecurityEvent('INIT_ERROR', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', { error });
                    this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…');
                }
            }
            
            showProgress(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', subtext = '') {
                this.progressText.textContent = text;
                this.progressSubtext.textContent = subtext;
                this.progressOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            hideProgress() {
                setTimeout(() => {
                    this.progressOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
            
            showError(message) {
                this.security.showSecurityWarning(message);
            }
            
            async checkSession() {
                // Check for suspicious activities
                if (this.suspiciousActivities.length > 5) {
                    this.security.logSecurityEvent('SUSPICIOUS_ACTIVITY', 'Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡', { 
                        activities: this.suspiciousActivities.length 
                    });
                    
                    if (this.currentUser) {
                        await this.auth.signOut();
                        this.showError('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø³Ø¨Ø¨ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡');
                    }
                }
            }
            
            // ===== AUTHENTICATION =====
            updateAuthUI() {
                const authSection = document.getElementById('authSection');
                if (!authSection) return;
                
                if (this.currentUser) {
                    this.db.ref('users/' + this.currentUser.uid).once('value').then(snapshot => {
                        const userData = snapshot.val();
                        const displayName = userData?.fullName || this.currentUser.email?.split('@')[0] || 'Ù…Ø³ØªØ®Ø¯Ù…';
                        
                        authSection.innerHTML = `
                            <div class="user-info">
                                <p class="profile-link" onclick="app.viewMyProfile()">
                                    ğŸ‘¤ ${this.escapeHTML(displayName)}
                                    ${this.isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
                                    ${userData?.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                                </p>
                                <small style="color:#9ca3af; font-size:12px;">${this.currentUser.email || ''}</small>
                                <button class="logout-btn" onclick="app.logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                            </div>
                        `;
                    });
                } else {
                    authSection.innerHTML = `
                        <button class="auth-btn" onclick="app.showLogin()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                        <button class="auth-btn" onclick="app.showRegister()">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                    `;
                }
            }
            
            async logout() {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                    try {
                        await this.auth.signOut();
                        this.security.logSecurityEvent('USER_LOGOUT', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                        this.showHome();
                    } catch (error) {
                        this.security.logSecurityEvent('LOGOUT_ERROR', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', { error });
                        this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                    }
                }
            }
            
            // ===== HOME PAGE =====
            showHome() {
                document.getElementById('content').innerHTML = `
                    <div class="search-bar">
                        <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="app.loadProducts()" maxlength="50">
                        <select id="cat" onchange="app.loadProducts()">
                            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                            ${this.categories.map(c => `<option>${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="cards" id="products"></div>
                `;
                
                this.loadProducts();
            }
            
            async loadProducts() {
                try {
                    this.showProgress('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª...', '');
                    
                    const search = document.getElementById('search')?.value.toLowerCase() || '';
                    const category = document.getElementById('cat')?.value || '';
                    
                    const snapshot = await this.db.ref('products').once('value');
                    const products = snapshot.val() || {};
                    
                    let html = '';
                    Object.entries(products).forEach(([key, product]) => {
                        if (!product || !product.name) return;
                        
                        // Apply filters
                        if (category && product.category !== category) return;
                        if (search && !product.name.toLowerCase().includes(search)) return;
                        
                        const status = product.status || 'available';
                        const statusText = {
                            'available': 'Ù…ØªØ§Ø­',
                            'sold': 'Ù…Ø¨Ø§Ø¹',
                            'reserved': 'Ù…Ø­Ø¬ÙˆØ²'
                        }[status] || status;
                        
                        html += `
                            <div class="card" onclick="app.showProductDetails('${key}')">
                                <h3>${this.escapeHTML(product.name)}</h3>
                                <span class="price">${this.formatPrice(product.price)} Ø¯.Ø¹</span>
                                <div class="product-status status-${status}">${statusText}</div>
                                <div class="meta">
                                    <span>${product.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                    <span>${product.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                    <span>ØªÙˆØµÙŠÙ„: ${product.delivery === 'Ù†Ø¹Ù…' ? 'âœ…' : 'âŒ'}</span>
                                </div>
                                <div class="seller">
                                    ğŸ‘¤ ${this.escapeHTML(product.seller || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')}
                                    ${product.isVerified ? '<span class="verified-badge">Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                                    <br>
                                    â˜ <span class="phone-number">${product.phone}</span>
                                </div>
                                ${product.uid === this.userUID || this.isAdmin ? `
                                <div class="actions">
                                    <button class="edit" onclick="app.editProduct('${key}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="del" onclick="app.deleteProduct('${key}');event.stopPropagation();">Ø­Ø°Ù</button>
                                </div>` : ''}
                            </div>
                        `;
                    });
                    
                    if (!html) {
                        html = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>';
                    }
                    
                    document.getElementById('products').innerHTML = html;
                    this.hideProgress();
                    
                } catch (error) {
                    this.security.logSecurityEvent('LOAD_ERROR', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', { error });
                    this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª');
                    this.hideProgress();
                }
            }
            
            // ===== PRODUCT DETAILS =====
            async showProductDetails(productId) {
                try {
                    this.showProgress('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„...', '');
                    
                    const snapshot = await this.db.ref('products/' + productId).once('value');
                    const product = snapshot.val();
                    
                    if (!product) {
                        this.showError('Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        this.hideProgress();
                        return;
                    }
                    
                    const statusText = {
                        'available': 'Ù…ØªØ§Ø­',
                        'sold': 'Ù…Ø¨Ø§Ø¹',
                        'reserved': 'Ù…Ø­Ø¬ÙˆØ²'
                    }[product.status] || product.status;
                    
                    document.getElementById('detailsContent').innerHTML = `
                        <h2>${this.escapeHTML(product.name)}</h2>
                        <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${this.formatPrice(product.price)} Ø¯.Ø¹</p>
                        <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${product.category}</p>
                        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${product.status}">${statusText}</span></p>
                        <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${this.escapeHTML(product.seller)} 
                           ${product.isVerified ? '<span class="verified-badge">Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}</p>
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span class="phone-number">${product.phone}</span></p>
                        <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${product.province}</p>
                        <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${product.delivery === 'Ù†Ø¹Ù…' ? 'Ù…ØªØ§Ø­' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</p>
                        ${product.uid === this.userUID ? '<p style="color:#38bdf8;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>' : ''}
                    `;
                    
                    document.getElementById('detailsDialog').style.display = 'block';
                    this.hideProgress();
                    
                    this.security.logSecurityEvent('PRODUCT_VIEW', 'Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬', { productId });
                    
                } catch (error) {
                    this.security.logSecurityEvent('DETAILS_ERROR', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„', { error });
                    this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
                    this.hideProgress();
                }
            }
            
            closeDetails() {
                document.getElementById('detailsDialog').style.display = 'none';
            }
            
            // ===== PUBLISH PRODUCT =====
            async showPublish(editProduct = null, productId = null) {
                // Check publish cooldown
                if (!editProduct) {
                    const canPublishResult = await this.checkPublishCooldown();
                    if (!canPublishResult.canPublish) {
                        document.getElementById('content').innerHTML = `
                            <div class="form-box">
                                <h2>Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</h2>
                                <div class="publish-timer">
                                    â° ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${canPublishResult.minutes}:${canPublishResult.seconds}
                                    <br><small>ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ ÙƒÙ„ Ø³Ø§Ø¹Ø©</small>
                                </div>
                                <button onclick="app.showHome()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                            </div>
                        `;
                        return;
                    }
                }
                
                const sellerName = this.currentUser?.email?.split('@')[0] || editProduct?.seller || '';
                
                document.getElementById('content').innerHTML = `
                    <div class="form-box">
                        <h2>${editProduct ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†' : 'Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯'}</h2>
                        
                        <input id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© *" 
                               value="${editProduct ? this.escapeHTML(editProduct.name) : ''}" 
                               maxlength="50" required>
                        
                        <input id="productPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± *" 
                               value="${editProduct ? editProduct.price : ''}" 
                               min="0" max="10000000" required>
                        
                        <select id="productCategory">
                            ${this.categories.map(cat => 
                                `<option value="${cat}" ${editProduct?.category === cat ? 'selected' : ''}>
                                    ${cat}
                                </option>`
                            ).join('')}
                        </select>
                        
                        <input id="productSeller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ *" 
                               value="${sellerName}" 
                               ${this.currentUser ? 'disabled style="background:#374151"' : ''} 
                               maxlength="30" required>
                        
                        <input id="productPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ * (07XXXXXXXXX)" 
                               value="${editProduct ? editProduct.phone : ''}" 
                               pattern="07[0-9]{9}" required>
                        <small style="color:#9ca3af; font-size:12px;">Ù…Ø«Ø§Ù„: 07701234567</small>
                        
                        <select id="productProvince">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</option>
                            ${this.provinces.map(prov => 
                                `<option value="${prov}" ${editProduct?.province === prov ? 'selected' : ''}>
                                    ${prov}
                                </option>`
                            ).join('')}
                        </select>
                        
                        <select id="productDelivery">
                            <option value="Ù†Ø¹Ù…" ${editProduct?.delivery === 'Ù†Ø¹Ù…' ? 'selected' : ''}>Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…ØªØ§Ø­</option>
                            <option value="Ù„Ø§" ${editProduct?.delivery === 'Ù„Ø§' ? 'selected' : ''}>Ø§Ù„ØªÙˆØµÙŠÙ„ ØºÙŠØ± Ù…ØªØ§Ø­</option>
                        </select>
                        
                        <select id="productStatus" ${this.isAdmin || editProduct ? '' : 'disabled'}>
                            <option value="available" ${editProduct?.status === 'available' ? 'selected' : ''}>Ù…ØªØ§Ø­</option>
                            <option value="reserved" ${editProduct?.status === 'reserved' ? 'selected' : ''}>Ù…Ø­Ø¬ÙˆØ²</option>
                            <option value="sold" ${editProduct?.status === 'sold' ? 'selected' : ''}>Ù…Ø¨Ø§Ø¹</option>
                        </select>
                        
                        <button onclick="app.saveProduct('${productId || ''}')" id="saveBtn">
                            ğŸ’¾ ${editProduct ? 'ØªØ­Ø¯ÙŠØ«' : 'Ù†Ø´Ø±'}
                        </button>
                        
                        <button onclick="app.showHome()" style="background:#6b7280; margin-top:10px;">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                `;
            }
            
            async checkPublishCooldown() {
                if (!this.userUID) return { canPublish: true };
                
                try {
                    const userRef = this.db.ref('users/' + this.userUID);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();
                    
                    if (userData?.lastPublish) {
                        const timeDiff = Date.now() - userData.lastPublish;
                        const oneHour = 60 * 60 * 1000;
                        
                        if (timeDiff < oneHour) {
                            const remaining = Math.ceil((oneHour - timeDiff) / 1000);
                            const minutes = Math.floor(remaining / 60);
                            const seconds = remaining % 60;
                            
                            return {
                                canPublish: false,
                                minutes: minutes.toString().padStart(2, '0'),
                                seconds: seconds.toString().padStart(2, '0')
                            };
                        }
                    }
                    
                    return { canPublish: true };
                    
                } catch (error) {
                    this.security.logSecurityEvent('COOLDOWN_ERROR', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±', { error });
                    return { canPublish: true };
                }
            }
            
            async saveProduct(productId = null) {
                try {
                    this.showProgress('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                    
                    // Collect form data
                    const productData = {
                        name: document.getElementById('productName').value.trim(),
                        price: parseFloat(document.getElementById('productPrice').value),
                        category: document.getElementById('productCategory').value,
                        seller: document.getElementById('productSeller').value.trim(),
                        phone: document.getElementById('productPhone').value.trim(),
                        province: document.getElementById('productProvince').value,
                        delivery: document.getElementById('productDelivery').value,
                        status: document.getElementById('productStatus').value || 'available',
                        uid: this.userUID,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                        isVerified: false
                    };
                    
                    // Security validation
                    if (!this.security.validateProductData(productData)) {
                        this.showError('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
                        this.hideProgress();
                        return;
                    }
                    
                    if (!this.security.validatePhoneNumber(productData.phone)) {
                        this.showError('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ØµÙŠØºØ© 07XXXXXXXXX');
                        this.hideProgress();
                        return;
                    }
                    
                    // For new products
                    if (!productId) {
                        productData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                        productData.timestamp = firebase.database.ServerValue.TIMESTAMP;
                        
                        // Update user's last publish time
                        await this.db.ref('users/' + this.userUID).update({
                            lastPublish: Date.now(),
                            totalProducts: firebase.database.ServerValue.increment(1)
                        });
                        
                        this.security.logSecurityEvent('PRODUCT_CREATED', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', {
                            name: productData.name,
                            price: productData.price
                        });
                    }
                    
                    // Save to Firebase
                    const ref = productId 
                        ? this.db.ref('products/' + productId)
                        : this.db.ref('products').push();
                    
                    await ref.set(productData);
                    
                    this.security.logSecurityEvent('PRODUCT_SAVED', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬', { 
                        productId: ref.key,
                        isUpdate: !!productId 
                    });
                    
                    this.hideProgress();
                    this.showHome();
                    this.showError(productId ? 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†' : 'âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                    
                } catch (error) {
                    this.security.logSecurityEvent('SAVE_ERROR', 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬', { error });
                    this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
                    this.hideProgress();
                }
            }
            
            // ===== EDIT PRODUCT =====
            async editProduct(productId) {
                try {
                    this.showProgress('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', '');
                    
                    const snapshot = await this.db.ref('products/' + productId).once('value');
                    const product = snapshot.val();
                    
                    if (!product) {
                        this.showError('Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        this.hideProgress();
                        return;
                    }
                    
                    // Check permissions
                    if (product.uid !== this.userUID && !this.isAdmin) {
                        this.showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
                        this.hideProgress();
                        return;
                    }
                    
                    this.security.logSecurityEvent('PRODUCT_EDIT', 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬', { productId });
                    this.showPublish(product, productId);
                    
                } catch (error) {
                    this.security.logSecurityEvent('EDIT_ERROR', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', { error });
                    this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    this.hideProgress();
                }
            }
            
            // ===== DELETE PRODUCT =====
            async deleteProduct(productId) {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                    return;
                }
                
                try {
                    this.showProgress('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', '');
                    
                    // Verify ownership
                    const snapshot = await this.db.ref('products/' + productId).once('value');
                    const product = snapshot.val();
                    
                    if (!product) {
                        this.showError('Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        this.hideProgress();
                        return;
                    }
                    
                    if (product.uid !== this.userUID && !this.isAdmin) {
                        this.showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
                        this.hideProgress();
                        return;
                    }
                    
                    // Delete the product
                    await this.db.ref('products/' + productId).remove();
                    
                    // Update user's product count
                    if (product.uid) {
                        await this.db.ref('users/' + product.uid).update({
                            totalProducts: firebase.database.ServerValue.increment(-1)
                        });
                    }
                    
                    this.security.logSecurityEvent('PRODUCT_DELETED', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', { productId });
                    
                    this.hideProgress();
                    this.showHome();
                    this.showError('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                    
                } catch (error) {
                    this.security.logSecurityEvent('DELETE_ERROR', 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', { error });
                    this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
                    this.hideProgress();
                }
            }
            
            // ===== UTILITY FUNCTIONS =====
            escapeHTML(str) {
                if (typeof str !== 'string') return str;
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            formatPrice(price) {
                return parseFloat(price).toLocaleString('ar-SA');
            }
            
            showLogin() {
                window.location.href = 'login.html';
            }
            
            showRegister() {
                window.location.href = 'register.html';
            }
            
            viewMyProfile() {
                if (this.userUID) {
                    window.location.href = `profile.html?id=${this.userUID}`;
                } else {
                    this.showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                }
            }
            
            // ===== SIDEBAR FUNCTIONS =====
            toggleSidebar() {
                document.querySelector('.sidebar').classList.toggle('active');
                document.querySelector('.overlay').classList.toggle('active');
            }
            
            closeSidebar() {
                document.querySelector('.sidebar').classList.remove('active');
                document.querySelector('.overlay').classList.remove('active');
            }
        }

        // ===== INITIALIZE APPLICATION =====
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new SecureApplication();
            
            // Prevent any malicious scripts
            Object.freeze(window.app);
            Object.seal(window.app);
            
            // Set security headers
            const meta = document.createElement('meta');
            meta.httpEquiv = 'X-Content-Type-Options';
            meta.content = 'nosniff';
            document.head.appendChild(meta);
            
            // Add security headers for API requests
            if (window.Headers) {
                const originalFetch = window.fetch;
                window.fetch = function(...args) {
                    const [resource, config = {}] = args;
                    config.headers = {
                        ...config.headers,
                        'X-Content-Type-Options': 'nosniff',
                        'X-Frame-Options': 'DENY',
                        'Referrer-Policy': 'strict-origin-when-cross-origin'
                    };
                    return originalFetch.call(this, resource, config);
                };
            }
        });

        // ===== GLOBAL FUNCTIONS (LIMITED ACCESS) =====
        window.toggleSidebar = () => app?.toggleSidebar();
        window.closeSidebar = () => app?.closeSidebar();
        window.closeDetails = () => app?.closeDetails();
    </script>
</body>
</html>
