<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ===== */
.verified-badge {
  background: #10b981;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.product-status {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

.status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.status-sold { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

.admin-badge {
  background: #8b5cf6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.security-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  text-align: center;
}

.session-timeout {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(245, 158, 11, 0.9);
  color: #000;
  padding: 10px 15px;
  border-radius: 6px;
  z-index: 2000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* ===== Ø²Ø± Ø­Ø³Ø§Ø¨ÙŠ ===== */
.myaccount-btn {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
  border: none;
  color: #000;
  font-size: 16px;
  cursor: pointer;
  border-radius: 6px;
  text-align: center;
  margin-top: 5px;
  font-weight: bold;
  transition: transform 0.2s;
}

.myaccount-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    
    <!-- Ø²Ø± Ø­Ø³Ø§Ø¨ÙŠ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† -->
    <button id="myAccountButton" class="myaccount-btn" onclick="showMyAccount()" style="display:none;">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</button>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Session Timeout Warning -->
<div class="session-timeout" id="sessionTimeout">
  <span id="timeoutMessage">Ø³ØªÙ†ØªÙ‡ÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„ Ø®Ù„Ø§Ù„ <span id="timeoutTimer">60</span> Ø«Ø§Ù†ÙŠØ©</span>
  <button onclick="extendSession()" style="
    background: #000;
    color: #f59e0b;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 10px;
    cursor: pointer;
    font-size: 12px;
  ">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const analytics = firebase.analytics();

// Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¬Ù‡ÙˆÙ„Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
auth.signInAnonymously().catch(err => {
    console.error("Anonymous auth error:", err);
    showSecurityWarning("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
});

let userUID = null;
auth.onAuthStateChanged(u => {
    if (u) {
        userUID = u.uid;
        // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (u.email) {
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
            db.ref("users/" + u.uid).update({
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }
});

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];
let budget = null;

/* ===== Pagination Variables ===== */
let currentPage = 1;
const postsPerPage = 6;

// ===== Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
let sessionTimeout = null;
let sessionWarning = null;
const SESSION_DURATION = 60 * 60 * 1000; // 60 Ø¯Ù‚ÙŠÙ‚Ø©
const SESSION_WARNING = 5 * 60 * 1000; // ØªØ­Ø°ÙŠØ± Ù‚Ø¨Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† =====
function showSecurityWarning(message) {
    const content = document.getElementById('content');
    if (content) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'security-warning';
        warningDiv.innerHTML = `âš ï¸ ${message}`;
        content.insertBefore(warningDiv, content.firstChild);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            warningDiv.style.opacity = '0';
            setTimeout(() => warningDiv.remove(), 500);
        }, 5000);
    }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
function initSessionManagement() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‡Ù„Ø© Ø¹Ù†Ø¯ Ø£ÙŠ Ù†Ø´Ø§Ø·
    ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
        document.addEventListener(event, resetSessionTimer);
    });
    
    // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
    resetSessionTimer();
}

function resetSessionTimer() {
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ù‡Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (sessionTimeout) clearTimeout(sessionTimeout);
    if (sessionWarning) clearTimeout(sessionWarning);
    
    // Ø¥Ø®ÙØ§Ø¡ ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ù‡Ù„Ø©
    document.getElementById('sessionTimeout').style.display = 'none';
    
    // ØªØ¹ÙŠÙŠÙ† ØªØ­Ø°ÙŠØ± Ù‚Ø¨Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    sessionWarning = setTimeout(() => {
        showSessionWarning();
    }, SESSION_DURATION - SESSION_WARNING);
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    sessionTimeout = setTimeout(() => {
        handleSessionTimeout();
    }, SESSION_DURATION);
}

function showSessionWarning() {
    const timeoutDiv = document.getElementById('sessionTimeout');
    const timerSpan = document.getElementById('timeoutTimer');
    
    let secondsLeft = SESSION_WARNING / 1000;
    timerSpan.textContent = secondsLeft;
    timeoutDiv.style.display = 'block';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
    const countdown = setInterval(() => {
        secondsLeft--;
        timerSpan.textContent = secondsLeft;
        
        if (secondsLeft <= 0) {
            clearInterval(countdown);
        }
    }, 1000);
}

function extendSession() {
    resetSessionTimer();
    showSecurityWarning("ØªÙ… ØªÙˆØ³ÙŠØ¹ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.");
}

function handleSessionTimeout() {
    if (currentUser && !currentUser.isAnonymous) {
        // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        auth.signOut().then(() => {
            showSecurityWarning("Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.");
            showHome();
            updateAuthUI();
        });
    }
    // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ÙŠÙ†ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    else {
        window.location.reload();
    }
}

// ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø­Ø³Ø§Ø¨ÙŠ =====
function showMyAccount() {
    if (currentUser && !currentUser.isAnonymous) {
        window.location.href = 'myaccount.html';
    } else {
        showSecurityWarning("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø­Ø³Ø§Ø¨Ùƒ");
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
    }
}

// Sidebar
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}
function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function showHome(){
  closeSidebar();
  document.getElementById("content").innerHTML = `
    <div class="search-bar">
      <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
      <select id="cat" onchange="loadProducts()">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
        ${categories.map(c=>`<option>${c}</option>`).join("")}
      </select>
      <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
    </div>
    <div class="cards" id="products"></div>
    <div id="pagination" style="text-align:center;margin:20px"></div>
  `;
  loadProducts();
}

// Budget Dialog
function showBudgetDialog(){ document.getElementById("budgetDialog").style.display="block"; }
function closeBudget(){ document.getElementById("budgetDialog").style.display="none"; }
function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
  if (isNaN(val) || val < 0) {
    showSecurityWarning("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");
    return;
  }
  
  if (val > 10000000) {
    showSecurityWarning("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");
    return;
  }
  
  budget = val;
  closeBudget();
  loadProducts();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function loadProducts(){
  const s = document.getElementById("search").value.toLowerCase();
  const c = document.getElementById("cat").value;

  db.ref("products").once("value", snap=>{
    const d = snap.val() || {};
    let htmlCards = [];

    Object.keys(d).forEach(k=>{
      const p = d[k];
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
      if (!p || !p.name || !p.price) {
        return; // ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©
      }
      
      const price = parseFloat(p.price) || 0;
      if((!c || p.category===c) && p.name.toLowerCase().includes(s)){
        if(budget && price > budget) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬
        const status = p.status || 'available';
        let statusBadge = '';
        if (status !== 'available') {
          statusBadge = `<div class="product-status status-${status}">${getStatusText(status)}</div>`;
        }
        
        // ===== Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø¹ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ =====
        const sellerSection = userDisplayName ? 
          `<div class="seller">
            ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">${p.seller}</span> 
            ${p.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
            | â˜ ${maskPhoneNumber(p.phone)}
            <br><small style="color:#9ca3af; font-size:11px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
          </div>` :
          `<div class="seller">
            ğŸ‘¤ ${p.seller} | â˜ ${maskPhoneNumber(p.phone)}
          </div>`;
        
        htmlCards.push({uid:p.uid,key:k,html:`
          <div class="card" onclick="showDetails('${k}')">
            <h3>${escapeHTML(p.name)}</h3>
            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
            ${statusBadge}
            <div class="meta">
              <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
            </div>
            ${sellerSection}
            <div class="actions">
              ${(p.uid===userUID || isAdmin)?`
              <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
            </div>
          </div>
        `});
      }
    });

    if(userUID){
      htmlCards = htmlCards.sort((a,b)=> b.uid===userUID ? 1 : -1);
    }

    const totalPages = Math.ceil(htmlCards.length / postsPerPage);
    if(currentPage > totalPages) currentPage = 1;
    const start = (currentPage-1)*postsPerPage;
    const pageItems = htmlCards.slice(start, start+postsPerPage);

    let finalHTML = pageItems.map(p=>p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    document.getElementById("products").innerHTML = finalHTML;

    renderPagination(totalPages);
  }).catch(error => {
    console.error("Error loading products:", error);
    document.getElementById("products").innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
  });
}

// Render Pagination Buttons
function renderPagination(total){
  let html = "";
  for(let i=1;i<=total;i++){
    html += `
      <button onclick="goPage(${i})"
        style="
          margin:3px;
          padding:6px 10px;
          border-radius:5px;
          border:none;
          cursor:pointer;
          background:${i===currentPage?'#38bdf8':'#1f2937'};
          color:${i===currentPage?'#000':'#fff'};
        ">
        ${i}
      </button>`;
  }
  document.getElementById("pagination").innerHTML = html;
}

function goPage(p){
  currentPage = p;
  loadProducts();
}

// Ø­Ø°Ù / ØªØ¹Ø¯ÙŠÙ„ / Ù†Ø´Ø±
function deleteProduct(k){ 
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
    return;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  db.ref("products/" + k).once('value', (snapshot) => {
    const product = snapshot.val();
    if (!product) {
      showSecurityWarning("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      showSecurityWarning("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    if (product.uid) {
      db.ref('users/' + product.uid).once('value', (userSnapshot) => {
        const userData = userSnapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          if (currentCount > 0) {
            db.ref('users/' + product.uid).update({
              totalProducts: currentCount - 1
            });
          }
        }
      });
    }
    
    // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬
    db.ref("products/"+k).remove().then(() => {
      showSecurityWarning("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
      loadProducts();
      
      // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø°Ù
      if (userUID) {
        db.ref("userActivity/" + userUID).push().set({
          type: 'product_deleted',
          productId: k,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }).catch(error => {
      console.error("Delete error:", error);
      showSecurityWarning("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    });
  });
}

function editProduct(k){ 
  db.ref("products/"+k).once("value", s => {
    const product = s.val();
    if (!product) {
      showSecurityWarning("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    if (product.uid !== userUID && !isAdmin) {
      showSecurityWarning("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    showPublish(product, k);
  });
}

// ===== ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© showPublish Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function showPublish(p=null,k=null){
  closeSidebar();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù„Ù†Ø´Ø±
  if (!userUID && !currentUser) {
    const publishAnyway = confirm("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„ØŸ (Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø³ÙŠØ­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬)");
    if (!publishAnyway) {
      showHome();
      return;
    }
  }
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹
  const sellerName = userDisplayName || (p ? p.seller : "");
  const sellerField = userDisplayName ? 
    `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
     <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
    `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" maxlength="30">`;
  
  document.getElementById("content").innerHTML = `
    <div class="form-box">
      <h2>${p?"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†":"Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p?escapeHTML(p.name):""}" maxlength="50" required>
      <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p?p.price:""}" min="0" max="10000000" required>
      <select id="category">${categories.map(c=>`<option ${p&&p.category===c?"selected":""}>${c}</option>`).join("")}</select>
      ${sellerField}
      <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p?p.phone:""}" pattern="[0][0-9]{10}" required>
      <small style="color:#9ca3af; font-size:12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…</small>
      <select id="province">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
        ${provinces.map(pr=>`<option ${p&&p.province===pr?"selected":""}>${pr}</option>`).join("")}
      </select>
      <select id="delivery">
        <option value="Ù†Ø¹Ù…" ${p&&p.delivery==="Ù†Ø¹Ù…"?"selected":""}>Ù†Ø¹Ù…</option>
        <option value="Ù„Ø§" ${p&&p.delivery==="Ù„Ø§"?"selected":""}>Ù„Ø§</option>
      </select>
      <select id="status" ${isAdmin || (p && p.uid === userUID) ? '' : 'disabled'}>
        <option value="available" ${p&&p.status==="available"?"selected":""}>Ù…ØªØ§Ø­</option>
        <option value="sold" ${p&&p.status==="sold"?"selected":""}>Ù…Ø¨Ø§Ø¹</option>
        <option value="reserved" ${p&&p.status==="reserved"?"selected":""}>Ù…Ø­Ø¬ÙˆØ²</option>
      </select>
      <small style="color:#9ca3af; font-size:12px;">${isAdmin ? 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†' : 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±'}</small>
      <button onclick="save('${k||""}')">ğŸ’¾ ${p?"ØªØ­Ø¯ÙŠØ«":"Ù†Ø´Ø±"}</button>
      ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
    </div>`;
}

function save(k){
  const name = document.getElementById("name").value.trim();
  const price = document.getElementById("price").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const province = document.getElementById("province").value;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (!name || !price || !phone || !province) {
    showSecurityWarning("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }
  
  if (name.length < 3 || name.length > 50) {
    showSecurityWarning("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
    return;
  }
  
  const priceNum = parseFloat(price);
  if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
    showSecurityWarning("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
    return;
  }
  
  if(!/^[0][0-9]{10}$/.test(phone)){
    alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±.");
    return;
  }
  
  if (!province) {
    showSecurityWarning("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
    return;
  }

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
  const seller = userDisplayName || document.getElementById("seller").value.trim();
  
  if (!seller || seller.length < 2) {
    showSecurityWarning("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
    return;
  }

  const data = {
    name: name,
    price: priceNum,
    category: document.getElementById("category").value,
    seller: seller,
    phone: phone,
    province: province,
    delivery: document.getElementById("delivery").value,
    status: document.getElementById("status").value || "available",
    uid: userUID,
    lastUpdated: firebase.database.ServerValue.TIMESTAMP
  };
  
  // Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
  if (!k) {
    data.createdAt = firebase.database.ServerValue.TIMESTAMP;
    data.timestamp = firebase.database.ServerValue.TIMESTAMP;
  }
  
  const ref = k ? db.ref("products/"+k) : db.ref("products").push();
  
  ref.set(data).then(() => {
    // ===== ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·) =====
    if (!k && userUID) {
      db.ref('users/' + userUID).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          db.ref('users/' + userUID).update({
            totalProducts: currentCount + 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        } else {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§
          db.ref('users/' + userUID).update({
            totalProducts: 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
    if (userUID) {
      const activityType = k ? 'product_updated' : 'product_created';
      db.ref("userActivity/" + userUID).push().set({
        type: activityType,
        productId: k || ref.key,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    showSecurityWarning(k ? "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
    showHome();
  }).catch(error => {
    console.error("Error saving product:", error);
    showSecurityWarning("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  });
}

// Product Details
function showDetails(k){
  db.ref("products/"+k).once("value",snap=>{
    const p = snap.val();
    if(!p) {
      showSecurityWarning("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
      return;
    }
    
    // ===== Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© =====
    const sellerWithLink = userDisplayName ? 
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">${p.seller}</span>
       ${p.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}</p>
       <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${p.seller} ${p.isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}</p>`;
    
    const statusText = p.status ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${p.status}">${getStatusText(p.status)}</span></p>` : '';
    
    document.getElementById("detailsContent").innerHTML = `
      <h2>${escapeHTML(p.name)}</h2>
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      ${statusText}
      ${sellerWithLink}
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${maskPhoneNumber(p.phone)}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
      ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
      ${isAdmin ? `<p style="color:#8b5cf6; font-size:12px; margin-top:10px;">Ø§Ù„Ù…Ø¹Ø±Ù: ${k}</p>` : ""}
    `;
    document.getElementById("detailsDialog").style.display="block";
  }).catch(error => {
    console.error("Error loading details:", error);
    showSecurityWarning("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
  });
}

function closeDetails(){
  document.getElementById("detailsDialog").style.display="none";
}

// ===== Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
  const authSection = document.getElementById("authSection");
  const myAccountButton = document.getElementById("myAccountButton");
  
  if (!authSection) return;
  
  if (currentUser && userDisplayName) {
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
    db.ref("users/" + currentUser.uid).once("value", snapshot => {
      const userData = snapshot.val();
      const displayName = userData ? (userData.fullName || userDisplayName) : userDisplayName;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
      isAdmin = userData && userData.isAdmin === true;
      
      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      authSection.innerHTML = `
        <div class="user-info">
          <p class="profile-link" onclick="viewMyProfile()">
            ğŸ‘¤ ${displayName}
            ${isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
            ${userData && userData.isVerified ? '<span class="verified-badge">âœ“</span>' : ''}
          </p>
          <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
          <small style="color:#9ca3af; font-size:11px; display:block; margin:5px 0;">${userData ? userData.totalProducts || 0 : 0} Ø¥Ø¹Ù„Ø§Ù†</small>
          <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          ${isAdmin ? `
          <button onclick="showAdminPanel()" style="
            width: 100%;
            padding: 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
          ">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>` : ''}
        </div>
      `;
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø­Ø³Ø§Ø¨ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·
      if (myAccountButton && !currentUser.isAnonymous) {
        myAccountButton.style.display = "block";
      }
    });
  } else {
    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
    authSection.innerHTML = `
      <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <div style="color:#9ca3af; font-size:12px; text-align:center; padding:10px;">
        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØªÙŠØ­ Ù„Ùƒ:
        <div style="font-size:11px; margin-top:5px;">
          âœ“ Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ<br>
          âœ“ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†<br>
          âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ<br>
          âœ“ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ùƒ
        </div>
      </div>
    `;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø­Ø³Ø§Ø¨ÙŠ
    if (myAccountButton) {
      myAccountButton.style.display = "none";
    }
  }
}

function logoutUser() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
    auth.signOut()
      .then(() => {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        updateAuthUI();
        showHome();
        showSecurityWarning("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      })
      .catch((error) => {
        console.error("Logout error:", error);
        showSecurityWarning("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      });
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
function viewProfile(userId, sellerName) {
  // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
  if (sellerName) {
    localStorage.setItem('profileSellerName', sellerName);
  }
  
  // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
  window.location.href = `profile.html?id=${userId}`;
}

function viewMyProfile() {
  if (currentUser && currentUser.uid) {
    window.location.href = `myaccount.html`;
  } else {
    alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    window.location.href = 'login.html';
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function maskPhoneNumber(phone) {
  if (!phone || phone.length !== 11) return phone;
  return phone.substring(0, 4) + '****' + phone.substring(8);
}

function formatPrice(price) {
  return parseInt(price).toLocaleString('ar-SA');
}

function getStatusText(status) {
  const statuses = {
    'available': 'Ù…ØªØ§Ø­',
    'sold': 'Ù…Ø¨Ø§Ø¹',
    'reserved': 'Ù…Ø­Ø¬ÙˆØ²'
  };
  return statuses[status] || status;
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    userUID = user.uid;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø£Ù… Ù…Ø¬Ù‡ÙˆÙ„
    if (user.email) {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      db.ref("users/" + user.uid).once("value", snapshot => {
        const userData = snapshot.val();
        if (userData) {
          userDisplayName = userData.username;
          userFullName = userData.fullName;
          isAdmin = userData.isAdmin === true;
          updateAuthUI();
          
          // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
          db.ref("users/" + user.uid).update({
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    } else {
      // Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„
      userDisplayName = "Ø²Ø§Ø¦Ø±";
      updateAuthUI();
    }
  } else {
    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
    currentUser = null;
    userDisplayName = null;
    userFullName = null;
    isAdmin = false;
    updateAuthUI();
  }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
  showHome();
  updateAuthUI();
  initSessionManagement();
  
  // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ù‡Ø¬Ù…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ù†ØµÙŠØ©
  document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    e.preventDefault();
  });
  
  // Ù…Ù†Ø¹ ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
      e.preventDefault();
    }
  });
});
</script>
</body>
</html>
