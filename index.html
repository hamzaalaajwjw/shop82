<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ===== */
.verified-badge {
  background: #10b981;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.product-status {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

.status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.status-sold { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

.admin-badge {
  background: #8b5cf6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.security-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  text-align: center;
}

.session-timeout {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(245, 158, 11, 0.9);
  color: #000;
  padding: 10px 15px;
  border-radius: 6px;
  z-index: 2000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===== */
.notification-bell {
  position: relative;
  cursor: pointer;
  margin-left: 15px;
  font-size: 20px;
}

.notification-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notification-dropdown {
  position: absolute;
  top: 40px;
  right: 0;
  background: #0f1115;
  border: 1px solid #374151;
  border-radius: 8px;
  width: 300px;
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.notification-item {
  padding: 12px;
  border-bottom: 1px solid #374151;
  cursor: pointer;
}

.notification-item:hover {
  background: #1f2937;
}

.notification-item.unread {
  background: rgba(59, 130, 246, 0.1);
}

.notification-title {
  font-weight: bold;
  color: #e5e7eb;
  margin-bottom: 4px;
}

.notification-time {
  font-size: 12px;
  color: #9ca3af;
}

.mark-all-read {
  padding: 10px;
  text-align: center;
  color: #38bdf8;
  cursor: pointer;
  border-top: 1px solid #374151;
}

.mark-all-read:hover {
  background: #1f2937;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙØ¶Ù„Ø© ===== */
.favorite-btn {
  background: transparent;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 18px;
  transition: color 0.2s;
}

.favorite-btn:hover {
  color: #ef4444;
}

.favorite-btn.active {
  color: #ef4444;
}

.favorite-indicator {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 10px;
  z-index: 1;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ===== */
.advanced-search-panel {
  background: #111318;
  padding: 15px;
  border-radius: 8px;
  margin-top: 10px;
  border: 1px solid #374151;
}

.price-range {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

.price-input {
  flex: 1;
  padding: 8px;
  background: #1f2937;
  border: 1px solid #374151;
  color: #e5e7eb;
  border-radius: 4px;
}

.sort-options {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin: 10px 0;
}

.sort-btn {
  padding: 8px;
  background: #1f2937;
  border: 1px solid #374151;
  color: #e5e7eb;
  border-radius: 4px;
  cursor: pointer;
}

.sort-btn.active {
  background: #38bdf8;
  color: #000;
}

.filter-tag {
  display: inline-flex;
  align-items: center;
  background: #374151;
  padding: 4px 8px;
  border-radius: 12px;
  margin: 2px;
  font-size: 12px;
}

.filter-tag button {
  background: none;
  border: none;
  color: #9ca3af;
  margin-right: 4px;
  cursor: pointer;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ===== */
.rating-stars {
  color: #f59e0b;
  font-size: 14px;
}

.rating-value {
  color: #9ca3af;
  font-size: 12px;
  margin-right: 5px;
}

.rating-widget {
  display: flex;
  align-items: center;
  gap: 5px;
  margin: 5px 0;
}

.star {
  font-size: 20px;
  color: #4b5563;
  cursor: pointer;
  transition: color 0.2s;
}

.star:hover,
.star.active {
  color: #f59e0b;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
.stat-box {
  background: #111318;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid #374151;
}

.stat-number {
  font-size: 24px;
  font-weight: bold;
  color: #38bdf8;
}

.stat-label {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 5px;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ===== */
.featured-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: bold;
  z-index: 1;
}

.premium-card {
  border: 2px solid #f59e0b;
  position: relative;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ===== */
.chat-bubble {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: #10b981;
  color: white;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 999;
}

.chat-window {
  position: fixed;
  bottom: 90px;
  left: 20px;
  width: 350px;
  height: 450px;
  background: #0f1115;
  border-radius: 12px;
  border: 1px solid #374151;
  z-index: 1000;
  display: none;
  flex-direction: column;
}

.chat-header {
  background: #1f2937;
  padding: 15px;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}

.chat-input {
  padding: 15px;
  background: #1f2937;
  border-radius: 0 0 12px 12px;
  display: flex;
  gap: 10px;
}

.chat-input input {
  flex: 1;
  padding: 10px;
  background: #374151;
  border: 1px solid #4b5563;
  color: #e5e7eb;
  border-radius: 20px;
}

.message {
  margin-bottom: 10px;
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 80%;
}

.message.sent {
  background: #38bdf8;
  color: #000;
  margin-left: auto;
}

.message.received {
  background: #374151;
  color: #e5e7eb;
  margin-right: auto;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
  <!-- Ø¥Ø¶Ø§ÙØ© Ø¬Ø±Ø³ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
  <div class="notification-bell" onclick="toggleNotifications()">
    ğŸ””
    <span class="notification-count" id="notificationCount" style="display:none">0</span>
    <div class="notification-dropdown" id="notificationDropdown">
      <div id="notificationList"></div>
      <div class="mark-all-read" onclick="markAllNotificationsRead()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒØ§ÙØ© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©</div>
    </div>
  </div>
</header>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    <button onclick="showFavorites()">â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</button>
    <button onclick="showStatistics()">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Session Timeout Warning -->
<div class="session-timeout" id="sessionTimeout">
  <span id="timeoutMessage">Ø³ØªÙ†ØªÙ‡ÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„ Ø®Ù„Ø§Ù„ <span id="timeoutTimer">60</span> Ø«Ø§Ù†ÙŠØ©</span>
  <button onclick="extendSession()" style="
    background: #000;
    color: #f59e0b;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 10px;
    cursor: pointer;
    font-size: 12px;
  ">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª</button>
</div>

<!-- Chat Bubble -->
<div class="chat-bubble" onclick="toggleChat()" id="chatBubble">ğŸ’¬</div>

<!-- Chat Window -->
<div class="chat-window" id="chatWindow">
  <div class="chat-header">
    <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
    <button onclick="toggleChat()" style="background:none;border:none;color:#9ca3af;cursor:pointer">âœ•</button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="handleChatKeyPress(event)">
    <button onclick="sendChatMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const analytics = firebase.analytics();

// Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¬Ù‡ÙˆÙ„Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
auth.signInAnonymously().catch(err => {
    console.error("Anonymous auth error:", err);
    showSecurityWarning("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
});

let userUID = null;
auth.onAuthStateChanged(u => {
    if (u) {
        userUID = u.uid;
        // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (u.email) {
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
            db.ref("users/" + u.uid).update({
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }
});

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];
let budget = null;

/* ===== Pagination Variables ===== */
let currentPage = 1;
const postsPerPage = 6;

// ===== Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
let sessionTimeout = null;
let sessionWarning = null;
const SESSION_DURATION = 60 * 60 * 1000; // 60 Ø¯Ù‚ÙŠÙ‚Ø©
const SESSION_WARNING = 5 * 60 * 1000; // ØªØ­Ø°ÙŠØ± Ù‚Ø¨Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© =====
let userFavorites = [];
let notifications = [];
let advancedFilters = {};
let currentChatUser = null;

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† =====
function showSecurityWarning(message) {
    const content = document.getElementById('content');
    if (content) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'security-warning';
        warningDiv.innerHTML = `âš ï¸ ${message}`;
        content.insertBefore(warningDiv, content.firstChild);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            warningDiv.style.opacity = '0';
            setTimeout(() => warningDiv.remove(), 500);
        }, 5000);
    }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
function initSessionManagement() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‡Ù„Ø© Ø¹Ù†Ø¯ Ø£ÙŠ Ù†Ø´Ø§Ø·
    ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
        document.addEventListener(event, resetSessionTimer);
    });
    
    // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
    resetSessionTimer();
}

function resetSessionTimer() {
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ù‡Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (sessionTimeout) clearTimeout(sessionTimeout);
    if (sessionWarning) clearTimeout(sessionWarning);
    
    // Ø¥Ø®ÙØ§Ø¡ ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ù‡Ù„Ø©
    document.getElementById('sessionTimeout').style.display = 'none';
    
    // ØªØ¹ÙŠÙŠÙ† ØªØ­Ø°ÙŠØ± Ù‚Ø¨Ù„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    sessionWarning = setTimeout(() => {
        showSessionWarning();
    }, SESSION_DURATION - SESSION_WARNING);
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    sessionTimeout = setTimeout(() => {
        handleSessionTimeout();
    }, SESSION_DURATION);
}

function showSessionWarning() {
    const timeoutDiv = document.getElementById('sessionTimeout');
    const timerSpan = document.getElementById('timeoutTimer');
    
    let secondsLeft = SESSION_WARNING / 1000;
    timerSpan.textContent = secondsLeft;
    timeoutDiv.style.display = 'block';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
    const countdown = setInterval(() => {
        secondsLeft--;
        timerSpan.textContent = secondsLeft;
        
        if (secondsLeft <= 0) {
            clearInterval(countdown);
        }
    }, 1000);
}

function extendSession() {
    resetSessionTimer();
    showSecurityWarning("ØªÙ… ØªÙˆØ³ÙŠØ¹ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.");
}

function handleSessionTimeout() {
    if (currentUser && !currentUser.isAnonymous) {
        // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        auth.signOut().then(() => {
            showSecurityWarning("Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.");
            showHome();
            updateAuthUI();
        });
    }
    // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ÙŠÙ†ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    else {
        window.location.reload();
    }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© =====
function loadUserFavorites() {
    if (!userUID) return;
    
    db.ref(`userFavorites/${userUID}`).on('value', (snapshot) => {
        userFavorites = [];
        const data = snapshot.val();
        if (data) {
            userFavorites = Object.keys(data);
        }
    });
}

function toggleFavorite(productId) {
    if (!userUID) {
        showSecurityWarning("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…ÙØ¶Ù„Ø©");
        return;
    }
    
    const isFavorite = userFavorites.includes(productId);
    const favoriteRef = db.ref(`userFavorites/${userUID}/${productId}`);
    
    if (isFavorite) {
        favoriteRef.remove();
        showSecurityWarning("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©");
    } else {
        favoriteRef.set({
            addedAt: firebase.database.ServerValue.TIMESTAMP
        });
        showSecurityWarning("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©");
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        sendNotification('Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©');
    }
}

function showFavorites() {
    if (!userUID) {
        showSecurityWarning("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØ¶Ù„Ø©");
        return;
    }
    
    closeSidebar();
    document.getElementById("content").innerHTML = `
        <div class="form-box">
            <h2>â¤ï¸ Ù‚Ø§Ø¦Ù…ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©</h2>
            <div id="favoritesList" class="cards"></div>
        </div>
    `;
    
    loadFavoritesList();
}

function loadFavoritesList() {
    const favoritesList = document.getElementById('favoritesList');
    if (!favoritesList) return;
    
    if (userFavorites.length === 0) {
        favoritesList.innerHTML = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©</p>';
        return;
    }
    
    // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©
    const productPromises = userFavorites.map(productId => 
        db.ref(`products/${productId}`).once('value')
    );
    
    Promise.all(productPromises).then(snapshots => {
        let html = '';
        snapshots.forEach((snapshot, index) => {
            const product = snapshot.val();
            if (product) {
                const status = product.status || 'available';
                let statusBadge = '';
                if (status !== 'available') {
                    statusBadge = `<div class="product-status status-${status}">${getStatusText(status)}</div>`;
                }
                
                html += `
                    <div class="card" onclick="showDetails('${userFavorites[index]}')">
                        <div class="favorite-indicator">Ù…ÙØ¶Ù„</div>
                        <button class="favorite-btn active" onclick="toggleFavorite('${userFavorites[index]}'); event.stopPropagation()">â¤ï¸</button>
                        <h3>${escapeHTML(product.name)}</h3>
                        <span class="price">${formatPrice(product.price)} Ø¯.Ø¹</span>
                        ${statusBadge}
                        <div class="meta">
                            <span>${product.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            <span>${product.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            <span>ØªÙˆØµÙŠÙ„: ${product.delivery || 'Ù„Ø§'}</span>
                        </div>
                        <div class="seller">
                            ğŸ‘¤ ${product.seller} | â˜ ${maskPhoneNumber(product.phone)}
                        </div>
                    </div>
        
