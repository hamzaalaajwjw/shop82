
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A3len | المحادثات</title>
<style>
body{margin:0;font-family:'Roboto',sans-serif;background:#ecf0f1;}
header{background:#3498db;color:#fff;padding:15px;text-align:center;font-size:22px;box-shadow:0 3px 5px rgba(0,0,0,0.1);}
.container{display:flex;max-width:1200px;margin:20px auto;gap:20px;}
#chatList{flex:1;background:#fff;border-radius:10px;padding:15px;height:600px;overflow-y:auto;box-shadow:0 5px 10px rgba(0,0,0,0.05);}
#messagesContainer{flex:2;display:flex;flex-direction:column;background:#fff;border-radius:10px;padding:15px;height:600px;box-shadow:0 5px 10px rgba(0,0,0,0.05);}
#messages{flex:1;overflow-y:auto;border:1px solid #ccc;border-radius:5px;padding:15px;margin-bottom:10px;}
input,button{padding:10px;border-radius:5px;border:1px solid #ccc;}
button{background:#3498db;color:#fff;border:none;cursor:pointer;transition:0.3s;}
button:hover{background:#2980b9;}
form{display:flex;gap:10px;}
</style>
</head>
<body>
<header>A3len | المحادثات</header>
<div class="container">
<div id="chatList"></div>
<div id="messagesContainer">
<form id="searchForm">
<input type="text" id="searchInput" placeholder="ابحث باسم المستخدم" style="flex:1;">
<button type="submit">بحث</button>
</form>
<div id="messages"></div>
<form id="messageForm">
<input type="text" id="messageInput" placeholder="اكتب رسالة" style="flex:1;">
<button type="submit">إرسال</button>
</form>
<button onclick="logout()" style="margin-top:10px;">تسجيل الخروج</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebaseapp.com",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth();
let currentUser = null;
let currentChatUser = null;

onAuthStateChanged(auth, user=>{
if(user){currentUser=user; loadChats();}
else window.location.href="login.html";
});

function loadChats(){
const userRef = ref(db, 'users/' + currentUser.uid + '/chats');
onValue(userRef,snapshot=>{
const chatList = document.getElementById("chatList");
chatList.innerHTML='';
snapshot.forEach(childSnap=>{
const chatUserId = childSnap.key;
const chatItem = document.createElement('div');
chatItem.textContent = chatUserId;
chatItem.style.cursor = "pointer";
chatItem.style.padding="8px";
chatItem.style.borderBottom="1px solid #ddd";
chatItem.onclick = ()=>{ openChat(chatUserId) };
chatList.appendChild(chatItem);
});
});
}

function openChat(userId){
currentChatUser=userId;
const messagesRef = ref(db,'messages/'+getChatId(currentUser.uid,userId));
onValue(messagesRef,snapshot=>{
const messagesDiv=document.getElementById("messages");
messagesDiv.innerHTML='';
snapshot.forEach(msgSnap=>{
const msg=msgSnap.val();
const msgEl=document.createElement('div');
msgEl.textContent=`${msg.sender}: ${msg.text}`;
msgEl.style.padding="5px 0";
messagesDiv.appendChild(msgEl);
});
});
}

document.getElementById("messageForm").addEventListener('submit', e=>{
e.preventDefault();
if(!currentChatUser)return alert("اختار شخص اول!");
const msgText = document.getElementById("messageInput").value.trim();
if(msgText==='') return;
const messagesRef = ref(db, 'messages/' + getChatId(currentUser.uid,currentChatUser));
push(messagesRef, {sender:currentUser.uid,text:msgText});
set(ref(db, `users/${currentUser.uid}/chats/${currentChatUser}`), {seen:true});
set(ref(db, `users/${currentChatUser}/chats/${currentUser.uid}`), {seen:false});
document.getElementById("messageInput").value='';
});

document.getElementById("searchForm").addEventListener('submit', e=>{
e.preventDefault();
const username=document.getElementById("searchInput").value.trim();
if(username==='') return;
get(child(ref(db),'usernames/'+username)).then(snapshot=>{
if(snapshot.exists()){
openChat(snapshot.val());
}else alert("المستخدم غير موجود");
});
});

function getChatId(uid1,uid2){return uid1<uid2?uid1+'_'+uid2:uid2+'_'+uid1;}
function logout(){signOut(auth).then(()=>window.location.href="login.html");}
</script>
</body>
</html>
