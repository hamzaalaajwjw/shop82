<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ===== */
body, input, select, button, textarea { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ===== Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ø³Ø·Ø© ===== */
.verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    background: #e8f5e9;
    color: #2e7d32;
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 10px;
    margin-right: 4px;
    font-weight: 500;
}

.verified-badge img {
    width: 12px;
    height: 12px;
}

.user-name-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ===== */
.budget-btn {
    margin-left: 10px;
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 6px;
    font-weight: 500;
}

.budget-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    color: #333;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    border: 1px solid #ddd;
    max-width: 90%;
    width: 350px;
}

.budget-dialog input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    font-size: 16px;
}

.budget-dialog button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: #007bff;
    color: white;
    cursor: pointer;
    font-weight: 500;
}

.budget-dialog .close-btn { 
    background: #dc3545; 
    margin-left: 8px; 
    color: white;
}

/* ===== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ===== */
.details-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    color: #333;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1001;
    display: none;
    width: 90%;
    max-width: 450px;
    border: 1px solid #ddd;
}

.details-dialog h2 { 
    margin-top: 0; 
    color: #007bff;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.details-dialog button { 
    margin-top: 15px; 
    padding: 10px; 
    border: none; 
    border-radius: 6px; 
    background: #007bff; 
    color: white; 
    cursor: pointer; 
    font-weight: 500;
    width: 100%;
}

/* ===== Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
    margin-top: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
}

.user-info { 
    padding: 12px; 
    background: #f8f9fa; 
    border-radius: 8px; 
    text-align: center; 
    margin-top: auto; 
    border: 1px solid #dee2e6;
}

.user-info p { 
    margin: 0; 
    color: #007bff; 
    font-weight: bold; 
    margin-bottom: 4px; 
    font-size: 15px;
}

.logout-btn { 
    width: 100%; 
    padding: 8px; 
    background: #dc3545; 
    color: white; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 14px; 
    font-weight: 500;
}

.auth-btn { 
    width: 100%; 
    padding: 10px; 
    background: #f8f9fa; 
    border: 1px solid #dee2e6; 
    color: #333; 
    font-size: 15px; 
    cursor: pointer; 
    border-radius: 6px; 
    text-align: center; 
    font-weight: 500;
}

/* ===== Ø±ÙˆØ§Ø¨Ø· ===== */
.seller-link {
    color: #007bff;
    cursor: pointer;
    text-decoration: underline;
    font-weight: 500;
}

.profile-link {
    color: #007bff;
    cursor: pointer;
}

/* ===== Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ===== */
.product-status {
    font-size: 12px;
    padding: 5px 10px;
    border-radius: 4px;
    margin-top: 5px;
    display: inline-block;
    font-weight: 500;
    border: 1px solid;
}

.status-pending { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}
.status-available { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb;
}
.status-sold { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}
.status-reserved { 
    background: #fff3cd; 
    color: #856404; 
    border-color: #ffeaa7;
}
.status-rejected { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb;
}

.admin-badge {
    background: #6f42c1;
    color: white;
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 8px;
    margin-right: 4px;
    font-weight: 500;
}

.security-warning {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 10px;
    border-radius: 6px;
    margin: 8px 0;
    font-size: 13px;
    text-align: center;
}

/* ===== Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ===== */
.image-upload-container {
    margin: 12px 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.image-preview {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.preview-image {
    width: 150px;
    height: 150px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #ddd;
}

.file-input-label {
    display: inline-block;
    background: #f8f9fa;
    color: #333;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    margin: 5px 0;
    border: 2px dashed #adb5bd;
    width: 100%;
    font-weight: 500;
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ===== */
.product-images {
    margin: 8px 0;
    border-radius: 8px;
    background: #f8f9fa;
}

.slider-image {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 8px;
}

.no-image {
    width: 100%;
    height: 160px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 14px;
    text-align: center;
    padding: 20px;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.topbar {
    display: flex;
    align-items: center;
    background: white;
    padding: 10px 20px;
    border-bottom: 1px solid #dee2e6;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    height: 60px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.menu-toggle {
    font-size: 20px;
    cursor: pointer;
    color: #333;
    margin-left: 10px;
    padding: 8px;
    border-radius: 6px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.logo {
    display: flex;
    align-items: center;
    margin-left: 15px;
}

.logo-image {
    height: 40px;
    width: auto;
    object-fit: contain;
}

.tagline {
    color: #6c757d;
    font-size: 14px;
    margin-right: auto;
    font-weight: 500;
}

/* ===== Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ===== */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
}

.sidebar {
    width: 280px;
    background: white;
    padding: 20px 0;
    position: fixed;
    top: 0;
    right: -300px;
    bottom: 0;
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
    box-shadow: -2px 0 8px rgba(0,0,0,0.1);
    border-left: 1px solid #dee2e6;
}

.sidebar.active {
    right: 0;
}

.sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 20px;
    text-align: center;
}

.sidebar-title {
    color: #007bff;
    font-size: 20px;
    font-weight: bold;
    margin: 0 0 5px 0;
}

.sidebar-subtitle {
    color: #6c757d;
    font-size: 12px;
    margin: 0;
}

.sidebar button {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 85%;
    margin: 10px auto;
    padding: 12px 16px;
    background: #f8f9fa;
    color: #333;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    text-align: right;
    font-size: 15px;
    font-weight: 500;
}

.sidebar button:hover {
    background: #e9ecef;
}

.sidebar .close-btn {
    position: absolute;
    top: 15px;
    left: 15px;
    background: #f8f9fa;
    color: #dc3545;
    border: 1px solid #f5c6cb;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ===== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===== */
main {
    flex: 1;
    padding: 25px;
    width: 100%;
    background: #f8f9fa;
    min-height: calc(100vh - 60px);
    margin-top: 60px;
}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ===== */
.search-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 25px;
    flex-wrap: wrap;
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-bar input {
    flex: 1;
    min-width: 200px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    border-radius: 6px;
    font-size: 15px;
}

.search-bar select {
    padding: 10px 15px;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    border-radius: 6px;
    font-size: 15px;
    min-width: 150px;
    cursor: pointer;
}

/* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
.cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.card h3 {
    margin: 10px 0;
    color: #333;
    font-size: 18px;
    line-height: 1.4;
    font-weight: 600;
}

.price {
    font-size: 20px;
    font-weight: bold;
    color: #007bff;
    display: block;
    margin: 10px 0;
}

.meta {
    display: flex;
    gap: 8px;
    margin: 15px 0;
    font-size: 13px;
    color: #6c757d;
    flex-wrap: wrap;
}

.meta span {
    background: #f8f9fa;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.seller {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
    color: #6c757d;
    font-size: 13px;
    line-height: 1.5;
}

.actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.actions button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
}

.actions .edit {
    background: #ffc107;
    color: white;
}

.actions .del {
    background: #dc3545;
    color: white;
}

.empty {
    text-align: center;
    color: #6c757d;
    font-size: 16px;
    padding: 40px;
    grid-column: 1 / -1;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #dee2e6;
}

/* ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø± ===== */
.form-box {
    max-width: 600px;
    margin: 0 auto;
    padding: 30px;
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.form-box h2 {
    color: #007bff;
    margin-bottom: 25px;
    text-align: center;
    font-size: 24px;
    font-weight: 600;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.form-box input,
.form-box select,
.form-box textarea {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    border-radius: 6px;
    font-size: 15px;
    box-sizing: border-box;
}

.form-box button {
    width: 100%;
    padding: 14px;
    margin: 15px 0;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 500;
}

/* ===== Ø§Ù„ØªØ¬Ø§ÙˆØ¨ ===== */
@media (max-width: 768px) {
    .topbar {
        padding: 8px 12px;
        height: 56px;
    }
    
    .logo-image {
        height: 36px;
    }
    
    .menu-toggle {
        margin-left: 8px;
        width: 36px;
        height: 36px;
    }
    
    .tagline {
        font-size: 12px;
    }
    
    .sidebar {
        width: 85%;
        right: -100%;
    }
    
    .search-bar {
        padding: 15px;
        gap: 10px;
    }
    
    .search-bar input,
    .search-bar select {
        min-width: 100%;
    }
    
    .cards {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .form-box {
        padding: 20px;
        margin: 10px;
    }
    
    main {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .topbar {
        padding: 6px 10px;
        height: 52px;
    }
    
    .logo-image {
        height: 32px;
    }
    
    .menu-toggle {
        font-size: 18px;
    }
    
    .tagline {
        display: none;
    }
    
    main {
        padding: 12px;
    }
    
    .card {
        padding: 15px;
    }
    
    .form-box {
        padding: 15px;
    }
}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ===== */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">
    <img src="img/a3len.png" alt="a3len" class="logo-image">
  </div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-header">
        <h3 class="sidebar-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙØ­</h3>
        <p class="sidebar-subtitle">a3len | Ø³ÙˆÙ‚ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</p>
    </div>
    
    <button onclick="showHome()">
        <span style="margin-left:8px;">ğŸ </span>
        Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </button>
    <button onclick="showPublish()">
        <span style="margin-left:8px;">â•</span>
        Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†
    </button>
    
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ===== ØªÙ‡ÙŠØ¦Ø© Supabase =====
const supabaseUrl = 'https://dnclbdvdzvtdjpgxwnrl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuY2xiZHZkenZ0ZGpwZ3h3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjY5OTcsImV4cCI6MjA4MjgwMjk5N30.alGg61mAPLLqLM2LlQRq2K2o_eOOnJwNuaIJiAXB7Wg';

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
} else {
    firebase.app();
}

const auth = firebase.auth();
const db = firebase.database();

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =====
let userUid = null;
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;
let budget = null;
let currentPage = 1;
const postsPerPage = 6;

const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø© =====
function toggleSidebar() {
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.querySelector(".overlay");
    
    if (sidebar && overlay) {
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
        document.body.style.overflow = sidebar.classList.contains("active") ? "hidden" : "";
    }
}

function closeSidebar() {
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.querySelector(".overlay");
    
    if (sidebar && overlay) {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
        document.body.style.overflow = "";
    }
}

function showHome() {
    closeSidebar();
    
    const content = document.getElementById("content");
    if (!content) return;
    
    content.innerHTML = `
        <div class="search-bar">
            <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
            <select id="cat" onchange="loadProducts()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
            </select>
            <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
        </div>
        <div class="cards" id="products"></div>
        <div id="pagination" style="text-align:center; margin:20px"></div>
    `;
    
    loadProducts();
}

function showBudgetDialog() { 
    const dialog = document.getElementById("budgetDialog");
    if (dialog) {
        dialog.style.display = "block";
        document.body.style.overflow = "hidden";
    }
}

function closeBudget() { 
    const dialog = document.getElementById("budgetDialog");
    if (dialog) {
        dialog.style.display = "none";
        document.body.style.overflow = "";
    }
}

function applyBudget() {
    const input = document.getElementById("maxBudget");
    if (!input) return;
    
    const val = parseFloat(input.value);
    
    if (isNaN(val) || val < 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");
        return;
    }
    
    if (val > 10000000) {
        alert("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");
        return;
    }
    
    budget = val;
    closeBudget();
    loadProducts();
}

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª =====
function loadProducts() {
    const searchInput = document.getElementById("search");
    const catSelect = document.getElementById("cat");
    
    const s = searchInput ? searchInput.value.toLowerCase() : '';
    const c = catSelect ? catSelect.value : '';
    
    const productsContainer = document.getElementById('products');
    if (productsContainer) {
        productsContainer.innerHTML = '<p style="text-align:center; color:#6c757d;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
    }
    
    db.ref("products").once("value", snap => {
        const d = snap.val() || {};
        let htmlCards = [];

        Object.keys(d).forEach(k => {
            const p = d[k];
            
            if (!p || !p.name || !p.price) {
                return;
            }
            
            const price = parseFloat(p.price) || 0;
            
            if ((!c || p.category === c) && p.name.toLowerCase().includes(s)) {
                if (budget && price > budget) return;
                
                let statusBadge = '';
                let statusClass = '';
                let statusText = '';
                
                const actualStatus = p.status2 || 'available';
                
                switch(actualStatus) {
                    case 'available':
                        statusClass = 'status-available';
                        statusText = 'âœ… Ù…ØªØ§Ø­';
                        break;
                    case 'sold':
                        statusClass = 'status-sold';
                        statusText = 'âœ… Ù…Ø¨Ø§Ø¹';
                        break;
                    case 'reserved':
                        statusClass = 'status-reserved';
                        statusText = 'âœ… Ù…Ø­Ø¬ÙˆØ²';
                        break;
                    default:
                        statusClass = 'status-available';
                        statusText = 'âœ… Ù…ØªØ§Ø­';
                }
                
                statusBadge = `<div class="product-status ${statusClass}">${statusText}</div>`;
                
                const sellerSection = userDisplayName ? 
                    `<div class="seller">
                        ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">
                            <span class="user-name-wrapper">
                                ${p.seller}
                            </span>
                        </span> 
                        | â˜ ${p.phone}
                    </div>` :
                    `<div class="seller">
                        ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
                    </div>`;
                
                htmlCards.push({
                    uid: p.uid,
                    key: k,
                    html: `
                        <div class="card" onclick="showDetails('${k}')">
                            <h3>${escapeHTML(p.name)}</h3>
                            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
                            ${statusBadge}
                            <div class="meta">
                                <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
                            </div>
                            ${sellerSection}
                            <div class="actions">
                                ${(p.uid === userUid || isAdmin) ? `
                                <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
                            </div>
                        </div>
                    `
                });
            }
        });

        const totalPages = Math.ceil(htmlCards.length / postsPerPage);
        if (currentPage > totalPages) currentPage = 1;
        const start = (currentPage - 1) * postsPerPage;
        const pageItems = htmlCards.slice(start, start + postsPerPage);

        let finalHTML = pageItems.map(p => p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
        
        if (productsContainer) {
            productsContainer.innerHTML = finalHTML;
            renderPagination(totalPages);
        }
    }).catch(error => {
        console.error("Error loading products:", error);
        if (productsContainer) {
            productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
        }
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
    });
}

function renderPagination(total) {
    let html = "";
    for (let i = 1; i <= total; i++) {
        html += `
            <button onclick="goPage(${i})"
                style="
                    margin: 3px;
                    padding: 6px 12px;
                    border-radius: 6px;
                    border: none;
                    cursor: pointer;
                    background: ${i === currentPage ? '#007bff' : '#f8f9fa'};
                    color: ${i === currentPage ? 'white' : '#333'};
                    font-weight: ${i === currentPage ? 'bold' : 'normal'};
                    border: 1px solid ${i === currentPage ? '#007bff' : '#dee2e6'};
                ">
                ${i}
            </button>`;
    }
    
    const pagination = document.getElementById('pagination');
    if (pagination) {
        pagination.innerHTML = html;
    }
}

function goPage(p) {
    currentPage = p;
    loadProducts();
}

function deleteProduct(k) { 
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
        return;
    }
    
    db.ref("products/" + k).remove().then(() => {
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
        loadProducts();
    }).catch(error => {
        console.error("Delete error:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    });
}

function editProduct(k) { 
    db.ref("products/" + k).once("value", s => {
        const product = s.val();
        if (!product) {
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            return;
        }
        
        if (product.uid !== userUid && !isAdmin) {
            alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
            return;
        }
        
        showPublish(product, k);
    });
}

function showPublish(p = null, k = null) {
    closeSidebar();
    
    const content = document.getElementById("content");
    if (!content) return;
    
    content.innerHTML = `
        <div class="form-box">
            <h2>${p ? "ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†" : "Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
            
            <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p ? escapeHTML(p.name) : ""}" maxlength="50" required>
            <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p ? p.price : ""}" min="0" max="10000000" required>
            <select id="category">${categories.map(c => `<option value="${c}" ${p && p.category === c ? "selected" : ""}>${c}</option>`).join("")}</select>
            <input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${p ? p.seller : userDisplayName || ''}" ${userDisplayName ? 'disabled' : ''} maxlength="30">
            <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p ? p.phone : ""}" pattern="[0][0-9]{10}" required>
            <select id="province">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                ${provinces.map(pr => `<option value="${pr}" ${p && p.province === pr ? "selected" : ""}>${pr}</option>`).join("")}
            </select>
            <select id="delivery">
                <option value="Ù†Ø¹Ù…" ${p && p.delivery === "Ù†Ø¹Ù…" ? "selected" : ""}>Ù†Ø¹Ù…</option>
                <option value="Ù„Ø§" ${p && p.delivery === "Ù„Ø§" ? "selected" : ""}>Ù„Ø§</option>
            </select>
            
            <select id="status" ${isAdmin || (p && p.uid === userUid) ? '' : 'disabled'}>
                <option value="available" ${(p && (p.status2 === "available" || (!p.status2 && p.status === "approved"))) ? "selected" : ""}>Ù…ØªØ§Ø­</option>
                <option value="sold" ${p && p.status2 === "sold" ? "selected" : ""}>Ù…Ø¨Ø§Ø¹</option>
                <option value="reserved" ${p && p.status2 === "reserved" ? "selected" : ""}>Ù…Ø­Ø¬ÙˆØ²</option>
            </select>
            
            <button onclick="saveProduct('${k || ""}')" id="saveBtn">
                ğŸ’¾ ${p ? "ØªØ­Ø¯ÙŠØ«" : "Ù†Ø´Ø±"}
            </button>
            
            ${p ? `<button onclick="showHome()" style="background:#6c757d; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
        </div>`;
}

function saveProduct(k) {
    const name = document.getElementById("name")?.value.trim();
    const price = document.getElementById("price")?.value.trim();
    const phone = document.getElementById("phone")?.value.trim();
    const province = document.getElementById("province")?.value;
    const status = document.getElementById("status")?.value || "available";
    
    if (!name || !price || !phone || !province) {
        alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
    }
    
    if (name.length < 3 || name.length > 50) {
        alert("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
        return;
    }
    
    const priceNum = parseFloat(price);
    if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
        alert("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
        return;
    }
    
    if (!/^[0][0-9]{10}$/.test(phone)) {
        alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
        return;
    }
    
    if (!province) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
        return;
    }

    const seller = userDisplayName || document.getElementById("seller")?.value.trim();
    
    if (!seller || seller.length < 2) {
        alert("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
        return;
    }

    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    saveBtn.disabled = true;
    
    const data = {
        name: name,
        price: priceNum,
        category: document.getElementById("category").value,
        seller: seller,
        phone: phone,
        province: province,
        delivery: document.getElementById("delivery").value,
        status2: status,
        uid: userUid,
        lastUpdated: firebase.database.ServerValue.TIMESTAMP,
        createdAt: k ? undefined : firebase.database.ServerValue.TIMESTAMP
    };
    
    const ref = k ? db.ref("products/" + k) : db.ref("products").push();
    ref.set(data).then(() => {
        alert(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
        showHome();
    }).catch(error => {
        console.error("Error saving product:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    }).finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function showDetails(k) {
    db.ref("products/" + k).once("value", snap => {
        const p = snap.val();
        if (!p) {
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
            return;
        }
        
        const sellerWithLink = userDisplayName ? 
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">${p.seller}</span></p>` :
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${p.seller}</p>`;
        
        const actualStatus = p.status2 || 'available';
        let actualStatusText = '';
        
        switch(actualStatus) {
            case 'available':
                actualStatusText = 'Ù…ØªØ§Ø­';
                break;
            case 'sold':
                actualStatusText = 'Ù…Ø¨Ø§Ø¹';
                break;
            case 'reserved':
                actualStatusText = 'Ù…Ø­Ø¬ÙˆØ²';
                break;
            default:
                actualStatusText = 'Ù…ØªØ§Ø­';
        }
        
        const detailsContent = document.getElementById("detailsContent");
        if (detailsContent) {
            detailsContent.innerHTML = `
                <h2>${escapeHTML(p.name)}</h2>
                <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${actualStatusText}</p>
                <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
                <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                ${sellerWithLink}
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
                <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
            `;
        }
        
        const dialog = document.getElementById("detailsDialog");
        if (dialog) {
            dialog.style.display = "block";
        }
    }).catch(error => {
        console.error("Error loading details:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
    });
}

function closeDetails() {
    const dialog = document.getElementById("detailsDialog");
    if (dialog) {
        dialog.style.display = "none";
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
    const authSection = document.getElementById("authSection");
    
    if (!authSection) return;
    
    if (currentUser && userDisplayName) {
        db.ref("users/" + currentUser.uid).once("value", snapshot => {
            const userData = snapshot.val();
            const displayName = userData ? (userData.fullName || userDisplayName) : userDisplayName;
            isAdmin = userData && userData.isAdmin === true;
            
            authSection.innerHTML = `
                <div class="user-info">
                    <p class="profile-link" onclick="viewMyProfile()">
                        <span class="user-name-wrapper">
                            ${displayName}
                            ${isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
                        </span>
                    </p>
                    <small style="color:#6c757d; font-size:12px;">@${userDisplayName}</small>
                    <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            `;
        });
    } else {
        authSection.innerHTML = `
            <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        `;
    }
}

function logoutUser() {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        auth.signOut()
            .then(() => {
                currentUser = null;
                userDisplayName = null;
                userFullName = null;
                isAdmin = false;
                userUid = null;
                updateAuthUI();
                showHome();
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
            })
            .catch((error) => {
                console.error("Logout error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
            });
    }
}

function viewProfile(userId, sellerName) {
    window.location.href = `profile.html?id=${userId}`;
}

function viewMyProfile() {
    if (currentUser && currentUser.uid) {
        window.location.href = `profile.html?id=${currentUser.uid}`;
    } else {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPrice(price) {
    return parseInt(price).toLocaleString('ar-SA');
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        userUid = user.uid;
        
        db.ref("users/" + user.uid).once("value", snapshot => {
            const userData = snapshot.val();
            if (userData) {
                userDisplayName = userData.username;
                userFullName = userData.fullName;
                isAdmin = userData.isAdmin === true;
                updateAuthUI();
            }
        });
    } else {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        userUid = null;
        updateAuthUI();
    }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
    showHome();
    updateAuthUI();
    
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSidebar();
            closeBudget();
            closeDetails();
        }
    });
});
</script>
</body>
</html>
