// ===== Firebase Configuration =====
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebaseapp.com",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// ===== Supabase Configuration =====
const supabaseConfig = {
  url: 'https://dnclbdvdzvtdjpgxwnrl.supabase.co',
  key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuY2xiZHZkenZ0ZGpwZ3h3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjY5OTcsImV4cCI6MjA4MjgwMjk5N30.alGg61mAPLLqLM2LlQRq2K2o_eOOnJwNuaIJiAXB7Wg'
};

// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª =====
// Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

// Supabase
const supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.key);

// ===== Ø®Ø¯Ù…Ø§Øª Firebase =====
const auth = firebase.auth();
const db = firebase.database();

// ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¬Ù‡ÙˆÙ„Ø© =====
auth.signInAnonymously().catch(err => console.error("Anonymous auth error:", err));

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =====
let userUID = null;
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;
let budget = null;
let currentPage = 1;
const postsPerPage = 6;
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØ± =====
let currentProductImages = []; // Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
let selectedImages = []; // Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹
let galleryImages = []; // ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶
let currentGalleryIndex = 0; // Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ø¶

// ===== Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        userUID = user.uid;
        
        if (user.email) {
            // Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
            db.ref("users/" + user.uid).once("value", snapshot => {
                const userData = snapshot.val();
                if (userData) {
                    userDisplayName = userData.username;
                    userFullName = userData.fullName || userData.username;
                    isAdmin = userData.isAdmin === true;
                    updateAuthUI();
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
                    db.ref("users/" + user.uid).update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        } else {
            // Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„
            userDisplayName = "Ø²Ø§Ø¦Ø±";
            updateAuthUI();
        }
    } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        userUID = null;
        updateAuthUI();
    }
});

// ===== Ø¯ÙˆØ§Ù„ Sidebar =====
function toggleSidebar() {
    document.querySelector(".sidebar").classList.toggle("active");
    document.querySelector(".overlay")?.classList.toggle("active");
}

function closeSidebar() {
    document.querySelector(".sidebar").classList.remove("active");
    document.querySelector(".overlay")?.classList.remove("active");
}

// ===== Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
function showHome() {
    closeSidebar();
    document.getElementById("content").innerHTML = `
        <div class="search-bar">
            <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
            <select id="cat" onchange="loadProducts()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                ${categories.map(c => `<option>${c}</option>`).join("")}
            </select>
            <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
        </div>
        <div class="cards" id="products"></div>
        <div id="pagination" style="text-align:center;margin:20px"></div>
    `;
    loadProducts();
}

// ===== Budget Dialog =====
function showBudgetDialog() {
    document.getElementById("budgetDialog").classList.add("show");
}

function closeBudget() {
    document.getElementById("budgetDialog").classList.remove("show");
}

function applyBudget() {
    const val = parseFloat(document.getElementById("maxBudget").value);
    budget = !isNaN(val) ? val : null;
    closeBudget();
    loadProducts();
}

// ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø§Ù„ØµÙˆØ± =====
function loadProducts() {
    const s = document.getElementById("search")?.value.toLowerCase() || '';
    const c = document.getElementById("cat")?.value || '';
    
    db.ref("products").once("value", snap => {
        const d = snap.val() || {};
        let htmlCards = [];
        
        Object.keys(d).forEach(k => {
            const p = d[k];
            const price = parseFloat(p.price) || 0;
            
            if ((!c || p.category === c) && p.name.toLowerCase().includes(s)) {
                if (budget && price > budget) return;
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
                let imagesHTML = '';
                if (p.images && p.images.length > 0) {
                    imagesHTML = `
                        <div class="product-images">
                            ${p.images.slice(0, 3).map((img, index) => `
                                <img src="${img}" alt="ØµÙˆØ±Ø© ${index + 1}" class="product-image-thumb" 
                                     onclick="openImageGallery('${k}', ${index}); event.stopPropagation();">
                            `).join('')}
                            ${p.images.length > 3 ? `
                                <div style="
                                    width: 70px;
                                    height: 70px;
                                    background: rgba(56, 189, 248, 0.1);
                                    border: 1px solid rgba(56, 189, 248, 0.2);
                                    border-radius: 8px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #38bdf8;
                                    font-size: 14px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    flex-shrink: 0;
                                " onclick="openImageGallery('${k}', 3); event.stopPropagation();">
                                    +${p.images.length - 3}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø¦Ø¹
                const sellerSection = userDisplayName ? 
                    `<div class="seller">
                        ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">${p.seller}</span> | â˜ ${p.phone}
                        <br><small style="color:#9ca3af; font-size:11px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
                    </div>` :
                    `<div class="seller">
                        ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
                    </div>`;
                
                htmlCards.push({
                    uid: p.uid,
                    key: k,
                    html: `
                        <div class="card" onclick="showDetails('${k}')">
                            <h3>${escapeHTML(p.name)}</h3>
                            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
                            ${imagesHTML}
                            <div class="meta">
                                <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
                            </div>
                            ${sellerSection}
                            <div class="actions">
                                ${(p.uid === userUID || isAdmin) ? `
                                    <button class="edit" onclick="editProduct('${k}'); event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="del" onclick="deleteProduct('${k}'); event.stopPropagation();">Ø­Ø°Ù</button>
                                ` : ""}
                            </div>
                        </div>
                    `
                });
            }
        });
        
        // ØªØ±ØªÙŠØ¨ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
        if (userUID) {
            htmlCards = htmlCards.sort((a, b) => b.uid === userUID ? 1 : -1);
        }
        
        // Pagination
        const totalPages = Math.ceil(htmlCards.length / postsPerPage);
        if (currentPage > totalPages) currentPage = 1;
        const start = (currentPage - 1) * postsPerPage;
        const pageItems = htmlCards.slice(start, start + postsPerPage);
        
        let finalHTML = pageItems.map(p => p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
        document.getElementById("products").innerHTML = finalHTML;
        
        renderPagination(totalPages);
    }).catch(error => {
        console.error("Error loading products:", error);
        document.getElementById("products").innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    });
}

// ===== Render Pagination =====
function renderPagination(total) {
    let html = "";
    for (let i = 1; i <= total; i++) {
        html += `
            <button onclick="goPage(${i})"
                style="
                    margin: 3px;
                    padding: 10px 16px;
                    border-radius: 8px;
                    border: none;
                    cursor: pointer;
                    background: ${i === currentPage ? '#38bdf8' : '#1f2937'};
                    color: ${i === currentPage ? '#000' : '#fff'};
                    font-weight: 600;
                    transition: all 0.2s;
                ">
                ${i}
            </button>`;
    }
    document.getElementById("pagination").innerHTML = html;
}

function goPage(p) {
    currentPage = p;
    loadProducts();
}

// ===== Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ØµÙˆØ± =====
async function deleteProduct(k) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ø£ÙŠØ¶Ø§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
        return;
    }
    
    try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹
        const snapshot = await db.ref("products/" + k).once('value');
        const product = snapshot.val();
        
        if (!product) {
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            return;
        }
        
        if (product.uid !== userUID && !isAdmin) {
            alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
            return;
        }
        
        // Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ù…Ù† Supabase Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
        if (product.images && product.images.length > 0) {
            const imageUrls = product.images;
            const deletePromises = imageUrls.map(async (url) => {
                try {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
                    const fileName = url.split('/').pop();
                    if (fileName) {
                        const { error } = await supabase.storage
                            .from('product-images')
                            .remove([`${k}/${fileName}`]);
                        
                        if (error) {
                            console.warn("Error deleting image:", error.message);
                        }
                    }
                } catch (error) {
                    console.warn("Error processing image deletion:", error);
                }
            });
            
            await Promise.all(deletePromises);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (product.uid) {
            const userSnapshot = await db.ref('users/' + product.uid).once('value');
            const userData = userSnapshot.val();
            if (userData) {
                const currentCount = userData.totalProducts || 0;
                if (currentCount > 0) {
                    await db.ref('users/' + product.uid).update({
                        totalProducts: currentCount - 1
                    });
                }
            }
        }
        
        // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Firebase
        await db.ref("products/" + k).remove();
        
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ù„ØµÙˆØ± Ø¨Ù†Ø¬Ø§Ø­");
        loadProducts();
        
    } catch (error) {
        console.error("Delete error:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    }
}

// ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ =====
async function editProduct(k) {
    try {
        const snapshot = await db.ref("products/" + k).once("value");
        const product = snapshot.val();
        
        if (!product) {
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            return;
        }
        
        if (product.uid !== userUID && !isAdmin) {
            alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
            return;
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        currentProductImages = product.images || [];
        selectedImages = []; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        
        showPublish(product, k);
    } catch (error) {
        console.error("Error loading product for edit:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
    }
}

// ===== Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø±/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =====
function showPublish(p = null, k = null) {
    closeSidebar();
    
    const sellerName = userDisplayName || (p ? p.seller : "");
    const sellerField = userDisplayName ? 
        `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
         <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
        `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" maxlength="30">`;
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const provincesOptions = provinces.map(pr => 
        `<option value="${pr}" ${p && p.province === pr ? "selected" : ""}>${pr}</option>`
    ).join("");
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±
    let imagesPreviewHTML = '';
    if (p && currentProductImages && currentProductImages.length > 0) {
        imagesPreviewHTML = currentProductImages.map((img, index) => `
            <div class="image-preview">
                <img src="${img}" alt="ØµÙˆØ±Ø© ${index + 1}">
                <button class="remove-image" onclick="removeExistingImage(${index})">âœ•</button>
            </div>
        `).join('');
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹
    imagesPreviewHTML += selectedImages.map((img, index) => `
        <div class="image-preview">
            <img src="${img.preview}" alt="ØµÙˆØ±Ø© ${index + 1}">
            <button class="remove-image" onclick="removeSelectedImage(${index})">âœ•</button>
        </div>
    `).join('');
    
    document.getElementById("content").innerHTML = `
        <div class="form-box">
            <h2>${p ? "ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†" : "Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
            
            <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p ? escapeHTML(p.name) : ""}" maxlength="50" required>
            <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)" value="${p ? p.price : ""}" min="0" max="10000000" required>
            <select id="category" required>
                ${categories.map(c => `<option value="${c}" ${p && p.category === c ? "selected" : ""}>${c}</option>`).join("")}
            </select>
            ${sellerField}
            <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0)" value="${p ? p.phone : ""}" pattern="[0][0-9]{10}" required>
            <small style="color:#9ca3af; font-size:12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…</small>
            <select id="province" required>
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                ${provincesOptions}
            </select>
            <select id="delivery" required>
                <option value="Ù†Ø¹Ù…" ${p && p.delivery === "Ù†Ø¹Ù…" ? "selected" : ""}>Ù†Ø¹Ù…</option>
                <option value="Ù„Ø§" ${p && p.delivery === "Ù„Ø§" ? "selected" : ""}>Ù„Ø§</option>
            </select>
            
            <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
            <div class="image-upload-section">
                <div class="image-upload-header">
                    <h4>ğŸ“· ØµÙˆØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</h4>
                    <span class="image-count">${currentProductImages.length + selectedImages.length}/2</span>
                </div>
                
                <div class="image-upload-warning">
                    âš ï¸ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±ØªÙŠÙ† ÙÙ‚Ø· Ù„ÙƒÙ„ Ø¥Ø¹Ù„Ø§Ù†
                    <br><small>Ø§Ù„ØµÙˆØ±: PNG, JPG, GIF - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 5MB Ù„ÙƒÙ„ ØµÙˆØ±Ø©</small>
                </div>
                
                <div class="image-preview-container" id="imagePreviewContainer">
                    ${imagesPreviewHTML || '<div style="color:#9ca3af; text-align:center; width:100%; padding:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¨Ø¹Ø¯</div>'}
                </div>
                
                ${(currentProductImages.length + selectedImages.length) < 2 ? `
                <div class="upload-btn-container">
                    <label class="upload-image-btn">
                        <i>ğŸ“·</i>
                        Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
                        <input type="file" accept="image/*" style="display:none;" 
                               onchange="handleImageUpload(event)" multiple>
                    </label>
                </div>
                ` : ''}
            </div>
            
            <button onclick="saveProduct('${k || ""}')" id="saveBtn">
                ğŸ’¾ ${p ? "ØªØ­Ø¯ÙŠØ«" : "Ù†Ø´Ø±"}
            </button>
            ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
        </div>`;
}

// ===== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± =====
function handleImageUpload(event) {
    const files = Array.from(event.target.files);
    const remainingSlots = 2 - (currentProductImages.length + selectedImages.length);
    
    if (files.length > remainingSlots) {
        alert(`ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ${remainingSlots} ØµÙˆØ±Ø© ÙÙ‚Ø·`);
        event.target.value = '';
        return;
    }
    
    files.forEach(file => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
        if (file.size > 5 * 1024 * 1024) {
            alert(`Ø§Ù„Ù…Ù„Ù ${file.name} ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 5MB)`);
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert(`Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ${file.name} ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedImages.push({
                file: file,
                preview: e.target.result
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            updateImagePreview();
        };
        reader.readAsDataURL(file);
    });
    
    event.target.value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø±ÙØ¹
}

// ===== ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± =====
function updateImagePreview() {
    const container = document.getElementById('imagePreviewContainer');
    const imageCount = document.querySelector('.image-count');
    
    if (container) {
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        let html = currentProductImages.map((img, index) => `
            <div class="image-preview">
                <img src="${img}" alt="ØµÙˆØ±Ø© ${index + 1}">
                <button class="remove-image" onclick="removeExistingImage(${index})">âœ•</button>
            </div>
        `).join('');
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø­Ø¯ÙŠØ«Ø§Ù‹
        html += selectedImages.map((img, index) => `
            <div class="image-preview">
                <img src="${img.preview}" alt="ØµÙˆØ±Ø© ${index + 1}">
                <button class="remove-image" onclick="removeSelectedImage(${index})">âœ•</button>
            </div>
        `).join('');
        
        if (!html) {
            html = '<div style="color:#9ca3af; text-align:center; width:100%; padding:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¨Ø¹Ø¯</div>';
        }
        
        container.innerHTML = html;
    }
    
    if (imageCount) {
        imageCount.textContent = `${currentProductImages.length + selectedImages.length}/2`;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±ÙØ¹ Ø¥Ø°Ø§ ÙˆØµÙ„ Ù„Ù„Ø­Ø¯
    const uploadBtn = document.querySelector('.upload-btn-container');
    if (uploadBtn) {
        if (currentProductImages.length + selectedImages.length >= 2) {
            uploadBtn.style.display = 'none';
        } else {
            uploadBtn.style.display = 'block';
        }
    }
}

function removeSelectedImage(index) {
    selectedImages.splice(index, 1);
    updateImagePreview();
}

function removeExistingImage(index) {
    currentProductImages.splice(index, 1);
    updateImagePreview();
}

// ===== Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø§Ù„ØµÙˆØ± =====
async function saveProduct(k) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const name = document.getElementById("name").value.trim();
    const price = document.getElementById("price").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const province = document.getElementById("province").value;
    
    if (!name || !price || !phone || !province) {
        alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
        return;
    }
    
    if (name.length < 3 || name.length > 50) {
        alert("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
        return;
    }
    
    const priceNum = parseFloat(price);
    if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
        alert("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
        return;
    }
    
    if(!/^[0][0-9]{10}$/.test(phone)){
        alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
        return;
    }
    
    if (!province) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
        return;
    }

    const seller = userDisplayName || document.getElementById("seller").value.trim();
    
    if (!seller || seller.length < 2) {
        alert("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±
    const totalImages = currentProductImages.length + selectedImages.length;
    if (totalImages > 2) {
        alert("ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±ØªÙŠÙ† ÙÙ‚Ø· Ù„ÙƒÙ„ Ø¥Ø¹Ù„Ø§Ù†");
        return;
    }

    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    saveBtn.disabled = true;

    try {
        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Supabase
        let uploadedImageUrls = [...currentProductImages];
        
        if (selectedImages.length > 0) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹
            const productId = k || `product_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const uploadPromises = selectedImages.map(async (img, index) => {
                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù„Ù
                    const fileExt = img.file.name.split('.').pop();
                    const fileName = `image_${Date.now()}_${index}.${fileExt}`;
                    const filePath = `${productId}/${fileName}`;
                    
                    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Supabase Storage
                    const { data, error } = await supabase.storage
                        .from('product-images')
                        .upload(filePath, img.file);
                    
                    if (error) throw error;
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù…
                    const { data: urlData } = supabase.storage
                        .from('product-images')
                        .getPublicUrl(filePath);
                    
                    return urlData.publicUrl;
                } catch (error) {
                    console.error("Error uploading image:", error);
                    throw error;
                }
            });
            
            const newUrls = await Promise.all(uploadPromises);
            uploadedImageUrls = [...uploadedImageUrls, ...newUrls];
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        const data = {
            name: name,
            price: priceNum,
            category: document.getElementById("category").value,
            seller: seller,
            phone: phone,
            province: province,
            delivery: document.getElementById("delivery").value,
            uid: userUID,
            images: uploadedImageUrls,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        if (!k) {
            data.createdAt = firebase.database.ServerValue.TIMESTAMP;
        }
        
        const ref = k ? db.ref("products/" + k) : db.ref("products").push();
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
        await ref.set(data);
        
        if (!k && userUID) {
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
            const userSnapshot = await db.ref('users/' + userUID).once('value');
            const userData = userSnapshot.val();
            if (userData) {
                const currentCount = userData.totalProducts || 0;
                await db.ref('users/' + userUID).update({
                    totalProducts: currentCount + 1,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§
                await db.ref('users/' + userUID).set({
                    totalProducts: 1,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØ±
        currentProductImages = [];
        selectedImages = [];
        
        alert(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
        showHome();
        
    } catch (error) {
        console.error("Error saving product:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// ===== Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ =====
async function showDetails(k) {
    try {
        const snapshot = await db.ref("products/" + k).once("value");
        const p = snapshot.val();
        
        if (!p) {
            alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
            return;
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
        let imagesHTML = '';
        if (p.images && p.images.length > 0) {
            imagesHTML = `
                <div style="margin: 20px 0;">
                    <h4 style="color:#38bdf8; margin-bottom:10px;">ğŸ“· ØµÙˆØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</h4>
                    <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                        ${p.images.map((img, index) => `
                            <img src="${img}" alt="ØµÙˆØ±Ø© ${index + 1}" 
                                 style="width: 120px; height: 120px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 2px solid rgba(56, 189, 248, 0.3);"
                                 onclick="openImageGallery('${k}', ${index});">
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        const sellerWithLink = userDisplayName ? 
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">${p.seller}</span></p>
             <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${p.seller}</p>`;
        
        document.getElementById("detailsContent").innerHTML = `
            <h2>${escapeHTML(p.name)}</h2>
            <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
            <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            ${imagesHTML}
            ${sellerWithLink}
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
            <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
            ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
        `;
        document.getElementById("detailsDialog").style.display = "block";
        
    } catch (error) {
        console.error("Error loading details:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
    }
}

function closeDetails() {
    document.getElementById("detailsDialog").style.display = "none";
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± =====
function openImageGallery(productId, startIndex = 0) {
    db.ref("products/" + productId).once("value", snapshot => {
        const product = snapshot.val();
        if (product && product.images) {
            galleryImages = product.images;
            currentGalleryIndex = startIndex;
            
            const galleryImage = document.getElementById('galleryImage');
            const galleryModal = document.getElementById('imageGalleryModal');
            const galleryCounter = document.getElementById('galleryCounter');
            
            if (galleryImage && galleryModal && galleryCounter) {
                galleryImage.src = galleryImages[currentGalleryIndex];
                galleryCounter.textContent = `${currentGalleryIndex + 1} / ${galleryImages.length}`;
                galleryModal.classList.add('active');
            }
        }
    });
}

function closeGallery() {
    const galleryModal = document.getElementById('imageGalleryModal');
    if (galleryModal) {
        galleryModal.classList.remove('active');
        galleryImages = [];
        currentGalleryIndex = 0;
    }
}

function prevImage() {
    if (galleryImages.length > 0) {
        currentGalleryIndex = (currentGalleryIndex - 1 + galleryImages.length) % galleryImages.length;
        updateGallery();
    }
}

function nextImage() {
    if (galleryImages.length > 0) {
        currentGalleryIndex = (currentGalleryIndex + 1) % galleryImages.length;
        updateGallery();
    }
}

function updateGallery() {
    const galleryImage = document.getElementById('galleryImage');
    const galleryCounter = document.getElementById('galleryCounter');
    
    if (galleryImage && galleryCounter) {
        galleryImage.src = galleryImages[currentGalleryIndex];
        galleryCounter.textContent = `${currentGalleryIndex + 1} / ${galleryImages.length}`;
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
    const authSection = document.getElementById("authSection");
    
    if (!authSection) return;
    
    if (currentUser && userDisplayName) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const displayName = userFullName || userDisplayName;
        authSection.innerHTML = `
            <div class="user-info">
                <p class="profile-link" onclick="viewMyProfile()">ğŸ‘¤ ${displayName}</p>
                <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
                <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        `;
    } else {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
        authSection.innerHTML = `
            <button class="auth-btn" onclick="showLoginAlert()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
            <button class="auth-btn" onclick="showRegisterAlert()">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            <div style="color:#9ca3af; font-size:12px; text-align:center; padding:10px;">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ø´Ø± ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„
            </div>
        `;
    }
}

function showLoginAlert() {
    alert("Ù„Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙˆØ­ÙØ¸ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ù† Ø®Ù„Ø§Ù„ ØªØ·Ø¨ÙŠÙ‚Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ");
}

function showRegisterAlert() {
    alert("Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ");
}

function logoutUser() {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        auth.signOut()
            .then(() => {
                currentUser = null;
                userDisplayName = null;
                userFullName = null;
                isAdmin = false;
                updateAuthUI();
                showHome();
            })
            .catch((error) => {
                console.error("Logout error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
            });
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
function viewProfile(userId, sellerName) {
    if (sellerName) {
        localStorage.setItem('profileSellerName', sellerName);
    }
    window.location.href = `profile.html?id=${userId}`;
}

function viewMyProfile() {
    if (currentUser && currentUser.uid) {
        window.location.href = `profile.html?id=${currentUser.uid}`;
    } else {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        showLoginAlert();
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPrice(price) {
    return parseInt(price).toLocaleString('ar-SA');
}

// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
document.addEventListener("DOMContentLoaded", function() {
    showHome();
    updateAuthUI();
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeGallery();
        }
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('imageGalleryModal')?.addEventListener('click', function(e) {
        if (e.target.classList.contains('image-gallery-modal')) {
            closeGallery();
        }
    });
});
