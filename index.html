<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ===== */
.verified-badge {
    display: inline-flex;
    align-items: center;
    background: #10b981;
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-right: 5px;
    vertical-align: middle;
}

.verified-icon {
    font-size: 10px;
    margin-left: 2px;
}

.user-name-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ===== */
.product-status {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

.status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.status-sold { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

.admin-badge {
  background: #8b5cf6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.security-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  text-align: center;
}

.session-timeout {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(245, 158, 11, 0.9);
  color: #000;
  padding: 10px 15px;
  border-radius: 6px;
  z-index: 2000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± ===== */
.publish-timer {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 14px;
  text-align: center;
  direction: ltr;
}

.publish-timer.active {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: #10b981;
}

.timer-disabled {
  opacity: 0.6;
  cursor: not-allowed !important;
}

.timer-disabled button {
  background: #6b7280 !important;
  cursor: not-allowed !important;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØµÙˆØ± ===== */
.image-upload-container {
  margin: 15px 0;
}

.image-preview {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.preview-image {
  width: 120px;
  height: 120px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid #374151;
  cursor: pointer;
  transition: transform 0.2s, border-color 0.2s;
}

.preview-image:hover {
  transform: scale(1.05);
  border-color: #38bdf8;
}

.remove-image-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-size: 12px;
  cursor: pointer;
  display: none;
}

.image-preview-item {
  position: relative;
}

.image-preview-item:hover .remove-image-btn {
  display: block;
}

.file-input-label {
  display: inline-block;
  background: #1f2937;
  color: #e5e7eb;
  padding: 10px 15px;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  margin: 5px 0;
  border: 2px dashed #374151;
  transition: all 0.3s;
}

.file-input-label:hover {
  background: #374151;
  border-color: #38bdf8;
}

.file-input-label i {
  margin-left: 5px;
  color: #38bdf8;
}

#images {
  display: none;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ===== */
.product-images {
  margin: 10px 0;
  position: relative;
  overflow: hidden;
  border-radius: 8px;
  background: #1a1a1a;
}

.images-slider {
  display: flex;
  transition: transform 0.3s ease;
}

.slider-image {
  min-width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 8px;
}

.image-counter {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 12px;
}

.slider-nav {
  position: absolute;
  top: 50%;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 10px;
  transform: translateY(-50%);
}

.slider-btn {
  background: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: background 0.3s;
}

.slider-btn:hover {
  background: rgba(0, 0, 0, 0.8);
}

.no-image {
  width: 100%;
  height: 180px;
  background: linear-gradient(135deg, #1f2937, #374151);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #9ca3af;
  font-size: 14px;
  text-align: center;
  padding: 20px;
}

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± ===== */
.card {
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-5px);
}

.card h3 {
  margin-bottom: 10px;
  height: 40px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
@media (max-width: 768px) {
    .user-name-wrapper {
        flex-wrap: wrap;
    }
    
    .verified-badge {
        font-size: 9px;
        padding: 1px 4px;
    }
    
    .seller-link {
        font-size: 14px;
    }
    
    .slider-image {
        height: 150px;
    }
    
    .preview-image {
        width: 100px;
        height: 100px;
    }
    
    .image-preview {
        justify-content: center;
    }
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ===== */
.upload-progress {
  width: 100%;
  height: 4px;
  background: #374151;
  border-radius: 2px;
  margin: 10px 0;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: #38bdf8;
  border-radius: 2px;
  transition: width 0.3s;
  width: 0%;
}

.upload-status {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 5px;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<!-- Progress Bar System -->
<div class="top-progress-bar" id="topProgressBar">
    <div class="progress-bar-line" id="progressBarLine"></div>
</div>

<div class="circular-progress" id="circularProgress">
    <svg viewBox="0 0 36 36">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#38bdf8" />
                <stop offset="100%" stop-color="#0ea5e9" />
            </linearGradient>
        </defs>
        <circle class="progress-bg" cx="18" cy="18" r="16"></circle>
        <circle class="progress-fill" cx="18" cy="18" r="16" 
                stroke-dasharray="100" stroke-dashoffset="100"></circle>
    </svg>
</div>

<div class="progress-overlay" id="progressOverlay">
    <div class="progress-overlay-content">
        <div class="progress-overlay-spinner"></div>
        <div class="progress-overlay-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="progress-overlay-subtext" id="progressSubtext">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>
</div>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Session Timeout Warning -->
<div class="session-timeout" id="sessionTimeout">
  <span id="timeoutMessage">Ø³ØªÙ†ØªÙ‡ÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„ Ø®Ù„Ø§Ù„ <span id="timeoutTimer">60</span> Ø«Ø§Ù†ÙŠØ©</span>
  <button onclick="extendSession()" style="
    background: #000;
    color: #f59e0b;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 10px;
    cursor: pointer;
    font-size: 12px;
  ">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ===== ØªÙ‡ÙŠØ¦Ø© Supabase =====
const supabaseUrl = 'https://dnclbdvdzvtdjpgxwnrl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuY2xiZHZkenZ0ZGpwZ3h3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjY5OTcsImV4cCI6MjA4MjgwMjk5N30.alGg61mAPLLqLM2LlQRq2K2o_eOOnJwNuaIJiAXB7Wg';

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const analytics = firebase.analytics();

// ===== Progress Bar System =====
class ProgressManager {
    constructor() {
        this.topProgressBar = document.getElementById('topProgressBar');
        this.progressBarLine = document.getElementById('progressBarLine');
        this.circularProgress = document.getElementById('circularProgress');
        this.progressOverlay = document.getElementById('progressOverlay');
        this.progressText = document.getElementById('progressText');
        this.progressSubtext = document.getElementById('progressSubtext');
        
        this.currentProgress = 0;
        this.progressInterval = null;
        this.isLoading = false;
        
        this.init();
    }
    
    init() {
        this.updateCircularProgress(0);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    showTopProgressBar() {
        this.topProgressBar.style.display = 'block';
        this.progressBarLine.style.width = '0%';
        this.progressBarLine.className = 'progress-bar-line';
        
        this.currentProgress = 0;
        clearInterval(this.progressInterval);
        
        this.progressInterval = setInterval(() => {
            if (this.currentProgress < 90) {
                this.currentProgress += Math.random() * 10;
                this.updateTopProgress(this.currentProgress);
            }
        }, 200);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ
    updateTopProgress(percent) {
        this.progressBarLine.style.width = `${Math.min(percent, 100)}%`;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    hideTopProgressBar() {
        clearInterval(this.progressInterval);
        this.updateTopProgress(100);
        
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.currentProgress = 0;
        }, 300);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    showCircularProgress() {
        this.circularProgress.style.display = 'block';
        this.updateCircularProgress(0);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            this.updateCircularProgress(progress);
            
            if (progress >= 100) {
                progress = 0;
            }
        }, 200);
        
        return () => clearInterval(interval);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    updateCircularProgress(percent) {
        const circle = this.circularProgress.querySelector('.progress-fill');
        if (circle) {
            const offset = 100 - percent;
            circle.style.strokeDashoffset = offset;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    hideCircularProgress() {
        this.circularProgress.style.display = 'none';
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Overlay ÙƒØ§Ù…Ù„
    showOverlay(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', subtext = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
        this.isLoading = true;
        this.progressText.textContent = text;
        this.progressSubtext.textContent = subtext;
        this.progressOverlay.classList.add('active');
        
        document.body.style.overflow = 'hidden';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù€ Overlay
    updateOverlayText(text, subtext = null) {
        this.progressText.textContent = text;
        if (subtext !== null) {
            this.progressSubtext.textContent = subtext;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Overlay
    hideOverlay() {
        this.isLoading = false;
        this.progressOverlay.classList.remove('active');
        
        setTimeout(() => {
            document.body.style.overflow = '';
        }, 300);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showSuccess(message = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!') {
        this.progressBarLine.className = 'progress-bar-line progress-success';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø®Ø·Ø£
    showError(message = 'Ø­Ø¯Ø« Ø®Ø·Ø£!') {
        this.progressBarLine.className = 'progress-bar-line progress-error';
        this.updateOverlayText(message, 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 2000);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
    showWarning(message = 'ØªØ­Ø°ÙŠØ±!') {
        this.progressBarLine.className = 'progress-bar-line progress-warning';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Skeleton Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    createSkeletonCards(count = 6) {
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
                <div class="skeleton-card">
                    <div class="skeleton-line" style="height: 20px; width: 70%"></div>
                    <div class="skeleton-line" style="height: 16px; width: 40%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 60%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 50%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 80%"></div>
                </div>
            `;
        }
        return skeletonHTML;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Progress Manager
const progressManager = new ProgressManager();

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =====
let userUID = null;
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;
let budget = null;
let currentPage = 1;
const postsPerPage = 6;

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];

// ===== Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± =====
let canPublish = true;
let publishTimer = null;
let publishTimeLeft = 0;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
let sessionTimeout = null;
let sessionWarning = null;
const SESSION_DURATION = 60 * 60 * 1000;
const SESSION_WARNING = 5 * 60 * 1000;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± =====
let selectedImages = [];
let imagePreviewUrls = [];

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† =====
function showSecurityWarning(message) {
    const content = document.getElementById('content');
    if (content) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'security-warning';
        warningDiv.innerHTML = `âš ï¸ ${message}`;
        content.insertBefore(warningDiv, content.firstChild);
        
        setTimeout(() => {
            warningDiv.style.opacity = '0';
            setTimeout(() => warningDiv.remove(), 500);
        }, 5000);
    }
}

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø¶Ù…ÙˆÙ† =====
class ImageManager {
    static async uploadProductImages(productId, images) {
        const imageUrls = [];
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ timestamp
        const actualProductId = productId || 'temp_' + Date.now();
        
        for (let i = 0; i < images.length; i++) {
            const file = images[i];
            
            // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
            const compressedFile = await ImageManager.compressImage(file);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ù…Ù„Ù Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø¹Ù‚Ø¯Ø©
            const fileName = `product_${actualProductId}_${i}_${Date.now()}.jpg`;
            
            console.log('ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', fileName, 'Ø­Ø¬Ù…:', compressedFile.size, 'Ø¨Ø§ÙŠØª');
            
            try {
                // Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù„Ø¯Ø§Øª ÙØ±Ø¹ÙŠØ©
                const { data, error } = await supabaseClient.storage
                    .from('ads-images')
                    .upload(fileName, compressedFile, {
                        cacheControl: '3600',
                        contentType: 'image/jpeg',
                        upsert: false
                    });
                
                if (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:', error.message);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³Ù… Ø£Ø¨Ø³Ø·
                    const simpleName = `img_${Date.now()}_${i}.jpg`;
                    const { data: altData, error: altError } = await supabaseClient.storage
                        .from('ads-images')
                        .upload(simpleName, compressedFile);
                    
                    if (altError) {
                        console.error('âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©:', altError.message);
                        continue;
                    }
                    
                    const { data: urlData } = supabaseClient.storage
                        .from('ads-images')
                        .getPublicUrl(simpleName);
                    
                    if (urlData?.publicUrl) {
                        imageUrls.push(urlData.publicUrl);
                        console.log('âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ (Ø§Ù„Ø¨Ø¯ÙŠÙ„):', urlData.publicUrl);
                    }
                    continue;
                }
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
                const { data: urlData } = supabaseClient.storage
                    .from('ads-images')
                    .getPublicUrl(fileName);
                
                if (urlData?.publicUrl) {
                    imageUrls.push(urlData.publicUrl);
                    console.log('âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­:', urlData.publicUrl);
                }
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', err);
            }
        }
        
        return imageUrls;
    }
    
    static async compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… (800x600)
                    const maxWidth = 800;
                    const maxHeight = 600;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø§Ø³Ø¨
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Blob Ø¨Ø¬ÙˆØ¯Ø© 80%
                    canvas.toBlob((blob) => {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    }, 'image/jpeg', 0.8);
                };
            };
        });
    }
    
    static async deleteProductImages(productId) {
        try {
            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ product_${productId}
            const { data: files, error } = await supabaseClient.storage
                .from('ads-images')
                .list();
            
            if (error) {
                console.error('Error listing files:', error);
                return;
            }
            
            if (files && files.length > 0) {
                // ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬
                const productFiles = files.filter(file => 
                    file.name.includes(`product_${productId}_`) || 
                    file.name.includes(`img_${productId}_`)
                );
                
                if (productFiles.length > 0) {
                    const filePaths = productFiles.map(file => file.name);
                    const { error: deleteError } = await supabaseClient.storage
                        .from('ads-images')
                        .remove(filePaths);
                    
                    if (deleteError) {
                        console.error('Delete error:', deleteError);
                    } else {
                        console.log(`âœ… ØªÙ… Ø­Ø°Ù ${productFiles.length} ØµÙˆØ±Ø© Ù„Ù„Ù…Ù†ØªØ¬ ${productId}`);
                    }
                }
            }
        } catch (error) {
            console.error('Error in deleteProductImages:', error);
        }
    }
    
    static createImageSlider(images, productId) {
        if (!images || images.length === 0) {
            return '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
        }
        
        let sliderHTML = `
            <div class="product-images" id="slider-${productId}">
                <div class="images-slider">
        `;
        
        images.forEach((img, index) => {
            sliderHTML += `
                <img src="${img}" class="slider-image" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ ${index + 1}" 
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/300x180/1f2937/9ca3af?text=Ù„Ø§+ØªÙˆØ¬Ø¯+ØµÙˆØ±Ø©'">
            `;
        });
        
        sliderHTML += `
                </div>
                <div class="image-counter">1 / ${images.length}</div>
        `;
        
        if (images.length > 1) {
            sliderHTML += `
                <div class="slider-nav">
                    <button class="slider-btn prev-btn" onclick="ImageManager.prevSlide('${productId}')">â®</button>
                    <button class="slider-btn next-btn" onclick="ImageManager.nextSlide('${productId}')">â¯</button>
                </div>
            `;
        }
        
        sliderHTML += '</div>';
        
        return sliderHTML;
    }
    
    static nextSlide(productId) {
        const slider = document.querySelector(`#slider-${productId} .images-slider`);
        if (!slider) return;
        
        const totalSlides = slider.children.length;
        const currentSlide = Math.abs(parseInt(slider.style.transform?.match(/-?\d+/)?.[0] || 0) / 100);
        const nextSlide = (currentSlide + 1) % totalSlides;
        
        slider.style.transform = `translateX(-${nextSlide * 100}%)`;
        
        const counter = document.querySelector(`#slider-${productId} .image-counter`);
        if (counter) {
            counter.textContent = `${nextSlide + 1} / ${totalSlides}`;
        }
    }
    
    static prevSlide(productId) {
        const slider = document.querySelector(`#slider-${productId} .images-slider`);
        if (!slider) return;
        
        const totalSlides = slider.children.length;
        const currentSlide = Math.abs(parseInt(slider.style.transform?.match(/-?\d+/)?.[0] || 0) / 100);
        const prevSlide = (currentSlide - 1 + totalSlides) % totalSlides;
        
        slider.style.transform = `translateX(-${prevSlide * 100}%)`;
        
        const counter = document.querySelector(`#slider-${productId} .image-counter`);
        if (counter) {
            counter.textContent = `${prevSlide + 1} / ${totalSlides}`;
        }
    }
}

// ===== Ù†Ø¸Ø§Ù… Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù† =====
async function checkPublishPermission() {
    if (!userUID) {
        canPublish = true;
        return true;
    }
    
    progressManager.showCircularProgress();
    
    return new Promise((resolve) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase
        db.ref('users/' + userUID + '/lastPublish').once('value', (userSnap) => {
            progressManager.hideCircularProgress();
            
            const lastPublish = userSnap.val();
            if (!lastPublish) {
                canPublish = true;
                resolve(true);
                return;
            }
            
            const timeDiff = Date.now() - lastPublish;
            const oneHour = 60 * 60 * 1000;
            
            if (timeDiff < oneHour) {
                canPublish = false;
                publishTimeLeft = Math.ceil((oneHour - timeDiff) / 1000);
                startPublishTimer();
                resolve(false);
            } else {
                canPublish = true;
                resolve(true);
            }
        }).catch((error) => {
            console.error("Error checking publish permission:", error);
            progressManager.hideCircularProgress();
            canPublish = true;
            resolve(true);
        });
    });
}

function startPublishTimer() {
    if (publishTimer) {
        clearInterval(publishTimer);
    }
    
    updatePublishTimerDisplay();
    
    publishTimer = setInterval(() => {
        if (publishTimeLeft > 0) {
            publishTimeLeft--;
            updatePublishTimerDisplay();
            
            if (publishTimeLeft <= 0) {
                clearInterval(publishTimer);
                canPublish = true;
                updatePublishTimerDisplay();
                
                if (document.getElementById('publishTimer')) {
                    const timerElement = document.getElementById('publishTimer');
                    timerElement.innerHTML = `
                        <div class="publish-timer active">
                            âœ“ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                            <br><small style="color:#9ca3af;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</small>
                        </div>
                    `;
                    
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('timer-disabled');
                        saveBtn.innerHTML = 'ğŸ’¾ Ù†Ø´Ø±';
                    }
                }
            }
        }
    }, 1000);
}

function updatePublishTimerDisplay() {
    const minutes = Math.floor(publishTimeLeft / 60);
    const seconds = publishTimeLeft % 60;
    
    const timerElement = document.getElementById('publishTimer');
    if (timerElement) {
        timerElement.innerHTML = `
            <div class="publish-timer">
                â° ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} 
                Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                <br><small style="color:#9ca3af;">Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±</small>
            </div>
        `;
    }
}

function saveLastPublishTime() {
    if (!userUID) return;
    
    db.ref('users/' + userUID).update({
        lastPublish: Date.now()
    }).then(() => {
        console.log("Publish time saved to Firebase");
    }).catch((error) => {
        console.error("Error saving publish time:", error);
    });
}

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± =====
function handleImageSelect(event) {
    const files = Array.from(event.target.files);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±
    if (files.length > 2) {
        progressManager.showError("ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±ØªÙŠÙ† ÙÙ‚Ø· ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰");
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
    const invalidFiles = files.filter(file => !validTypes.includes(file.type));
    
    if (invalidFiles.length > 0) {
        progressManager.showError("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù†ÙˆØ¹ ØµÙˆØ±Ø© (JPEG, PNG, WebP)");
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    selectedImages = files.slice(0, 2);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    displayImagePreview();
}

function displayImagePreview() {
    const previewContainer = document.getElementById('imagePreview');
    if (!previewContainer) return;
    
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    imagePreviewUrls = [];
    previewContainer.innerHTML = '';
    
    if (selectedImages.length === 0) {
        previewContainer.innerHTML = '<div style="color:#9ca3af; text-align:center; padding:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±</div>';
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const url = e.target.result;
            imagePreviewUrls.push(url);
            
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${url}" class="preview-image" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© ${index + 1}">
                <button class="remove-image-btn" onclick="removeImage(${index})">Ã—</button>
            `;
            
            previewContainer.appendChild(previewItem);
        };
        
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedImages.splice(index, 1);
    imagePreviewUrls.splice(index, 1);
    displayImagePreview();
    
    // ØªØ­Ø¯ÙŠØ« input file
    const imageInput = document.getElementById('images');
    if (imageInput) {
        imageInput.value = '';
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø© =====
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}

function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

function showHome(){
  closeSidebar();
  progressManager.showTopProgressBar();
  
  setTimeout(() => {
    document.getElementById("content").innerHTML = `
      <div class="search-bar">
        <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
        <select id="cat" onchange="loadProducts()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
          ${categories.map(c=>`<option>${c}</option>`).join("")}
        </select>
        <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
      </div>
      <div class="cards" id="products"></div>
      <div id="pagination" style="text-align:center;margin:20px"></div>
    `;
    loadProducts();
    progressManager.hideTopProgressBar();
  }, 300);
}

function showBudgetDialog(){ document.getElementById("budgetDialog").style.display="block"; }
function closeBudget(){ document.getElementById("budgetDialog").style.display="none"; }

function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  
  if (isNaN(val) || val < 0) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");
    return;
  }
  
  if (val > 10000000) {
    progressManager.showError("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");
    return;
  }
  
  budget = val;
  closeBudget();
  loadProducts();
}

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø§Ù„ØµÙˆØ± =====
function loadProducts(){
  const s = document.getElementById("search")?.value.toLowerCase() || '';
  const c = document.getElementById("cat")?.value || '';
  
  // Ø¹Ø±Ø¶ Skeleton Loading
  const productsContainer = document.getElementById('products');
  if (productsContainer) {
    productsContainer.innerHTML = progressManager.createSkeletonCards(6);
  }
  
  progressManager.showTopProgressBar();
  
  db.ref("products").once("value", snap=>{
    const d = snap.val() || {};
    let htmlCards = [];

    Object.keys(d).forEach(k=>{
      const p = d[k];
      
      if (!p || !p.name || !p.price) {
        return;
      }
      
      const price = parseFloat(p.price) || 0;
      if((!c || p.category===c) && p.name.toLowerCase().includes(s)){
        if(budget && price > budget) return;
        
        const status = p.status || 'available';
        let statusBadge = '';
        if (status !== 'available') {
          statusBadge = `<div class="product-status status-${status}">${getStatusText(status)}</div>`;
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹
        let sellerInfo = p.seller || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        let isVerified = false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹
        if (p.uid) {
          db.ref('users/' + p.uid).once('value', (userSnap) => {
            const userData = userSnap.val();
            if (userData) {
              isVerified = userData.isVerified || false;
            }
          });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        const imagesHTML = p.images && p.images.length > 0 
            ? ImageManager.createImageSlider(p.images, k)
            : '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
        
        const sellerSection = userDisplayName ? 
          `<div class="seller">
            ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">
              <span class="user-name-wrapper">
                ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                ${p.seller}
              </span>
            </span> 
            | â˜ ${p.phone}
            <br><small style="color:#9ca3af; font-size:11px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
          </div>` :
          `<div class="seller">
            ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
          </div>`;
        
        htmlCards.push({uid:p.uid,key:k,html:`
          <div class="card" onclick="showDetails('${k}')">
            ${imagesHTML}
            <h3>${escapeHTML(p.name)}</h3>
            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
            ${statusBadge}
            <div class="meta">
              <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
            </div>
            ${sellerSection}
            <div class="actions">
              ${(p.uid===userUID || isAdmin)?`
              <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
            </div>
          </div>
        `});
      }
    });

    if(userUID){
      htmlCards = htmlCards.sort((a,b)=> b.uid===userUID ? 1 : -1);
    }

    const totalPages = Math.ceil(htmlCards.length / postsPerPage);
    if(currentPage > totalPages) currentPage = 1;
    const start = (currentPage-1)*postsPerPage;
    const pageItems = htmlCards.slice(start, start+postsPerPage);

    let finalHTML = pageItems.map(p=>p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    
    if (productsContainer) {
      productsContainer.style.opacity = '0';
      setTimeout(() => {
        productsContainer.innerHTML = finalHTML;
        productsContainer.style.opacity = '1';
        renderPagination(totalPages);
        progressManager.hideTopProgressBar();
      }, 300);
    }
  }).catch(error => {
    console.error("Error loading products:", error);
    if (productsContainer) {
      productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    }
    progressManager.hideTopProgressBar();
    progressManager.showError("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
  });
}

function renderPagination(total){
  let html = "";
  for(let i=1;i<=total;i++){
    html += `
      <button onclick="goPage(${i})"
        style="
          margin:3px;
          padding:6px 10px;
          border-radius:5px;
          border:none;
          cursor:pointer;
          background:${i===currentPage?'#38bdf8':'#1f2937'};
          color:${i===currentPage?'#000':'#fff'};
        ">
        ${i}
      </button>`;
  }
  const pagination = document.getElementById('pagination');
  if (pagination) {
    pagination.innerHTML = html;
  }
}

function goPage(p){
  currentPage = p;
  loadProducts();
}

// ===== Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø§Ù„ØµÙˆØ± =====
function deleteProduct(k){ 
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø£ÙŠØ¶Ø§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
    return;
  }
  
  progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
  
  db.ref("products/" + k).once('value', (snapshot) => {
    const product = snapshot.val();
    if (!product) {
      progressManager.hideOverlay();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      progressManager.hideOverlay();
      progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    // Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ù…Ù† Supabase Ø£ÙˆÙ„Ø§Ù‹
    if (product.images && product.images.length > 0) {
      ImageManager.deleteProductImages(k);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (product.uid) {
      db.ref('users/' + product.uid).once('value', (userSnapshot) => {
        const userData = userSnapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          if (currentCount > 0) {
            db.ref('users/' + product.uid).update({
              totalProducts: currentCount - 1
            });
          }
        }
      });
    }
    
    // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Firebase
    db.ref("products/"+k).remove().then(() => {
      progressManager.showSuccess("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ù„ØµÙˆØ± Ø¨Ù†Ø¬Ø§Ø­");
      loadProducts();
      
      if (userUID) {
        db.ref("userActivity/" + userUID).push().set({
          type: 'product_deleted',
          productId: k,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }).catch(error => {
      console.error("Delete error:", error);
      progressManager.hideOverlay();
      progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    });
  });
}

function editProduct(k){ 
  progressManager.showTopProgressBar();
  
  db.ref("products/"+k).once("value", s => {
    const product = s.val();
    if (!product) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    showPublish(product, k);
    progressManager.hideTopProgressBar();
  });
}

// ===== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø± Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØ± =====
async function showPublish(p=null,k=null){
  closeSidebar();
  
  progressManager.showTopProgressBar();
  
  setTimeout(async () => {
    if (!userUID && !currentUser) {
      alert("ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø£ÙˆÙ„Ø§Ù‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
      window.location.href = 'register.html';
      progressManager.hideTopProgressBar();
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± (Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·)
    let canPublishNow = true;
    if (!k) {
      canPublishNow = await checkPublishPermission();
    }
    
    const sellerName = userDisplayName || (p ? p.seller : "");
    const sellerField = userDisplayName ? 
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
       <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" maxlength="30">`;
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    selectedImages = [];
    imagePreviewUrls = [];
    
    document.getElementById("content").innerHTML = `
      <div class="form-box">
        <h2>${p ? "ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†" : "Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
        
        ${!p && !canPublishNow ? `<div id="publishTimer"></div>` : ''}
        
        ${p ? '' : '<small style="color:#9ca3af; margin-bottom:15px; display:block;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ ÙƒÙ„ Ø³Ø§Ø¹Ø©</small>'}
        
        <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p ? escapeHTML(p.name) : ""}" maxlength="50" required>
        <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p ? p.price : ""}" min="0" max="10000000" required>
        <select id="category">${categories.map(c => `<option ${p && p.category === c ? "selected" : ""}>${c}</option>`).join("")}</select>
        ${sellerField}
        <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p ? p.phone : ""}" pattern="[0][0-9]{10}" required>
        <small style="color:#9ca3af; font-size:12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…</small>
        <select id="province">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
          ${provinces.map(pr => `<option ${p && p.province === pr ? "selected" : ""}>${pr}</option>`).join("")}
        </select>
        <select id="delivery">
          <option value="Ù†Ø¹Ù…" ${p && p.delivery === "Ù†Ø¹Ù…" ? "selected" : ""}>Ù†Ø¹Ù…</option>
          <option value="Ù„Ø§" ${p && p.delivery === "Ù„Ø§" ? "selected" : ""}>Ù„Ø§</option>
        </select>
        <select id="status" ${isAdmin || (p && p.uid === userUID) ? '' : 'disabled'}>
          <option value="available" ${p && p.status === "available" ? "selected" : ""}>Ù…ØªØ§Ø­</option>
          <option value="sold" ${p && p.status === "sold" ? "selected" : ""}>Ù…Ø¨Ø§Ø¹</option>
          <option value="reserved" ${p && p.status === "reserved" ? "selected" : ""}>Ù…Ø­Ø¬ÙˆØ²</option>
        </select>
        <small style="color:#9ca3af; font-size:12px;">${isAdmin ? 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†' : 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±'}</small>
        
        <!-- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
        <div class="image-upload-container">
          <label class="file-input-label">
            <i class="fas fa-images"></i> Ø§Ø®ØªØ± ØµÙˆØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2)
            <input type="file" id="images" accept="image/*" multiple onchange="handleImageSelect(event)">
          </label>
          <small style="color:#9ca3af; font-size:12px; display:block; margin-top:5px;">
            ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ (JPEG, PNG, WebP)
          </small>
          <div class="image-preview" id="imagePreview">
            ${p && p.images && p.images.length > 0 ? 
              p.images.map((img, idx) => `
                <div class="image-preview-item">
                  <img src="${img}" class="preview-image" alt="ØµÙˆØ±Ø© ${idx + 1}">
                  <small style="display:block; text-align:center; color:#9ca3af;">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ${idx + 1}</small>
                </div>
              `).join('') : 
              '<div style="color:#9ca3af; text-align:center; padding:20px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±</div>'
            }
          </div>
        </div>

        <button onclick="saveProduct('${k || ""}')" id="saveBtn" ${!p && !canPublishNow ? 'disabled class="timer-disabled"' : ''}>
          ğŸ’¾ ${p ? "ØªØ­Ø¯ÙŠØ«" : "Ù†Ø´Ø±"}
        </button>
        
        ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
      </div>`;
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…ØªØ§Ø­
      if (!p && !canPublishNow) {
        updatePublishTimerDisplay();
      }
      
      progressManager.hideTopProgressBar();
    }, 300);
}

// ===== Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± =====
async function saveProduct(k){
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
  if (!k) {
    const canPublishNow = await checkPublishPermission();
    if (!canPublishNow) {
      progressManager.showError("ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯");
      return;
    }
  }
  
  const name = document.getElementById("name").value.trim();
  const price = document.getElementById("price").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const province = document.getElementById("province").value;
  
  if (!name || !price || !phone || !province) {
    progressManager.showError("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }
  
  if (name.length < 3 || name.length > 50) {
    progressManager.showError("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
    return;
  }
  
  const priceNum = parseFloat(price);
  if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
    progressManager.showError("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
    return;
  }
  
  if(!/^[0][0-9]{10}$/.test(phone)){
    progressManager.showError("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
    return;
  }
  
  if (!province) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
    return;
  }

  const seller = userDisplayName || document.getElementById("seller").value.trim();
  
  if (!seller || seller.length < 2) {
    progressManager.showError("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
    return;
  }

  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  saveBtn.disabled = true;
  
  progressManager.showOverlay(k ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..." : "Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù† Ø®Ø§ØµØ© Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±");
  
  try {
    let imageUrls = [];
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„Ø§Ù‹ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (k) {
      const productRef = db.ref("products/" + k);
      const snapshot = await productRef.once("value");
      const existingProduct = snapshot.val();
      if (existingProduct && existingProduct.images) {
        imageUrls = existingProduct.images;
      }
    }
    
    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ Supabase
    if (selectedImages.length > 0) {
      progressManager.updateOverlayText("Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±...", "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
      
      // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      const uploadedUrls = await ImageManager.uploadProductImages(k || Date.now().toString(), selectedImages);
      if (uploadedUrls.length > 0) {
        imageUrls = uploadedUrls;
      }
    }
    
    // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
    const data = {
      name: name,
      price: priceNum,
      category: document.getElementById("category").value,
      seller: seller,
      phone: phone,
      province: province,
      delivery: document.getElementById("delivery").value,
      status: document.getElementById("status").value || "available",
      uid: userUID,
      lastUpdated: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (imageUrls.length > 0) {
      data.images = imageUrls;
    }
    
    if (!k) {
      data.createdAt = firebase.database.ServerValue.TIMESTAMP;
      data.timestamp = firebase.database.ServerValue.TIMESTAMP;
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Firebase
    const ref = k ? db.ref("products/"+k) : db.ref("products").push();
    await ref.set(data);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
    if (!k && userUID) {
      // Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ±
      saveLastPublishTime();
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      db.ref('users/' + userUID).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          db.ref('users/' + userUID).update({
            totalProducts: currentCount + 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        } else {
          db.ref('users/' + userUID).update({
            totalProducts: 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
    if (userUID) {
      const activityType = k ? 'product_updated' : 'product_created';
      db.ref("userActivity/" + userUID).push().set({
        type: activityType,
        productId: k || ref.key,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    progressManager.showSuccess(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    selectedImages = [];
    imagePreviewUrls = [];
    
    setTimeout(() => {
      showHome();
    }, 1000);
    
  } catch (error) {
    console.error("Error saving product:", error);
    progressManager.hideOverlay();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  } finally {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// ===== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ Ø§Ù„ØµÙˆØ± =====
function showDetails(k){
  progressManager.showCircularProgress();
  
  db.ref("products/"+k).once("value",snap=>{
    const p = snap.val();
    if(!p) {
      progressManager.hideCircularProgress();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹
    let isVerified = false;
    let sellerDisplayName = p.seller || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    
    if (p.uid) {
      db.ref('users/' + p.uid).once('value', (userSnap) => {
        const userData = userSnap.val();
        if (userData) {
          isVerified = userData.isVerified || false;
          
          // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„
          const imagesHTML = p.images && p.images.length > 0 
            ? ImageManager.createImageSlider(p.images, k + '-details')
            : '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
          
          const sellerWithLink = userDisplayName ? 
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">
              <span class="user-name-wrapper">
                ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                ${p.seller}
              </span>
            </span></p>
            <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> 
              <span class="user-name-wrapper">
                ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                ${p.seller}
              </span>
            </p>`;
          
          const statusText = p.status ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${p.status}">${getStatusText(p.status)}</span></p>` : '';
          
          const detailsContent = `
            <h2>${escapeHTML(p.name)}</h2>
            ${imagesHTML}
            <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
            <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            ${statusText}
            ${sellerWithLink}
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
            <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
            ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
            ${isAdmin ? `<p style="color:#8b5cf6; font-size:12px; margin-top:10px;">Ø§Ù„Ù…Ø¹Ø±Ù: ${k}</p>` : ""}
          `;
          
          document.getElementById("detailsContent").innerHTML = detailsContent;
        }
      });
    }
    
    // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    const imagesHTML = p.images && p.images.length > 0 
      ? ImageManager.createImageSlider(p.images, k + '-details')
      : '<div class="no-image">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø©</div>';
    
    const statusText = p.status ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${p.status}">${getStatusText(p.status)}</span></p>` : '';
    
    const initialContent = `
      <h2>${escapeHTML(p.name)}</h2>
      ${imagesHTML}
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      ${statusText}
      <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> 
        <span class="user-name-wrapper">
          ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
          ${p.seller}
        </span>
      </p>
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
      ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
      ${isAdmin ? `<p style="color:#8b5cf6; font-size:12px; margin-top:10px;">Ø§Ù„Ù…Ø¹Ø±Ù: ${k}</p>` : ""}
    `;
    
    document.getElementById("detailsContent").innerHTML = initialContent;
    document.getElementById("detailsDialog").style.display="block";
    progressManager.hideCircularProgress();
  }).catch(error => {
    console.error("Error loading details:", error);
    progressManager.hideCircularProgress();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
  });
}

function closeDetails(){
  document.getElementById("detailsDialog").style.display="none";
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
  const authSection = document.getElementById("authSection");
  
  if (!authSection) return;
  
  if (currentUser && userDisplayName) {
    db.ref("users/" + currentUser.uid).once("value", snapshot => {
      const userData = snapshot.val();
      const displayName = userData ? (userData.fullName || userDisplayName) : userDisplayName;
      
      isAdmin = userData && userData.isAdmin === true;
      const isVerified = userData && userData.isVerified === true;
      
      authSection.innerHTML = `
        <div class="user-info">
          <p class="profile-link" onclick="viewMyProfile()">
            <span class="user-name-wrapper">
              ${isVerified ? '<span class="verified-badge">âœ“</span>' : ''}
              ${displayName}
              ${isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
            </span>
          </p>
          <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
          <small style="color:#9ca3af; font-size:11px; display:block; margin:5px 0;">${userData ? userData.totalProducts || 0 : 0} Ø¥Ø¹Ù„Ø§Ù†</small>
          <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          ${isAdmin ? `
          <button onclick="showAdminPanel()" style="
            width: 100%;
            padding: 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
          ">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>` : ''}
        </div>
      `;
    });
  } else {
    authSection.innerHTML = `
      <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <div style="color:#9ca3af; font-size:12px; text-align:center; padding:10px;">
        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØªÙŠØ­ Ù„Ùƒ:
        <div style="font-size:11px; margin-top:5px;">
          âœ“ Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ<br>
          âœ“ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†<br>
          âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ<br>
          âœ“ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ùƒ
        </div>
      </div>
    `;
  }
}

function logoutUser() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
    progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...", "Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹");
    
    auth.signOut()
      .then(() => {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        updateAuthUI();
        showHome();
        progressManager.showSuccess("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      })
      .catch((error) => {
        console.error("Logout error:", error);
        progressManager.hideOverlay();
        progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      });
  }
}

function viewProfile(userId, sellerName) {
  if (sellerName) {
    localStorage.setItem('profileSellerName', sellerName);
  }
  
  progressManager.showTopProgressBar();
  setTimeout(() => {
    window.location.href = `profile.html?id=${userId}`;
  }, 300);
}

function viewMyProfile() {
  if (currentUser && currentUser.uid) {
    progressManager.showTopProgressBar();
    setTimeout(() => {
      window.location.href = `profile.html?id=${currentUser.uid}`;
    }, 300);
  } else {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1500);
  }
}

function showAdminPanel() {
  if (isAdmin) {
    progressManager.showTopProgressBar();
    setTimeout(() => {
      window.location.href = 'admin.html';
    }, 300);
  } else {
    progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„");
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatPrice(price) {
  return parseInt(price).toLocaleString('ar-SA');
}

function getStatusText(status) {
  const statuses = {
    'available': 'Ù…ØªØ§Ø­',
    'sold': 'Ù…Ø¨Ø§Ø¹',
    'reserved': 'Ù…Ø­Ø¬ÙˆØ²'
  };
  return statuses[status] || status;
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    userUID = user.uid;
    
    if (user.email) {
      db.ref("users/" + user.uid).once("value", snapshot => {
        const userData = snapshot.val();
        if (userData) {
          userDisplayName = userData.username;
          userFullName = userData.fullName;
          isAdmin = userData.isAdmin === true;
          updateAuthUI();
          
          db.ref("users/" + user.uid).update({
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          checkPublishPermission();
        }
      });
    } else {
      userDisplayName = "Ø²Ø§Ø¦Ø±";
      updateAuthUI();
    }
  } else {
    currentUser = null;
    userDisplayName = null;
    userFullName = null;
    isAdmin = false;
    updateAuthUI();
  }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
  showHome();
  updateAuthUI();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  setTimeout(() => {
    checkPublishPermission();
  }, 1000);
  
  document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    e.preventDefault();
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
      e.preventDefault();
    }
  });
  
  // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Supabase
  setTimeout(async () => {
    console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Supabase...');
    try {
      const { data, error } = await supabaseClient.storage
        .from('ads-images')
        .list();
      
      if (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Supabase:', error.message);
      } else {
        console.log('âœ… Ø§ØªØµØ§Ù„ Supabase Ù†Ø´Ø·ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª:', data?.length || 0);
      }
    } catch (err) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', err);
    }
  }, 2000);
});
</script>
</body>
</html>
