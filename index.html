<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Budget Dialog ===== */
.budget-btn { margin-left: 10px; background:#1f2937; color:#e5e7eb; border:none; padding:5px 10px; cursor:pointer; border-radius:5px; }
.budget-dialog { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#0f1115; color:#e5e7eb; padding:20px; border-radius:10px; box-shadow:0 0 10px #000; z-index:1000; display:none; }
.budget-dialog input { width:100%; padding:5px; margin:10px 0; border-radius:5px; border:1px solid #333; background:#1f1f1f; color:#e5e7eb; }
.budget-dialog button { padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#0f1115; color:#e5e7eb; padding:20px; border-radius:10px; box-shadow:0 0 10px #000; z-index:1001; display:none; }
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Auth Forms ===== */
.auth-form { background:#0f1115; color:#e5e7eb; padding:20px; border-radius:10px; max-width:400px; margin:20px auto; }
.auth-form input { width:100%; padding:8px; margin:10px 0; border-radius:5px; border:1px solid #333; background:#1f1f1f; color:#e5e7eb; }
.auth-form button { padding:8px 12px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }
.auth-form .error { color:#ef4444; margin-top:5px; }

/* ===== Sidebar Auth Buttons ===== */
.auth-buttons { margin-top:20px; }
.auth-buttons button { width:100%; margin-bottom:5px; padding:8px; border:none; border-radius:5px; cursor:pointer; background:#1f2937; color:#e5e7eb; }
.auth-buttons button:hover { background:#38bdf8; color:#000; }
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>

    <div class="auth-buttons">
      <button onclick="showLogin()">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button onclick="showRegister()">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <button id="logoutBtn" style="display:none;" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebaseapp.com",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};
firebase.initializeApp(firebaseConfig);

firebase.auth().signInAnonymously().catch(err => console.error(err));
const db = firebase.database();
let userUID = null;
firebase.auth().onAuthStateChanged(u => { if(u) userUID = u.uid; });

// ===== Categories & Provinces =====
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];
let budget = null;
let currentUser = null;

// ===== Pagination =====
let currentPage = 1;
const postsPerPage = 6;

// ===== Sidebar =====
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}
function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// ===== Home Page =====
function showHome(){
  closeSidebar();
  document.getElementById("content").innerHTML = `
    <div class="search-bar">
      <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()">
      <select id="cat" onchange="loadProducts()">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
        ${categories.map(c=>`<option>${c}</option>`).join("")}
      </select>
      <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
    </div>
    <div class="cards" id="products"></div>
    <div id="pagination" style="text-align:center;margin:20px"></div>
  `;
  loadProducts();
}

// ===== Budget =====
function showBudgetDialog(){ document.getElementById("budgetDialog").style.display="block"; }
function closeBudget(){ document.getElementById("budgetDialog").style.display="none"; }
function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  budget = !isNaN(val) ? val : null;
  closeBudget();
  loadProducts();
}

// ===== Load Products =====
function loadProducts(){
  const s = document.getElementById("search").value.toLowerCase();
  const c = document.getElementById("cat").value;

  db.ref("products").once("value", snap=>{
    const d = snap.val() || {};
    let htmlCards = [];

    Object.keys(d).forEach(k=>{
      const p = d[k];
      const price = parseFloat(p.price) || 0;
      if((!c || p.category===c) && p.name.toLowerCase().includes(s)){
        if(budget && price > budget) return;
        htmlCards.push({uid:p.uid,key:k,html:`
          <div class="card" onclick="showDetails('${k}')">
            <h3>${p.name}</h3>
            <span class="price">${p.price} Ø¯.Ø¹</span>
            <div class="meta">
              <span>${p.category}</span>
              <span>${p.province}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery}</span>
            </div>
            <div class="seller">
              ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
            </div>
            <div class="actions">
              ${p.uid===userUID?`
              <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
            </div>
          </div>
        `});
      }
    });

    if(currentUser){
      htmlCards = htmlCards.sort((a,b)=> b.uid===userUID ? 1 : -1);
    }

    const totalPages = Math.ceil(htmlCards.length / postsPerPage);
    if(currentPage > totalPages) currentPage = 1;
    const start = (currentPage-1)*postsPerPage;
    const pageItems = htmlCards.slice(start, start+postsPerPage);

    let finalHTML = pageItems.map(p=>p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    document.getElementById("products").innerHTML = finalHTML;

    renderPagination(totalPages);
  });
}

// ===== Pagination =====
function renderPagination(total){
  let html = "";
  for(let i=1;i<=total;i++){
    html += `<button onclick="goPage(${i})"
      style="
        margin:3px;
        padding:6px 10px;
        border-radius:5px;
        border:none;
        cursor:pointer;
        background:${i===currentPage?'#38bdf8':'#1f2937'};
        color:${i===currentPage?'#000':'#fff'};
      ">${i}</button>`;
  }
  document.getElementById("pagination").innerHTML = html;
}
function goPage(p){ currentPage = p; loadProducts(); }

// ===== Delete / Edit / Publish =====
function deleteProduct(k){ if(confirm("Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) db.ref("products/"+k).remove().then(loadProducts); }
function editProduct(k){ db.ref("products/"+k).once("value",s=>showPublish(s.val(),k)); }

function showPublish(p=null,k=null){
  closeSidebar();
  const sellerName = currentUser?currentUser.username:"";
  document.getElementById("content").innerHTML = `
    <div class="form-box">
      <h2>${p?"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†":"Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p?p.name:""}">
      <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p?p.price:""}">
      <select id="category">${categories.map(c=>`<option ${p&&p.category===c?"selected":""}>${c}</option>`).join("")}</select>
      <input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" readonly>
      <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p?p.phone:""}">
      <select id="province">${provinces.map(pr=>`<option ${p&&p.province===pr?"selected":""}>${pr}</option>`).join("")}</select>
      <select id="delivery">
        <option ${p&&p.delivery==="Ù†Ø¹Ù…"?"selected":""}>Ù†Ø¹Ù…</option>
        <option ${p&&p.delivery==="Ù„Ø§"?"selected":""}>Ù„Ø§</option>
      </select>
      <button onclick="save('${k||""}')">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  `;
}

function save(k){
  const phone = document.getElementById("phone").value.trim();
  if(!/^[0][0-9]{10}$/.test(phone)){
    alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±.");
    return;
  }
  const data = {
    name: document.getElementById("name").value,
    price: document.getElementById("price").value,
    category: document.getElementById("category").value,
    seller: document.getElementById("seller").value,
    phone: phone,
    province: document.getElementById("province").value,
    delivery: document.getElementById("delivery").value,
    uid: userUID
  };
  const ref = k?db.ref("products/"+k):db.ref("products").push();
  ref.set(data).then(showHome);
}

// ===== Product Details =====
function showDetails(k){
  db.ref("products/"+k).once("value",snap=>{
    const p = snap.val();
    if(!p) return;
    document.getElementById("detailsContent").innerHTML = `
      <h2>${p.name}</h2>
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${p.price} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category}</p>
      <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${p.seller}</p>
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery}</p>
    `;
    document.getElementById("detailsDialog").style.display="block";
  });
}
function closeDetails(){ document.getElementById("detailsDialog").style.display="none"; }

// ===== Auth =====
function showRegister(){
  closeSidebar();
  document.getElementById("content").innerHTML = `
    <div class="auth-form">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
      <input id="regUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ ÙÙ‚Ø·)" maxlength="10">
      <input id="regEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input id="regPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button onclick="registerUser()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <div class="error" id="regError"></div>
    </div>
  `;
}
function showLogin(){
  closeSidebar();
  document.getElementById("content").innerHTML = `
    <div class="auth-form">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
      <input id="loginUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" maxlength="10">
      <input id="loginPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button onclick="loginUser()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <div class="error" id="loginError"></div>
    </div>
  `;
}
function registerUser(){
  const username = document.getElementById("regUsername").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();
  const error = document.getElementById("regError");

  if(!/^[A-Za-z]{1,10}$/.test(username)){ error.textContent="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù†ÙƒÙ„ÙŠØ²ÙŠ ÙÙ‚Ø· ÙˆØ¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10 Ø£Ø­Ø±Ù"; return; }
  if(!email || !password){ error.textContent="ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"; return; }

  db.ref("users").orderByChild("username").equalTo(username).once("value", snap=>{
    if(snap.exists()){ error.textContent="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¬ÙˆØ² Ù…Ø³Ø¨Ù‚Ø§Ù‹"; return; }
    firebase.auth().createUserWithEmailAndPassword(email,password)
      .then(res=>{
        const uid = res.user.uid;
        db.ref("users/"+uid).set({username,email,createdAt:Date.now()});
        currentUser={uid,username,email};
        updateAuthButtons();
        showHome();
      })
      .catch(err=> error.textContent=err.message);
  });
}
function loginUser(){
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  const error = document.getElementById("loginError");

  if(!username || !password){ error.textContent="ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"; return; }

  db.ref("users").orderByChild("username").equalTo(username).once("value", snap=>{
    if(!snap.exists()){ error.textContent="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; return; }
    const userData = Object.values(snap.val())[0];
    const userUID_ = Object.keys(snap.val())[0];
    firebase.auth().signInWithEmailAndPassword(userData.email,password)
      .then(res=>{
        currentUser={uid:userUID_,username:userData.username,email:userData.email};
        updateAuthButtons();
        showHome();
      })
      .catch(err=>error.textContent="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  });
}
function logout(){
  firebase.auth().signOut().then(()=>{ currentUser=null; updateAuthButtons(); showHome(); });
}
function updateAuthButtons(){
  document.querySelector(".auth-buttons button[onclick='showLogin()']").style.display=currentUser?"none":"inline-block";
  document.querySelector(".auth-buttons button[onclick='showRegister()']").style.display=currentUser?"none":"inline-block";
  document.getElementById("logoutBtn").style.display=currentUser?"inline-block":"none";
}

// ===== Initialize
