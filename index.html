<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ===== */
.verified-badge {
    display: inline-flex;
    align-items: center;
    background: #10b981;
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-right: 5px;
    vertical-align: middle;
}

.verified-icon {
    font-size: 10px;
    margin-left: 2px;
}

.user-name-wrapper {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ===== */
.product-status {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 5px;
  display: inline-block;
}

.status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
.status-sold { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.status-reserved { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

.admin-badge {
  background: #8b5cf6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-right: 5px;
}

.security-warning {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  text-align: center;
}

.session-timeout {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(245, 158, 11, 0.9);
  color: #000;
  padding: 10px 15px;
  border-radius: 6px;
  z-index: 2000;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± ===== */
.publish-timer {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 14px;
  text-align: center;
  direction: ltr;
}

.publish-timer.active {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: #10b981;
}

.timer-disabled {
  opacity: 0.6;
  cursor: not-allowed !important;
}

.timer-disabled button {
  background: #6b7280 !important;
  cursor: not-allowed !important;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ===== */
.image-upload-section {
    margin: 15px 0;
    padding: 15px;
    background: #1f2937;
    border-radius: 8px;
    border: 2px dashed #374151;
}

.image-upload-section h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #38bdf8;
    font-size: 16px;
}

.image-upload-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.image-upload-box {
    flex: 1;
    min-width: 150px;
    aspect-ratio: 1/1;
    border: 2px dashed #4b5563;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background: #111827;
    transition: border-color 0.3s;
}

.image-upload-box:hover {
    border-color: #38bdf8;
}

.image-upload-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
}

.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 14px;
}

.upload-placeholder i {
    font-size: 24px;
    margin-bottom: 5px;
}

.remove-image-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
    display: none;
    z-index: 2;
}

.image-upload-box:hover .remove-image-btn {
    display: block;
}

.image-preview {
    width: 100%;
    height: 100%;
}

.image-input {
    display: none;
}

.image-error {
    color: #ef4444;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ===== */
.product-images {
    display: flex;
    gap: 10px;
    margin: 10px 0;
    flex-wrap: wrap;
}

.product-image {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid #374151;
    cursor: pointer;
    transition: transform 0.2s;
}

.product-image:hover {
    transform: scale(1.05);
}

.image-modal {
    display: none;
    position: fixed;
    z-index: 1002;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
}

.modal-content {
    max-width: 90%;
    max-height: 90%;
}

.close-modal {
    position: absolute;
    top: 20px;
    right: 30px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
@media (max-width: 768px) {
    .user-name-wrapper {
        flex-wrap: wrap;
    }
    
    .verified-badge {
        font-size: 9px;
        padding: 1px 4px;
    }
    
    .seller-link {
        font-size: 14px;
    }
    
    .image-upload-container {
        flex-direction: column;
    }
    
    .image-upload-box {
        width: 100%;
        min-width: unset;
    }
    
    .product-image {
        width: 80px;
        height: 80px;
    }
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<!-- Progress Bar System -->
<div class="top-progress-bar" id="topProgressBar">
    <div class="progress-bar-line" id="progressBarLine"></div>
</div>

<div class="circular-progress" id="circularProgress">
    <svg viewBox="0 0 36 36">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#38bdf8" />
                <stop offset="100%" stop-color="#0ea5e9" />
            </linearGradient>
        </defs>
        <circle class="progress-bg" cx="18" cy="18" r="16"></circle>
        <circle class="progress-fill" cx="18" cy="18" r="16" 
                stroke-dasharray="100" stroke-dashoffset="100"></circle>
    </svg>
</div>

<div class="progress-overlay" id="progressOverlay">
    <div class="progress-overlay-content">
        <div class="progress-overlay-spinner"></div>
        <div class="progress-overlay-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="progress-overlay-subtext" id="progressSubtext">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>
</div>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<!-- Budget Dialog -->
<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Product Details Dialog -->
<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- Image Modal -->
<div class="image-modal" id="imageModal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

<!-- Session Timeout Warning -->
<div class="session-timeout" id="sessionTimeout">
  <span id="timeoutMessage">Ø³ØªÙ†ØªÙ‡ÙŠ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„ Ø®Ù„Ø§Ù„ <span id="timeoutTimer">60</span> Ø«Ø§Ù†ÙŠØ©</span>
  <button onclick="extendSession()" style="
    background: #000;
    color: #f59e0b;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    margin-right: 10px;
    cursor: pointer;
    font-size: 12px;
  ">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const analytics = firebase.analytics();

// Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
const supabaseUrl = 'https://dnclbdvdzvtdjpgxwnrl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuY2xiZHZkenZ0ZGpwZ3h3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0NzgwNDQsImV4cCI6MjA1ODA1NDA0NH0.5S0qq4RqOQ_YtlsIJr2NnV15jY1lXPK6vOYglPVp92s';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ===== Progress Bar System =====
class ProgressManager {
    constructor() {
        this.topProgressBar = document.getElementById('topProgressBar');
        this.progressBarLine = document.getElementById('progressBarLine');
        this.circularProgress = document.getElementById('circularProgress');
        this.progressOverlay = document.getElementById('progressOverlay');
        this.progressText = document.getElementById('progressText');
        this.progressSubtext = document.getElementById('progressSubtext');
        
        this.currentProgress = 0;
        this.progressInterval = null;
        this.isLoading = false;
        
        this.init();
    }
    
    init() {
        this.updateCircularProgress(0);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    showTopProgressBar() {
        this.topProgressBar.style.display = 'block';
        this.progressBarLine.style.width = '0%';
        this.progressBarLine.className = 'progress-bar-line';
        
        this.currentProgress = 0;
        clearInterval(this.progressInterval);
        
        this.progressInterval = setInterval(() => {
            if (this.currentProgress < 90) {
                this.currentProgress += Math.random() * 10;
                this.updateTopProgress(this.currentProgress);
            }
        }, 200);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ
    updateTopProgress(percent) {
        this.progressBarLine.style.width = `${Math.min(percent, 100)}%`;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Progress Bar Ø§Ù„Ø¹Ù„ÙˆÙŠ
    hideTopProgressBar() {
        clearInterval(this.progressInterval);
        this.updateTopProgress(100);
        
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.currentProgress = 0;
        }, 300);
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    showCircularProgress() {
        this.circularProgress.style.display = 'block';
        this.updateCircularProgress(0);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            this.updateCircularProgress(progress);
            
            if (progress >= 100) {
                progress = 0;
            }
        }, 200);
        
        return () => clearInterval(interval);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    updateCircularProgress(percent) {
        const circle = this.circularProgress.querySelector('.progress-fill');
        if (circle) {
            const offset = 100 - percent;
            circle.style.strokeDashoffset = offset;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
    hideCircularProgress() {
        this.circularProgress.style.display = 'none';
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Overlay ÙƒØ§Ù…Ù„
    showOverlay(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', subtext = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
        this.isLoading = true;
        this.progressText.textContent = text;
        this.progressSubtext.textContent = subtext;
        this.progressOverlay.classList.add('active');
        
        document.body.style.overflow = 'hidden';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù€ Overlay
    updateOverlayText(text, subtext = null) {
        this.progressText.textContent = text;
        if (subtext !== null) {
            this.progressSubtext.textContent = subtext;
        }
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Overlay
    hideOverlay() {
        this.isLoading = false;
        this.progressOverlay.classList.remove('active');
        
        setTimeout(() => {
            document.body.style.overflow = '';
        }, 300);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showSuccess(message = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!') {
        this.progressBarLine.className = 'progress-bar-line progress-success';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø®Ø·Ø£
    showError(message = 'Ø­Ø¯Ø« Ø®Ø·Ø£!') {
        this.progressBarLine.className = 'progress-bar-line progress-error';
        this.updateOverlayText(message, 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 2000);
    }
    
    // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
    showWarning(message = 'ØªØ­Ø°ÙŠØ±!') {
        this.progressBarLine.className = 'progress-bar-line progress-warning';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Skeleton Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    createSkeletonCards(count = 6) {
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
                <div class="skeleton-card">
                    <div class="skeleton-line" style="height: 20px; width: 70%"></div>
                    <div class="skeleton-line" style="height: 16px; width: 40%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 60%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 50%"></div>
                    <div class="skeleton-line" style="height: 12px; width: 80%"></div>
                </div>
            `;
        }
        return skeletonHTML;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Progress Manager
const progressManager = new ProgressManager();

let userUID = null;
auth.onAuthStateChanged(u => {
    if (u) {
        userUID = u.uid;
        if (u.email) {
            db.ref("users/" + u.uid).update({
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }
});

// Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
const provinces = ["Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¨ØµØ±Ø©","Ø§Ù„Ù…ÙˆØµÙ„","Ø£Ø±Ø¨ÙŠÙ„","Ø¯Ù‡ÙˆÙƒ","Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©","Ù†ÙŠÙ†ÙˆÙ‰","Ø§Ù„Ø£Ù†Ø¨Ø§Ø±","Ø°ÙŠ Ù‚Ø§Ø±","Ø¨Ø§Ø¨Ù„","ÙƒØ±Ø¨Ù„Ø§Ø¡","ÙˆØ§Ø³Ø·","Ø§Ù„Ø¯ÙŠÙˆØ§Ù†ÙŠØ©","Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†","Ø§Ù„Ù…Ø«Ù†Ù‰","Ù…ÙŠØ³Ø§Ù†","Ø§Ù„Ù†Ø¬Ù","ÙƒØ±ÙƒÙˆÙƒ"];
let budget = null;

/* ===== Pagination Variables ===== */
let currentPage = 1;
const postsPerPage = 6;

// ===== Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
let currentUser = null;
let userDisplayName = null;
let userFullName = null;
let isAdmin = false;

// ===== Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± =====
let canPublish = true;
let publishTimer = null;
let publishTimeLeft = 0;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
let sessionTimeout = null;
let sessionWarning = null;
const SESSION_DURATION = 60 * 60 * 1000;
const SESSION_WARNING = 5 * 60 * 1000;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± =====
let selectedImages = [];
let existingImages = [];

// ===== Ø¯Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† =====
function showSecurityWarning(message) {
    const content = document.getElementById('content');
    if (content) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'security-warning';
        warningDiv.innerHTML = `âš ï¸ ${message}`;
        content.insertBefore(warningDiv, content.firstChild);
        
        setTimeout(() => {
            warningDiv.style.opacity = '0';
            setTimeout(() => warningDiv.remove(), 500);
        }, 5000);
    }
}

// ===== Ù†Ø¸Ø§Ù… Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù† (Ù…Ø¹ Firebase) =====
function checkPublishPermission() {
    if (!userUID) {
        canPublish = true;
        return true;
    }
    
    progressManager.showCircularProgress();
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ù† Firebase
    const serverTimeRef = db.ref('.info/serverTimeOffset');
    
    return new Promise((resolve) => {
        serverTimeRef.once('value', (snapshot) => {
            const serverTimeOffset = snapshot.val() || 0;
            const serverTime = Date.now() + serverTimeOffset;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase
            db.ref('users/' + userUID + '/lastPublish').once('value', (userSnap) => {
                progressManager.hideCircularProgress();
                
                const lastPublish = userSnap.val();
                if (!lastPublish) {
                    canPublish = true;
                    resolve(true);
                    return;
                }
                
                const timeDiff = serverTime - lastPublish;
                const oneHour = 60 * 60 * 1000;
                
                if (timeDiff < oneHour) {
                    canPublish = false;
                    publishTimeLeft = Math.ceil((oneHour - timeDiff) / 1000);
                    startPublishTimer();
                    resolve(false);
                } else {
                    canPublish = true;
                    resolve(true);
                }
            });
        }).catch((error) => {
            console.error("Error checking publish permission:", error);
            progressManager.hideCircularProgress();
            canPublish = true;
            resolve(true);
        });
    });
}

// ===== Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø´Ø± =====
function startPublishTimer() {
    if (publishTimer) {
        clearInterval(publishTimer);
    }
    
    updatePublishTimerDisplay();
    
    publishTimer = setInterval(() => {
        if (publishTimeLeft > 0) {
            publishTimeLeft--;
            updatePublishTimerDisplay();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª
            if (publishTimeLeft <= 0) {
                clearInterval(publishTimer);
                canPublish = true;
                updatePublishTimerDisplay();
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø´Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                if (document.getElementById('publishTimer')) {
                    const timerElement = document.getElementById('publishTimer');
                    timerElement.innerHTML = `
                        <div class="publish-timer active">
                            âœ“ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                            <br><small style="color:#9ca3af;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</small>
                        </div>
                    `;
                    
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('timer-disabled');
                        saveBtn.innerHTML = 'ğŸ’¾ Ù†Ø´Ø±';
                    }
                }
            }
        }
    }, 1000);
}

// ===== ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ù‚Øª =====
function updatePublishTimerDisplay() {
    const minutes = Math.floor(publishTimeLeft / 60);
    const seconds = publishTimeLeft % 60;
    
    const timerElement = document.getElementById('publishTimer');
    if (timerElement) {
        timerElement.innerHTML = `
            <div class="publish-timer">
                â° ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} 
                Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
                <br><small style="color:#9ca3af;">Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±</small>
            </div>
        `;
    }
}

// ===== Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Firebase =====
function saveLastPublishTime() {
    if (!userUID) return;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ù† Firebase
    const serverTimeRef = db.ref('.info/serverTimeOffset');
    
    serverTimeRef.once('value', (snapshot) => {
        const serverTimeOffset = snapshot.val() || 0;
        const serverTime = Date.now() + serverTimeOffset;
        
        // Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        db.ref('users/' + userUID).update({
            lastPublish: serverTime
        }).then(() => {
            console.log("Publish time saved to Firebase");
        }).catch((error) => {
            console.error("Error saving publish time:", error);
        });
    });
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =====
function initSessionManagement() {
    ['click', 'mousemove', 'keypress', 'scroll'].forEach(event => {
        document.addEventListener(event, resetSessionTimer);
    });
    
    resetSessionTimer();
}

function resetSessionTimer() {
    if (sessionTimeout) clearTimeout(sessionTimeout);
    if (sessionWarning) clearTimeout(sessionWarning);
    
    document.getElementById('sessionTimeout').style.display = 'none';
    
    sessionWarning = setTimeout(() => {
        showSessionWarning();
    }, SESSION_DURATION - SESSION_WARNING);
    
    sessionTimeout = setTimeout(() => {
        handleSessionTimeout();
    }, SESSION_DURATION);
}

function showSessionWarning() {
    const timeoutDiv = document.getElementById('sessionTimeout');
    const timerSpan = document.getElementById('timeoutTimer');
    
    let secondsLeft = SESSION_WARNING / 1000;
    timerSpan.textContent = secondsLeft;
    timeoutDiv.style.display = 'block';
    
    const countdown = setInterval(() => {
        secondsLeft--;
        timerSpan.textContent = secondsLeft;
        
        if (secondsLeft <= 0) {
            clearInterval(countdown);
        }
    }, 1000);
}

function extendSession() {
    resetSessionTimer();
    showSecurityWarning("ØªÙ… ØªÙˆØ³ÙŠØ¹ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.");
}

function handleSessionTimeout() {
    if (currentUser && !currentUser.isAnonymous) {
        auth.signOut().then(() => {
            showSecurityWarning("Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ù…Ù„. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.");
            showHome();
            updateAuthUI();
        });
    }
    else {
        window.location.reload();
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± =====
function initImageUpload() {
    selectedImages = [];
    existingImages = [];
    
    const imageInputs = document.querySelectorAll('.image-input');
    imageInputs.forEach((input, index) => {
        input.addEventListener('change', function(e) {
            handleImageSelect(e, index);
        });
    });
}

function handleImageSelect(event, index) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        showImageError(index, 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© (JPEG, PNG, GIF)');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
    if (file.size > 5 * 1024 * 1024) {
        showImageError(index, 'Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageBox = document.getElementById(`imageBox${index}`);
        const imagePreview = imageBox.querySelector('.image-preview');
        const uploadPlaceholder = imageBox.querySelector('.upload-placeholder');
        
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        
        selectedImages[index] = file;
        hideImageError(index);
    };
    
    reader.readAsDataURL(file);
}

function showImageError(index, message) {
    const errorElement = document.getElementById(`imageError${index}`);
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function hideImageError(index) {
    const errorElement = document.getElementById(`imageError${index}`);
    errorElement.style.display = 'none';
}

function removeImage(index) {
    selectedImages[index] = null;
    existingImages[index] = null;
    
    const imageBox = document.getElementById(`imageBox${index}`);
    const imagePreview = imageBox.querySelector('.image-preview');
    const uploadPlaceholder = imageBox.querySelector('.upload-placeholder');
    const imageInput = imageBox.querySelector('.image-input');
    
    imagePreview.style.display = 'none';
    imagePreview.src = '';
    uploadPlaceholder.style.display = 'flex';
    imageInput.value = '';
}

async function uploadImages(productId) {
    const imageUrls = [];
    
    for (let i = 0; i < 2; i++) {
        if (selectedImages[i]) {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… ÙØ±ÙŠØ¯ Ù„Ù„ØµÙˆØ±Ø©
                const fileName = `${productId}_${i}_${Date.now()}.${selectedImages[i].type.split('/')[1]}`;
                const filePath = `product-images/${fileName}`;
                
                // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Supabase
                const { data, error } = await supabase.storage
                    .from('product-images')
                    .upload(filePath, selectedImages[i]);
                
                if (error) throw error;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
                const { data: urlData } = supabase.storage
                    .from('product-images')
                    .getPublicUrl(filePath);
                
                imageUrls.push(urlData.publicUrl);
                
            } catch (error) {
                console.error(`Error uploading image ${i}:`, error);
                throw new Error(`ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}`);
            }
        } else if (existingImages[i]) {
            // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            imageUrls.push(existingImages[i]);
        }
    }
    
    return imageUrls;
}

async function deleteOldImages(oldImageUrls) {
    if (!oldImageUrls || oldImageUrls.length === 0) return;
    
    for (const imageUrl of oldImageUrls) {
        try {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            const fileName = imageUrl.split('/').pop();
            const filePath = `product-images/${fileName}`;
            
            // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const { error } = await supabase.storage
                .from('product-images')
                .remove([filePath]);
            
            if (error) {
                console.warn(`Could not delete old image: ${fileName}`, error);
            }
        } catch (error) {
            console.warn(`Error deleting old image:`, error);
        }
    }
}

function openImageModal(imageUrl) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    
    modalImg.src = imageUrl;
    modal.style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Sidebar
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}
function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function showHome(){
  closeSidebar();
  progressManager.showTopProgressBar();
  
  setTimeout(() => {
    document.getElementById("content").innerHTML = `
      <div class="search-bar">
        <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()" maxlength="50">
        <select id="cat" onchange="loadProducts()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
          ${categories.map(c=>`<option>${c}</option>`).join("")}
        </select>
        <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
      </div>
      <div class="cards" id="products"></div>
      <div id="pagination" style="text-align:center;margin:20px"></div>
    `;
    loadProducts();
    progressManager.hideTopProgressBar();
  }, 300);
}

// Budget Dialog
function showBudgetDialog(){ document.getElementById("budgetDialog").style.display="block"; }
function closeBudget(){ document.getElementById("budgetDialog").style.display="none"; }
function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  
  if (isNaN(val) || val < 0) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©");
    return;
  }
  
  if (val > 10000000) {
    progressManager.showError("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");
    return;
  }
  
  budget = val;
  closeBudget();
  loadProducts();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function loadProducts(){
  const s = document.getElementById("search")?.value.toLowerCase() || '';
  const c = document.getElementById("cat")?.value || '';
  
  // Ø¹Ø±Ø¶ Skeleton Loading
  const productsContainer = document.getElementById('products');
  if (productsContainer) {
    productsContainer.innerHTML = progressManager.createSkeletonCards(6);
  }
  
  progressManager.showTopProgressBar();
  
  db.ref("products").once("value", snap=>{
    const d = snap.val() || {};
    let htmlCards = [];

    Object.keys(d).forEach(k=>{
      const p = d[k];
      
      if (!p || !p.name || !p.price) {
        return;
      }
      
      const price = parseFloat(p.price) || 0;
      if((!c || p.category===c) && p.name.toLowerCase().includes(s)){
        if(budget && price > budget) return;
        
        const status = p.status || 'available';
        let statusBadge = '';
        if (status !== 'available') {
          statusBadge = `<div class="product-status status-${status}">${getStatusText(status)}</div>`;
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹
        let sellerInfo = p.seller || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        let isVerified = false;
        
        if (p.uid) {
          db.ref('users/' + p.uid).once('value', (userSnap) => {
            const userData = userSnap.val();
            if (userData) {
              isVerified = userData.isVerified || false;
            }
          });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        let imagesHTML = '';
        if (p.images && Array.isArray(p.images) && p.images.length > 0) {
          imagesHTML = `
            <div class="product-images">
              ${p.images.slice(0, 2).map((img, idx) => `
                <img src="${img}" alt="ØµÙˆØ±Ø© ${idx + 1}" class="product-image" 
                     onclick="openImageModal('${img}')">
              `).join('')}
            </div>
          `;
        }
        
        const sellerSection = userDisplayName ? 
          `<div class="seller">
            ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">
              <span class="user-name-wrapper">
                ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                ${p.seller}
              </span>
            </span> 
            | â˜ ${p.phone}
            <br><small style="color:#9ca3af; font-size:11px;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</small>
          </div>` :
          `<div class="seller">
            ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
          </div>`;
        
        htmlCards.push({uid:p.uid,key:k,html:`
          <div class="card" onclick="showDetails('${k}')">
            <h3>${escapeHTML(p.name)}</h3>
            <span class="price">${formatPrice(p.price)} Ø¯.Ø¹</span>
            ${statusBadge}
            ${imagesHTML}
            <div class="meta">
              <span>${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery || 'Ù„Ø§'}</span>
            </div>
            ${sellerSection}
            <div class="actions">
              ${(p.uid===userUID || isAdmin)?`
              <button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>` : ""}
            </div>
          </div>
        `});
      }
    });

    if(userUID){
      htmlCards = htmlCards.sort((a,b)=> b.uid===userUID ? 1 : -1);
    }

    const totalPages = Math.ceil(htmlCards.length / postsPerPage);
    if(currentPage > totalPages) currentPage = 1;
    const start = (currentPage-1)*postsPerPage;
    const pageItems = htmlCards.slice(start, start+postsPerPage);

    let finalHTML = pageItems.map(p=>p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    
    if (productsContainer) {
      productsContainer.style.opacity = '0';
      setTimeout(() => {
        productsContainer.innerHTML = finalHTML;
        productsContainer.style.opacity = '1';
        renderPagination(totalPages);
        progressManager.hideTopProgressBar();
      }, 300);
    }
  }).catch(error => {
    console.error("Error loading products:", error);
    if (productsContainer) {
      productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    }
    progressManager.hideTopProgressBar();
    progressManager.showError("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
  });
}

// Render Pagination Buttons
function renderPagination(total){
  let html = "";
  for(let i=1;i<=total;i++){
    html += `
      <button onclick="goPage(${i})"
        style="
          margin:3px;
          padding:6px 10px;
          border-radius:5px;
          border:none;
          cursor:pointer;
          background:${i===currentPage?'#38bdf8':'#1f2937'};
          color:${i===currentPage?'#000':'#fff'};
        ">
        ${i}
      </button>`;
  }
  const pagination = document.getElementById('pagination');
  if (pagination) {
    pagination.innerHTML = html;
  }
}

function goPage(p){
  currentPage = p;
  loadProducts();
}

// Ø­Ø°Ù / ØªØ¹Ø¯ÙŠÙ„ / Ù†Ø´Ø±
async function deleteProduct(k){ 
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
    return;
  }
  
  progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
  
  try {
    const snapshot = await db.ref("products/" + k).once('value');
    const product = snapshot.val();
    
    if (!product) {
      progressManager.hideOverlay();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      progressManager.hideOverlay();
      progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    // Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ù…Ù† Supabase
    if (product.images && Array.isArray(product.images)) {
      await deleteOldImages(product.images);
    }
    
    if (product.uid) {
      const userSnapshot = await db.ref('users/' + product.uid).once('value');
      const userData = userSnapshot.val();
      if (userData) {
        const currentCount = userData.totalProducts || 0;
        if (currentCount > 0) {
          await db.ref('users/' + product.uid).update({
            totalProducts: currentCount - 1
          });
        }
      }
    }
    
    await db.ref("products/"+k).remove();
    
    progressManager.showSuccess("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
    loadProducts();
    
    if (userUID) {
      await db.ref("userActivity/" + userUID).push().set({
        type: 'product_deleted',
        productId: k,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
  } catch (error) {
    console.error("Delete error:", error);
    progressManager.hideOverlay();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  }
}

async function editProduct(k){ 
  progressManager.showTopProgressBar();
  
  try {
    const snapshot = await db.ref("products/"+k).once("value");
    const product = snapshot.val();
    
    if (!product) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    if (product.uid !== userUID && !isAdmin) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
      return;
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (product.images && Array.isArray(product.images)) {
      existingImages = [...product.images];
    }
    
    await showPublish(product, k);
    progressManager.hideTopProgressBar();
    
  } catch (error) {
    console.error("Edit error:", error);
    progressManager.hideTopProgressBar();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  }
}

// ===== ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© showPublish Ù„Ø¯Ø¹Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ§Ù„ØµÙˆØ± =====
async function showPublish(p=null,k=null){
  closeSidebar();
  
  progressManager.showTopProgressBar();
  
  setTimeout(async () => {
    if (!userUID && !currentUser) {
      const publishAnyway = confirm("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„ØŸ (Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø³ÙŠØ­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬)");
      if (!publishAnyway) {
        progressManager.hideTopProgressBar();
        showHome();
        return;
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± (Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·)
    let canPublishNow = true;
    if (!k) {
      canPublishNow = await checkPublishPermission();
    }
    
    const sellerName = userDisplayName || (p ? p.seller : "");
    const sellerField = userDisplayName ? 
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
       <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" maxlength="30">`;
    
    // ØªØ­Ø¶ÙŠØ± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let currentImagesHTML = '';
    if (p && p.images && Array.isArray(p.images)) {
      currentImagesHTML = `
        <div style="margin-bottom: 10px;">
          <small style="color:#38bdf8;">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</small>
          <div class="product-images">
            ${p.images.map((img, idx) => `
              <img src="${img}" alt="ØµÙˆØ±Ø© ${idx + 1}" class="product-image" 
                   onclick="openImageModal('${img}')">
            `).join('')}
          </div>
          <small style="color:#9ca3af; font-size:12px;">Ù„Ø­Ø°Ù ØµÙˆØ±Ø©ØŒ Ø£Ø²Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ£Ø¶Ù ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</small>
        </div>
      `;
    }
    
    document.getElementById("content").innerHTML = `
      <div class="form-box">
        <h2>${p?"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†":"Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
        
        ${!p && !canPublishNow ? `<div id="publishTimer"></div>` : ''}
        
        ${p ? '' : '<small style="color:#9ca3af; margin-bottom:15px; display:block;">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ ÙƒÙ„ Ø³Ø§Ø¹Ø©</small>'}
        
        <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p?escapeHTML(p.name):""}" maxlength="50" required>
        <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p?p.price:""}" min="0" max="10000000" required>
        <select id="category">${categories.map(c=>`<option ${p&&p.category===c?"selected":""}>${c}</option>`).join("")}</select>
        ${sellerField}
        <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p?p.phone:""}" pattern="[0][0-9]{10}" required>
        <small style="color:#9ca3af; font-size:12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 0 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…</small>
        <select id="province">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
          ${provinces.map(pr=>`<option ${p&&p.province===pr?"selected":""}>${pr}</option>`).join("")}
        </select>
        <select id="delivery">
          <option value="Ù†Ø¹Ù…" ${p&&p.delivery==="Ù†Ø¹Ù…"?"selected":""}>Ù†Ø¹Ù…</option>
          <option value="Ù„Ø§" ${p&&p.delivery==="Ù„Ø§"?"selected":""}>Ù„Ø§</option>
        </select>
        
        <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
        <div class="image-upload-section">
          <h3>ğŸ“· Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø­Ø¯ Ø£Ù‚ØµÙ‰ ØµÙˆØ±ØªÙŠÙ†)</h3>
          <small style="color:#9ca3af; font-size:12px; display:block; margin-bottom:10px;">JPEG, PNG, GIF - Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB Ù„ÙƒÙ„ ØµÙˆØ±Ø©</small>
          
          ${currentImagesHTML}
          
          <div class="image-upload-container">
            <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ -->
            <div class="image-upload-box" id="imageBox0" onclick="document.getElementById('imageInput0').click()">
              <div class="upload-placeholder">
                <i>ğŸ“·</i>
                <span>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</span>
              </div>
              <img class="image-preview" style="display:none;">
              <button type="button" class="remove-image-btn" onclick="removeImage(0); event.stopPropagation();">Ã—</button>
              <input type="file" accept="image/*" class="image-input" id="imageInput0">
            </div>
            <div class="image-error" id="imageError0"></div>
            
            <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© -->
            <div class="image-upload-box" id="imageBox1" onclick="document.getElementById('imageInput1').click()">
              <div class="upload-placeholder">
                <i>ğŸ“·</i>
                <span>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</span>
              </div>
              <img class="image-preview" style="display:none;">
              <button type="button" class="remove-image-btn" onclick="removeImage(1); event.stopPropagation();">Ã—</button>
              <input type="file" accept="image/*" class="image-input" id="imageInput1">
            </div>
            <div class="image-error" id="imageError1"></div>
          </div>
        </div>
        
        <select id="status" ${isAdmin || (p && p.uid === userUID) ? '' : 'disabled'}>
          <option value="available" ${p&&p.status==="available"?"selected":""}>Ù…ØªØ§Ø­</option>
          <option value="sold" ${p&&p.status==="sold"?"selected":""}>Ù…Ø¨Ø§Ø¹</option>
          <option value="reserved" ${p&&p.status==="reserved"?"selected":""}>Ù…Ø­Ø¬ÙˆØ²</option>
        </select>
        <small style="color:#9ca3af; font-size:12px;">${isAdmin ? 'ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†' : 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±'}</small>
        <button onclick="saveProduct('${k||""}')" id="saveBtn" ${!p && !canPublishNow ? 'disabled' : ''} ${!p && !canPublishNow ? 'class="timer-disabled"' : ''}>
          ğŸ’¾ ${p?"ØªØ­Ø¯ÙŠØ«":"Ù†Ø´Ø±"}
        </button>
        ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
      </div>`;
    
    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
    initImageUpload();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (p && p.images && Array.isArray(p.images)) {
      existingImages = p.images;
      for (let i = 0; i < Math.min(p.images.length, 2); i++) {
        if (p.images[i]) {
          const imageBox = document.getElementById(`imageBox${i}`);
          const imagePreview = imageBox.querySelector('.image-preview');
          const uploadPlaceholder = imageBox.querySelector('.upload-placeholder');
          
          imagePreview.src = p.images[i];
          imagePreview.style.display = 'block';
          uploadPlaceholder.style.display = 'none';
        }
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…ØªØ§Ø­
    if (!p && !canPublishNow) {
      updatePublishTimerDisplay();
    }
    
    progressManager.hideTopProgressBar();
  }, 300);
}

async function saveProduct(k){
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
  if (!k) {
    const canPublishNow = await checkPublishPermission();
    if (!canPublishNow) {
      progressManager.showError("ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯");
      return;
    }
  }
  
  const name = document.getElementById("name").value.trim();
  const price = document.getElementById("price").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const province = document.getElementById("province").value;
  
  if (!name || !price || !phone || !province) {
    progressManager.showError("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }
  
  if (name.length < 3 || name.length > 50) {
    progressManager.showError("Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 3 Ùˆ 50 Ø­Ø±Ù");
    return;
  }
  
  const priceNum = parseFloat(price);
  if (isNaN(priceNum) || priceNum < 0 || priceNum > 10000000) {
    progressManager.showError("Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 10,000,000 Ø¯ÙŠÙ†Ø§Ø±");
    return;
  }
  
  if(!/^[0][0-9]{10}$/.test(phone)){
    progressManager.showError("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
    return;
  }
  
  if (!province) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©");
    return;
  }

  const seller = userDisplayName || document.getElementById("seller").value.trim();
  
  if (!seller || seller.length < 2) {
    progressManager.showError("Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨ (2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
    return;
  }

  progressManager.showOverlay(k ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..." : "Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...", "Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†");
  
  try {
    let imageUrls = [];
    
    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    if (selectedImages.some(img => img !== null) || (k && existingImages.length > 0)) {
      // Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ¹Ø¯ÙŠÙ„
      if (k) {
        const oldProductSnapshot = await db.ref("products/" + k).once('value');
        const oldProduct = oldProductSnapshot.val();
        if (oldProduct && oldProduct.images) {
          await deleteOldImages(oldProduct.images);
        }
      }
      
      // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      imageUrls = await uploadImages(k || `temp_${Date.now()}`);
    }
    
    const data = {
      name: name,
      price: priceNum,
      category: document.getElementById("category").value,
      seller: seller,
      phone: phone,
      province: province,
      delivery: document.getElementById("delivery").value,
      status: document.getElementById("status").value || "available",
      uid: userUID,
      lastUpdated: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (imageUrls.length > 0) {
      data.images = imageUrls;
    }
    
    if (!k) {
      data.createdAt = firebase.database.ServerValue.TIMESTAMP;
      data.timestamp = firebase.database.ServerValue.TIMESTAMP;
    }
    
    const ref = k ? db.ref("products/"+k) : db.ref("products").push();
    const productId = k || ref.key;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ID Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹
    if (!k) {
      data.id = productId;
    }
    
    await ref.set(data);
    
    if (!k && userUID) {
      // Ø­ÙØ¸ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ Firebase Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
      saveLastPublishTime();
      
      const userSnapshot = await db.ref('users/' + userUID).once('value');
      const userData = userSnapshot.val();
      
      if (userData) {
        const currentCount = userData.totalProducts || 0;
        await db.ref('users/' + userUID).update({
          totalProducts: currentCount + 1,
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
      } else {
        await db.ref('users/' + userUID).update({
          totalProducts: 1,
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
      }
    }
    
    if (userUID) {
      const activityType = k ? 'product_updated' : 'product_created';
      await db.ref("userActivity/" + userUID).push().set({
        type: activityType,
        productId: productId,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    progressManager.showSuccess(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
    
    setTimeout(() => {
      showHome();
    }, 1000);
    
  } catch (error) {
    console.error("Error saving product:", error);
    progressManager.hideOverlay();
    progressManager.showError(error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
  }
}

// Product Details
function showDetails(k){
  progressManager.showCircularProgress();
  
  db.ref("products/"+k).once("value",snap=>{
    const p = snap.val();
    if(!p) {
      progressManager.hideCircularProgress();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹
    let isVerified = false;
    let sellerDisplayName = p.seller || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    
    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    let imagesHTML = '';
    if (p.images && Array.isArray(p.images) && p.images.length > 0) {
      imagesHTML = `
        <div style="margin: 15px 0;">
          <strong>ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬:</strong>
          <div class="product-images">
            ${p.images.map((img, idx) => `
              <img src="${img}" alt="ØµÙˆØ±Ø© ${idx + 1}" class="product-image" 
                   onclick="openImageModal('${img}')">
            `).join('')}
          </div>
          <small style="color:#9ca3af;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙƒØ¨ÙŠØ±Ù‡Ø§</small>
        </div>
      `;
    }
    
    if (p.uid) {
      db.ref('users/' + p.uid).once('value', (userSnap) => {
        const userData = userSnap.val();
        if (userData) {
          isVerified = userData.isVerified || false;
          
          // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          const sellerWithLink = userDisplayName ? 
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">
              <span class="user-name-wrapper">
                ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                ${p.seller}
              </span>
            </span></p>
            <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
            `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> 
              <span class="user-name-wrapper">
                ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
                ${p.seller}
              </span>
            </p>`;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
          const statusText = p.status ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${p.status}">${getStatusText(p.status)}</span></p>` : '';
          
          const detailsContent = `
            <h2>${escapeHTML(p.name)}</h2>
            <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
            <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            ${statusText}
            ${imagesHTML}
            ${sellerWithLink}
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
            <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
            ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
            ${isAdmin ? `<p style="color:#8b5cf6; font-size:12px; margin-top:10px;">Ø§Ù„Ù…Ø¹Ø±Ù: ${k}</p>` : ""}
          `;
          
          document.getElementById("detailsContent").innerHTML = detailsContent;
        }
      });
    }
    
    // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
    const statusText = p.status ? `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-${p.status}">${getStatusText(p.status)}</span></p>` : '';
    
    const initialContent = `
      <h2>${escapeHTML(p.name)}</h2>
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatPrice(p.price)} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      ${statusText}
      ${imagesHTML}
      <p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> 
        <span class="user-name-wrapper">
          ${isVerified ? '<span class="verified-badge">âœ“ Ù…ÙˆØ«Ù‘Ù‚</span>' : ''}
          ${p.seller}
        </span>
      </p>
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery || 'Ù„Ø§'}</p>
      ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
      ${isAdmin ? `<p style="color:#8b5cf6; font-size:12px; margin-top:10px;">Ø§Ù„Ù…Ø¹Ø±Ù: ${k}</p>` : ""}
    `;
    
    document.getElementById("detailsContent").innerHTML = initialContent;
    document.getElementById("detailsDialog").style.display="block";
    progressManager.hideCircularProgress();
  }).catch(error => {
    console.error("Error loading details:", error);
    progressManager.hideCircularProgress();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
  });
}

function closeDetails(){
  document.getElementById("detailsDialog").style.display="none";
}

// ===== Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateAuthUI() {
  const authSection = document.getElementById("authSection");
  
  if (!authSection) return;
  
  if (currentUser && userDisplayName) {
    db.ref("users/" + currentUser.uid).once("value", snapshot => {
      const userData = snapshot.val();
      const displayName = userData ? (userData.fullName || userDisplayName) : userDisplayName;
      
      isAdmin = userData && userData.isAdmin === true;
      const isVerified = userData && userData.isVerified === true;
      
      authSection.innerHTML = `
        <div class="user-info">
          <p class="profile-link" onclick="viewMyProfile()">
            <span class="user-name-wrapper">
              ${isVerified ? '<span class="verified-badge">âœ“</span>' : ''}
              ${displayName}
              ${isAdmin ? '<span class="admin-badge">Ù…Ø¯ÙŠØ±</span>' : ''}
            </span>
          </p>
          <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
          <small style="color:#9ca3af; font-size:11px; display:block; margin:5px 0;">${userData ? userData.totalProducts || 0 : 0} Ø¥Ø¹Ù„Ø§Ù†</small>
          <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          ${isAdmin ? `
          <button onclick="showAdminPanel()" style="
            width: 100%;
            padding: 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
          ">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>` : ''}
        </div>
      `;
    });
  } else {
    authSection.innerHTML = `
      <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <div style="color:#9ca3af; font-size:12px; text-align:center; padding:10px;">
        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠØªÙŠØ­ Ù„Ùƒ:
        <div style="font-size:11px; margin-top:5px;">
          âœ“ Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ<br>
          âœ“ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ†<br>
          âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ<br>
          âœ“ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ùƒ
        </div>
      </div>
    `;
  }
}

function logoutUser() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
    progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...", "Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹");
    
    auth.signOut()
      .then(() => {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        isAdmin = false;
        updateAuthUI();
        showHome();
        progressManager.showSuccess("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      })
      .catch((error) => {
        console.error("Logout error:", error);
        progressManager.hideOverlay();
        progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      });
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ =====
function viewProfile(userId, sellerName) {
  if (sellerName) {
    localStorage.setItem('profileSellerName', sellerName);
  }
  
  progressManager.showTopProgressBar();
  setTimeout(() => {
    window.location.href = `profile.html?id=${userId}`;
  }, 300);
}

function viewMyProfile() {
  if (currentUser && currentUser.uid) {
    progressManager.showTopProgressBar();
    setTimeout(() => {
      window.location.href = `profile.html?id=${currentUser.uid}`;
    }, 300);
  } else {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1500);
  }
}

function showAdminPanel() {
  if (isAdmin) {
    progressManager.showTopProgressBar();
    setTimeout(() => {
      window.location.href = 'admin.html';
    }, 300);
  } else {
    progressManager.showError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„");
  }
}

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatPrice(price) {
  return parseInt(price).toLocaleString('ar-SA');
}

function getStatusText(status) {
  const statuses = {
    'available': 'Ù…ØªØ§Ø­',
    'sold': 'Ù…Ø¨Ø§Ø¹',
    'reserved': 'Ù…Ø­Ø¬ÙˆØ²'
  };
  return statuses[status] || status;
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    userUID = user.uid;
    
    if (user.email) {
      db.ref("users/" + user.uid).once("value", snapshot => {
        const userData = snapshot.val();
        if (userData) {
          userDisplayName = userData.username;
          userFullName = userData.fullName;
          isAdmin = userData.isAdmin === true;
          updateAuthUI();
          
          db.ref("users/" + user.uid).update({
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          checkPublishPermission();
        }
      });
    } else {
      userDisplayName = "Ø²Ø§Ø¦Ø±";
      updateAuthUI();
    }
  } else {
    currentUser = null;
    userDisplayName = null;
    userFullName = null;
    isAdmin = false;
    updateAuthUI();
  }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
  showHome();
  updateAuthUI();
  initSessionManagement();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  setTimeout(() => {
    checkPublishPermission();
  }, 1000);
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù‚ Ø§Ù„Ù†Ù‚Ø±
  document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    e.preventDefault();
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
      e.preventDefault();
    }
  });
  
  // Ø¥ØºÙ„Ø§Ù‚ modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙˆØ±Ø©
  document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeImageModal();
    }
  });
});
</script>
</body>
</html>
