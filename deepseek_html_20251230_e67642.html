<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</title>
<link rel="stylesheet" href="style.css">
<style>
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { font-family: 'CustomFont', sans-serif; }

/* ===== Progress Bar System ===== */
.top-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: transparent;
    z-index: 9999;
    display: none;
}

.progress-bar-line {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #38bdf8, #0ea5e9, #0284c7);
    transition: width 0.4s ease;
    position: relative;
    overflow: hidden;
}

.progress-bar-line::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent);
    animation: progressShine 1.5s infinite;
}

@keyframes progressShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.circular-progress {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9998;
    background: rgba(15, 17, 21, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 50%;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(56, 189, 248, 0.2);
}

.circular-progress svg {
    width: 50px;
    height: 50px;
    transform: rotate(-90deg);
}

.circular-progress circle {
    fill: none;
    stroke-width: 4;
    stroke-linecap: round;
    transform-origin: center;
}

.circular-progress .progress-bg {
    stroke: rgba(56, 189, 248, 0.1);
}

.circular-progress .progress-fill {
    stroke: url(#progressGradient);
    transition: stroke-dashoffset 0.3s ease;
}

.progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 17, 21, 0.85);
    backdrop-filter: blur(5px);
    z-index: 9997;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.progress-overlay.active {
    opacity: 1;
    display: flex;
}

.progress-overlay-content {
    text-align: center;
    max-width: 300px;
    padding: 20px;
}

.progress-overlay-spinner {
    width: 60px;
    height: 60px;
    border: 3px solid rgba(56, 189, 248, 0.2);
    border-top-color: #38bdf8;
    border-radius: 50%;
    margin: 0 auto 20px;
    animation: spin 1s linear infinite;
}

.progress-overlay-text {
    color: #e5e7eb;
    font-size: 16px;
    margin-bottom: 10px;
    font-weight: 500;
}

.progress-overlay-subtext {
    color: #9ca3af;
    font-size: 13px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== Skeleton Loading ===== */
.skeleton-card {
    background: #1c1f27;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #2d3748;
    margin-bottom: 15px;
}

.skeleton-line {
    height: 16px;
    background: #2d3748;
    border-radius: 4px;
    margin-bottom: 10px;
}

/* ===== Button Loading State ===== */
.btn.loading {
    position: relative;
    color: transparent !important;
    pointer-events: none;
}

.btn.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

/* ===== Progress States ===== */
.progress-success {
    background: linear-gradient(90deg, #10b981, #059669) !important;
}

.progress-error {
    background: linear-gradient(90deg, #ef4444, #dc2626) !important;
}

.progress-warning {
    background: linear-gradient(90deg, #f59e0b, #d97706) !important;
}

/* ===== Budget Dialog ===== */
.budget-btn {
  margin-left: 10px;
  background:#1f2937;
  color:#e5e7eb;
  border:none;
  padding:5px 10px;
  cursor:pointer;
  border-radius:5px;
}
.budget-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1000;
  display:none;
}
.budget-dialog input {
  width:100%;
  padding:5px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #333;
  background:#1f1f1f;
  color:#e5e7eb;
}
.budget-dialog button {
  padding:5px 10px;
  border:none;
  border-radius:5px;
  background:#38bdf8;
  color:#000;
  cursor:pointer;
}
.budget-dialog .close-btn { background:#ef4444; margin-left:10px; }

/* ===== Product Details Dialog ===== */
.details-dialog {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#0f1115;
  color:#e5e7eb;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 10px #000;
  z-index:1001;
  display:none;
}
.details-dialog h2 { margin-top:0; }
.details-dialog button { margin-top:10px; padding:5px 10px; border:none; border-radius:5px; background:#38bdf8; color:#000; cursor:pointer; }

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
.auth-section { 
  margin-top: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}
.user-info { 
  padding: 15px; 
  background: #1f2937; 
  border-radius: 6px; 
  text-align: center; 
  margin-top: auto; 
}
.user-info p { 
  margin: 0; 
  color: #38bdf8; 
  font-weight: bold; 
  margin-bottom: 5px; 
}
.logout-btn { 
  width: 100%; 
  padding: 8px; 
  background: #ef4444; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 14px; 
}
.logout-btn:hover { 
  background: #dc2626; 
}
.auth-btn { 
  width: 100%; 
  padding: 10px; 
  background: #1f2937; 
  border: none; 
  color: #e5e7eb; 
  font-size: 16px; 
  cursor: pointer; 
  border-radius: 6px; 
  text-align: center; 
}
.auth-btn:hover { 
  background: #374151; 
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
.seller-link {
  color: #38bdf8;
  cursor: pointer;
  text-decoration: underline;
  transition: color 0.2s;
}
.seller-link:hover {
  color: #0ea5e9;
  text-decoration: none;
}
.profile-link {
  color: #38bdf8;
  cursor: pointer;
  transition: color 0.2s;
}
.profile-link:hover {
  color: #0ea5e9;
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
  <div class="logo">a3len</div>
  <div class="tagline">Ø³ÙˆÙ‚ Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ³ÙŠ</div>
</header>

<!-- Progress Bar System -->
<div class="top-progress-bar" id="topProgressBar">
    <div class="progress-bar-line" id="progressBarLine"></div>
</div>

<div class="circular-progress" id="circularProgress">
    <svg viewBox="0 0 36 36">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#38bdf8" />
                <stop offset="100%" stop-color="#0ea5e9" />
            </linearGradient>
        </defs>
        <circle class="progress-bg" cx="18" cy="18" r="16"></circle>
        <circle class="progress-fill" cx="18" cy="18" r="16" 
                stroke-dasharray="100" stroke-dashoffset="100"></circle>
    </svg>
</div>

<div class="progress-overlay" id="progressOverlay">
    <div class="progress-overlay-content">
        <div class="progress-overlay-spinner"></div>
        <div class="progress-overlay-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="progress-overlay-subtext" id="progressSubtext">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>
</div>

<div class="overlay" onclick="closeSidebar()"></div>

<div class="layout">
  <aside class="sidebar">
    <button onclick="showHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="showPublish()">â• Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†</button>
    <div id="authSection" class="auth-section"></div>
  </aside>

  <main id="content"></main>
</div>

<div class="budget-dialog" id="budgetDialog">
  <h3>Ø§ÙƒØªØ¨ Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ÙÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ</h3>
  <input type="number" id="maxBudget" placeholder="Ù…Ø«Ø§Ù„: 100000" min="0" max="10000000">
  <div style="text-align:right">
    <button onclick="applyBudget()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button class="close-btn" onclick="closeBudget()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div class="details-dialog" id="detailsDialog">
  <div id="detailsContent"></div>
  <button onclick="closeDetails()">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// Progress Manager Ø§Ù„ÙƒØ§Ù…Ù„
class ProgressManager {
    constructor() {
        this.topProgressBar = document.getElementById('topProgressBar');
        this.progressBarLine = document.getElementById('progressBarLine');
        this.circularProgress = document.getElementById('circularProgress');
        this.progressOverlay = document.getElementById('progressOverlay');
        this.progressText = document.getElementById('progressText');
        this.progressSubtext = document.getElementById('progressSubtext');
        
        this.currentProgress = 0;
        this.progressInterval = null;
        this.isLoading = false;
    }
    
    showTopProgressBar() {
        this.topProgressBar.style.display = 'block';
        this.progressBarLine.style.width = '0%';
        this.progressBarLine.className = 'progress-bar-line';
        
        this.currentProgress = 0;
        clearInterval(this.progressInterval);
        
        this.progressInterval = setInterval(() => {
            if (this.currentProgress < 90) {
                this.currentProgress += Math.random() * 10;
                this.updateTopProgress(this.currentProgress);
            }
        }, 200);
    }
    
    updateTopProgress(percent) {
        this.progressBarLine.style.width = `${Math.min(percent, 100)}%`;
    }
    
    hideTopProgressBar() {
        clearInterval(this.progressInterval);
        this.updateTopProgress(100);
        
        setTimeout(() => {
            this.topProgressBar.style.display = 'none';
            this.currentProgress = 0;
        }, 300);
    }
    
    showCircularProgress() {
        this.circularProgress.style.display = 'block';
        this.updateCircularProgress(0);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            this.updateCircularProgress(progress);
            
            if (progress >= 100) {
                progress = 0;
            }
        }, 200);
        
        return () => clearInterval(interval);
    }
    
    updateCircularProgress(percent) {
        const circle = this.circularProgress.querySelector('.progress-fill');
        if (circle) {
            const offset = 100 - percent;
            circle.style.strokeDashoffset = offset;
        }
    }
    
    hideCircularProgress() {
        this.circularProgress.style.display = 'none';
    }
    
    showOverlay(text = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', subtext = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±') {
        this.isLoading = true;
        this.progressText.textContent = text;
        this.progressSubtext.textContent = subtext;
        this.progressOverlay.classList.add('active');
        
        document.body.style.overflow = 'hidden';
    }
    
    updateOverlayText(text, subtext = null) {
        this.progressText.textContent = text;
        if (subtext !== null) {
            this.progressSubtext.textContent = subtext;
        }
    }
    
    hideOverlay() {
        this.isLoading = false;
        this.progressOverlay.classList.remove('active');
        
        setTimeout(() => {
            document.body.style.overflow = '';
        }, 300);
    }
    
    showSuccess(message = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!') {
        this.progressBarLine.className = 'progress-bar-line progress-success';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    showError(message = 'Ø­Ø¯Ø« Ø®Ø·Ø£!') {
        this.progressBarLine.className = 'progress-bar-line progress-error';
        this.updateOverlayText(message, 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 2000);
    }
    
    showWarning(message = 'ØªØ­Ø°ÙŠØ±!') {
        this.progressBarLine.className = 'progress-bar-line progress-warning';
        this.updateOverlayText(message, '');
        
        setTimeout(() => {
            this.hideOverlay();
            this.hideTopProgressBar();
        }, 1500);
    }
    
    createSkeletonCards(count = 6) {
        let skeletonHTML = '';
        for (let i = 0; i < count; i++) {
            skeletonHTML += `
                <div class="skeleton-card">
                    <div class="skeleton-line" style="width: 70%"></div>
                    <div class="skeleton-line" style="width: 40%"></div>
                    <div class="skeleton-line" style="width: 60%"></div>
                    <div class="skeleton-line" style="width: 50%"></div>
                </div>
            `;
        }
        return skeletonHTML;
    }
}

const progressManager = new ProgressManager();

// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();

let userUID = null;
auth.onAuthStateChanged(u => {
    if (u) {
        userUID = u.uid;
    }
});

const categories = ["CPU","GPU","RAM","Motherboard","Storage","Power Supply","Case","Cooler","Accessories"];
let budget = null;

let currentPage = 1;
const postsPerPage = 6; // ØªØ£ÙƒÙŠØ¯: ÙƒÙ„ ØµÙØ­Ø© 6 Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙ‚Ø·

let currentUser = null;
let userDisplayName = null;
let userFullName = null;

// Sidebar
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}
function closeSidebar(){
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ Progress
function showHome(){
  closeSidebar();
  progressManager.showTopProgressBar();
  
  setTimeout(() => {
    document.getElementById("content").innerHTML = `
      <div class="search-bar">
        <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø©..." onkeyup="loadProducts()">
        <select id="cat" onchange="loadProducts()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
          ${categories.map(c=>`<option>${c}</option>`).join("")}
        </select>
        <button onclick="showBudgetDialog()" class="budget-btn">Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ ğŸ’°</button>
      </div>
      <div class="cards" id="products"></div>
      <div id="pagination" style="text-align:center;margin:20px"></div>
    `;
    loadProducts();
  }, 300);
}

// Budget Dialog
function showBudgetDialog(){ document.getElementById("budgetDialog").style.display="block"; }
function closeBudget(){ document.getElementById("budgetDialog").style.display="none"; }
function applyBudget(){
  const val = parseFloat(document.getElementById("maxBudget").value);
  if (isNaN(val) || val < 0) {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©");
    return;
  }
  
  budget = val;
  closeBudget();
  loadProducts();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Progress Ùˆ Pagination
function loadProducts(){
  const s = document.getElementById("search")?.value.toLowerCase() || '';
  const c = document.getElementById("cat")?.value || '';
  
  progressManager.showTopProgressBar();
  
  // Ø¹Ø±Ø¶ Skeleton Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  const productsContainer = document.getElementById('products');
  if (productsContainer) {
    productsContainer.innerHTML = progressManager.createSkeletonCards(6);
  }
  
  db.ref("products").once("value", snap=>{
    const d = snap.val() || {};
    let htmlCards = [];

    Object.keys(d).forEach(k=>{
      const p = d[k];
      const price = parseFloat(p.price) || 0;
      if((!c || p.category===c) && p.name.toLowerCase().includes(s)){
        if(budget && price > budget) return;
        
        const sellerSection = userDisplayName ? 
          `<div class="seller">
            ğŸ‘¤ <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')">${p.seller}</span> | â˜ ${p.phone}
          </div>` :
          `<div class="seller">
            ğŸ‘¤ ${p.seller} | â˜ ${p.phone}
          </div>`;
        
        htmlCards.push({uid:p.uid,key:k,html:`
          <div class="card" onclick="showDetails('${k}')">
            <h3>${p.name}</h3>
            <span class="price">${p.price} Ø¯.Ø¹</span>
            <div class="meta">
              <span>${p.category}</span>
              <span>${p.province}</span>
              <span>ØªÙˆØµÙŠÙ„: ${p.delivery}</span>
            </div>
            ${sellerSection}
            <div class="actions">
              ${p.uid===userUID?`<button class="edit" onclick="editProduct('${k}');event.stopPropagation();">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="del" onclick="deleteProduct('${k}');event.stopPropagation();">Ø­Ø°Ù</button>`:""}
            </div>
          </div>
        `});
      }
    });

    if(userUID){
      htmlCards = htmlCards.sort((a,b)=> b.uid===userUID ? 1 : -1);
    }

    // Pagination - ØªØ£ÙƒÙŠØ¯ 6 Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„ÙƒÙ„ ØµÙØ­Ø©
    const totalPages = Math.ceil(htmlCards.length / postsPerPage);
    if(currentPage > totalPages) currentPage = 1;
    const start = (currentPage-1) * postsPerPage;
    const pageItems = htmlCards.slice(start, start + postsPerPage);
    
    // ØªØ£ÙƒÙŠØ¯: Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø£ÙƒØ«Ø± Ù…Ù† 6
    console.log(`Ø§Ù„ØµÙØ­Ø© ${currentPage}: ${pageItems.length} Ù…Ù†Ø´ÙˆØ± (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${postsPerPage})`);

    let finalHTML = pageItems.map(p=>p.html).join("") || "<p class='empty'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    
    if (productsContainer) {
      productsContainer.innerHTML = finalHTML;
      renderPagination(totalPages);
      progressManager.hideTopProgressBar();
    }
  }).catch(error => {
    console.error("Error loading products:", error);
    if (productsContainer) {
      productsContainer.innerHTML = "<p class='empty'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p>";
    }
    progressManager.hideTopProgressBar();
    progressManager.showError("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª");
  });
}

// Render Pagination Buttons
function renderPagination(total){
  let html = "";
  for(let i=1;i<=total;i++){
    html += `
      <button onclick="goPage(${i})"
        style="
          margin:3px;
          padding:6px 10px;
          border-radius:5px;
          border:none;
          cursor:pointer;
          background:${i===currentPage?'#38bdf8':'#1f2937'};
          color:${i===currentPage?'#000':'#fff'};
        ">
        ${i}
      </button>`;
  }
  const pagination = document.getElementById('pagination');
  if (pagination) {
    pagination.innerHTML = html;
  }
}

function goPage(p){
  currentPage = p;
  progressManager.showTopProgressBar();
  setTimeout(() => {
    loadProducts();
  }, 300);
}

// Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Progress
function deleteProduct(k){ 
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) return;
  
  progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...");
  
  db.ref("products/" + k).once('value', (snapshot) => {
    const product = snapshot.val();
    if (product && product.uid) {
      db.ref('users/' + product.uid).once('value', (userSnapshot) => {
        const userData = userSnapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          if (currentCount > 0) {
            db.ref('users/' + product.uid).update({
              totalProducts: currentCount - 1
            });
          }
        }
      });
    }
    
    db.ref("products/"+k).remove().then(() => {
      progressManager.showSuccess("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
      loadProducts();
    }).catch(error => {
      console.error("Delete error:", error);
      progressManager.hideOverlay();
      progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
    });
  });
}

function editProduct(k){ 
  progressManager.showTopProgressBar();
  
  db.ref("products/"+k).once("value", s => {
    const product = s.val();
    if (!product) {
      progressManager.hideTopProgressBar();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    showPublish(product, k);
    progressManager.hideTopProgressBar();
  });
}

// Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
function showPublish(p=null,k=null){
  closeSidebar();
  
  progressManager.showTopProgressBar();
  
  setTimeout(() => {
    const sellerName = userDisplayName || (p ? p.seller : "");
    const sellerField = userDisplayName ? 
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}" disabled style="background:#374151; color:#9ca3af; cursor:not-allowed;">
       <small style="color:#38bdf8; font-size:12px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„</small>` :
      `<input id="seller" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹" value="${sellerName}">`;
    
    document.getElementById("content").innerHTML = `
      <div class="form-box">
        <h2>${p?"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†":"Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯"}</h2>
        <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" value="${p?p.name:""}">
        <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" value="${p?p.price:""}">
        <select id="category">${categories.map(c=>`<option ${p&&p.category===c?"selected":""}>${c}</option>`).join("")}</select>
        ${sellerField}
        <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" value="${p?p.phone:""}">
        <input id="province" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" value="${p?p.province:""}">
        <select id="delivery">
          <option ${p&&p.delivery==="Ù†Ø¹Ù…"?"selected":""}>Ù†Ø¹Ù…</option>
          <option ${p&&p.delivery==="Ù„Ø§"?"selected":""}>Ù„Ø§</option>
        </select>
        <button onclick="save('${k||""}')" id="saveBtn">ğŸ’¾ ${p?"ØªØ­Ø¯ÙŠØ«":"Ù†Ø´Ø±"}</button>
        ${p ? `<button onclick="showHome()" style="background:#6b7280; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
      </div>`;
    
    progressManager.hideTopProgressBar();
  }, 300);
}

function save(k){
  const phone = document.getElementById("phone").value.trim();
  if(!/^[0][0-9]{10}$/.test(phone)){
    progressManager.showError("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±");
    return;
  }

  const seller = userDisplayName || document.getElementById("seller").value;

  const data = {
    name: document.getElementById("name").value,
    price: document.getElementById("price").value,
    category: document.getElementById("category").value,
    seller: seller,
    phone: phone,
    province: document.getElementById("province").value,
    delivery: document.getElementById("delivery").value,
    uid: userUID,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  };
  
  const ref = k ? db.ref("products/"+k) : db.ref("products").push();
  
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  saveBtn.classList.add('loading');
  
  progressManager.showOverlay(k ? "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..." : "Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...");
  
  ref.set(data).then(() => {
    if (!k && userUID) {
      db.ref('users/' + userUID).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
          const currentCount = userData.totalProducts || 0;
          db.ref('users/' + userUID).update({
            totalProducts: currentCount + 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        } else {
          db.ref('users/' + userUID).update({
            totalProducts: 1,
            lastActive: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    }
    
    progressManager.showSuccess(k ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­");
    
    saveBtn.innerHTML = originalText;
    saveBtn.classList.remove('loading');
    
    setTimeout(() => {
      showHome();
    }, 1000);
  }).catch(error => {
    console.error("Error saving product:", error);
    progressManager.hideOverlay();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
    
    saveBtn.innerHTML = originalText;
    saveBtn.classList.remove('loading');
  });
}

// ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ Progress
function showDetails(k){
  progressManager.showCircularProgress();
  
  db.ref("products/"+k).once("value",snap=>{
    const p = snap.val();
    if(!p) {
      progressManager.hideCircularProgress();
      progressManager.showError("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    const sellerWithLink = userDisplayName ? 
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> <span class="seller-link" onclick="viewProfile('${p.uid}', '${p.seller}')" style="font-weight:bold;">${p.seller}</span></p>
       <p><small style="color:#38bdf8;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù„Ø¹Ø±Ø¶ Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</small></p>` :
      `<p><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ${p.seller}</p>`;
    
    document.getElementById("detailsContent").innerHTML = `
      <h2>${p.name}</h2>
      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${p.price} Ø¯.Ø¹</p>
      <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${p.category}</p>
      ${sellerWithLink}
      <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone}</p>
      <p><strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${p.province}</p>
      <p><strong>Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${p.delivery}</p>
      ${p.uid === userUID ? `<p style="color:#38bdf8; font-size:14px; margin-top:10px;">Ù‡Ø°Ø§ Ø¥Ø¹Ù„Ø§Ù†Ùƒ</p>` : ""}
    `;
    document.getElementById("detailsDialog").style.display="block";
    progressManager.hideCircularProgress();
  }).catch(error => {
    console.error("Error loading details:", error);
    progressManager.hideCircularProgress();
    progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„");
  });
}

function closeDetails(){
  document.getElementById("detailsDialog").style.display="none";
}

// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
function updateAuthUI() {
  const authSection = document.getElementById("authSection");
  if (!authSection) return;
  
  if (currentUser && userDisplayName) {
    const displayName = userFullName || userDisplayName;
    authSection.innerHTML = `
      <div class="user-info">
        <p class="profile-link" onclick="viewMyProfile()">ğŸ‘¤ ${displayName}</p>
        <small style="color:#9ca3af; font-size:12px;">@${userDisplayName}</small>
        <button class="logout-btn" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    `;
  } else {
    authSection.innerHTML = `
      <button class="auth-btn" onclick="window.location.href='login.html'">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-btn" onclick="window.location.href='register.html'">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    `;
  }
}

function logoutUser() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
    progressManager.showOverlay("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...");
    
    auth.signOut()
      .then(() => {
        currentUser = null;
        userDisplayName = null;
        userFullName = null;
        updateAuthUI();
        showHome();
        progressManager.showSuccess("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      })
      .catch((error) => {
        console.error("Logout error:", error);
        progressManager.hideOverlay();
        progressManager.showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
      });
  }
}

// Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
function viewProfile(userId, sellerName) {
  if (sellerName) {
    localStorage.setItem('profileSellerName', sellerName);
  }
  
  progressManager.showTopProgressBar();
  setTimeout(() => {
    window.location.href = `profile.html?id=${userId}`;
  }, 300);
}

function viewMyProfile() {
  if (currentUser && currentUser.uid) {
    progressManager.showTopProgressBar();
    setTimeout(() => {
      window.location.href = `profile.html?id=${currentUser.uid}`;
    }, 300);
  } else {
    progressManager.showError("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1500);
  }
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
auth.onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;
    userUID = user.uid;
    
    db.ref("users/" + user.uid).once("value", snapshot => {
      const userData = snapshot.val();
      if (userData) {
        userDisplayName = userData.username;
        userFullName = userData.fullName || userData.username;
        updateAuthUI();
        
        db.ref("users/" + user.uid).update({
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
      }
    });
  } else {
    currentUser = null;
    userDisplayName = null;
    userFullName = null;
    updateAuthUI();
  }
});

// Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.addEventListener("DOMContentLoaded", function() {
  showHome();
  updateAuthUI();
});
</script>
</body>
</html>