<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>a3len | حسابي الشخصي</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ===== Custom Font ===== */
@font-face {
  font-family: 'CustomFont';
  src: url('font.ttf') format('truetype');
}
body, input, select, button, textarea { 
  font-family: 'CustomFont', sans-serif;
  background: #0f1115;
  color: #e5e7eb;
  margin: 0;
  padding: 0;
}

/* ===== تحسينات عامة للجوال ===== */
* {
  box-sizing: border-box;
}

.container {
  max-width: 100%;
  padding: 15px;
  margin: 0 auto;
}

/* ===== الهيدر والتوب بار ===== */
.topbar {
  position: fixed;
  top: 0;
  right: 0;
  left: 0;
  background: #1f2937;
  padding: 12px 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 1000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  height: 60px;
}

.menu-toggle {
  font-size: 24px;
  cursor: pointer;
  color: #e5e7eb;
  padding: 5px;
}

.logo {
  font-size: 22px;
  font-weight: bold;
  color: #38bdf8;
  text-align: center;
  flex: 1;
}

.tagline {
  font-size: 12px;
  color: #9ca3af;
  text-align: center;
  flex: 1;
}

/* ===== الشريط الجانبي ===== */
.sidebar {
  position: fixed;
  right: -280px;
  top: 60px;
  width: 280px;
  height: calc(100vh - 60px);
  background: #111827;
  padding: 20px 15px;
  z-index: 999;
  transition: right 0.3s ease;
  overflow-y: auto;
}

.sidebar.active {
  right: 0;
}

.sidebar button {
  width: 100%;
  padding: 14px;
  margin: 8px 0;
  background: #1f2937;
  border: 1px solid #374151;
  color: #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  text-align: right;
  transition: all 0.3s;
}

.sidebar button:hover {
  background: #374151;
  transform: translateX(-5px);
}

.sidebar .active-btn {
  background: #38bdf8;
  color: #000;
  border-color: #38bdf8;
}

.overlay {
  position: fixed;
  top: 60px;
  right: 0;
  left: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 998;
  display: none;
}

.overlay.active {
  display: block;
}

/* ===== المحتوى الرئيسي ===== */
main {
  margin-top: 60px;
  padding: 15px;
  min-height: calc(100vh - 60px);
}

.profile-container {
  max-width: 1200px;
  margin: 0 auto;
}

/* ===== كرت الملف الشخصي ===== */
.profile-card {
  background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  border: 1px solid #374151;
  position: relative;
  overflow: hidden;
}

.profile-card::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(90deg, #38bdf8, #8b5cf6, #10b981);
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.profile-avatar {
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  font-weight: bold;
  color: white;
  border: 4px solid rgba(255,255,255,0.1);
  box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
}

.avatar-upload {
  position: relative;
  cursor: pointer;
}

.avatar-upload input {
  display: none;
}

.avatar-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
}

.avatar-upload:hover .avatar-overlay {
  opacity: 1;
}

.profile-info {
  flex: 1;
  min-width: 250px;
}

.profile-name {
  font-size: 28px;
  color: #f3f4f6;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.profile-username {
  color: #9ca3af;
  font-size: 18px;
  margin-bottom: 15px;
}

.profile-email {
  color: #d1d5db;
  font-size: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.stat-card {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  border: 1px solid rgba(255,255,255,0.1);
  transition: all 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
  border-color: #38bdf8;
  box-shadow: 0 5px 15px rgba(56, 189, 248, 0.2);
}

.stat-number {
  font-size: 28px;
  font-weight: bold;
  color: #38bdf8;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 14px;
  color: #9ca3af;
}

/* ===== علامات الحالة ===== */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 13px;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
}

.verified-badge {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.pending-badge {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
  border: 1px solid rgba(245, 158, 11, 0.3);
}

.admin-badge {
  background: rgba(139, 92, 246, 0.2);
  color: #8b5cf6;
  border: 1px solid rgba(139, 92, 246, 0.3);
}

/* ===== علامات التبويب ===== */
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
  overflow-x: auto;
  padding-bottom: 10px;
  border-bottom: 2px solid #374151;
}

.tab-btn {
  padding: 12px 25px;
  background: transparent;
  border: none;
  color: #9ca3af;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 500;
  white-space: nowrap;
  transition: all 0.3s;
  position: relative;
}

.tab-btn:hover {
  color: #e5e7eb;
  background: rgba(255,255,255,0.05);
}

.tab-btn.active {
  color: #38bdf8;
  background: rgba(56, 189, 248, 0.1);
}

.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -12px;
  right: 0;
  left: 0;
  height: 3px;
  background: #38bdf8;
  border-radius: 3px;
}

/* ===== محتوى علامات التبويب ===== */
.tab-content {
  display: none;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.tab-content.active {
  display: block;
}

/* ===== قسم تعديل الملف الشخصي ===== */
.edit-profile-form {
  background: #1f2937;
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 25px;
  border: 1px solid #374151;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #d1d5db;
  font-size: 15px;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 14px;
  background: #111827;
  border: 1px solid #374151;
  border-radius: 8px;
  color: #e5e7eb;
  font-size: 16px;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #38bdf8;
  box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.btn {
  padding: 14px 28px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary {
  background: #38bdf8;
  color: #000;
}

.btn-primary:hover {
  background: #0ea5e9;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(56, 189, 248, 0.3);
}

.btn-success {
  background: #10b981;
  color: white;
}

.btn-success:hover {
  background: #0da271;
  transform: translateY(-2px);
}

.btn-danger {
  background: #ef4444;
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

.btn-secondary {
  background: #6b7280;
  color: white;
}

.btn-secondary:hover {
  background: #4b5563;
}

.btn-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 25px;
}

/* ===== قسم الإعلانات ===== */
.products-filter {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 10px 20px;
  background: #1f2937;
  border: 1px solid #374151;
  color: #9ca3af;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.filter-btn:hover {
  color: #e5e7eb;
  background: #374151;
}

.filter-btn.active {
  background: #38bdf8;
  color: #000;
  border-color: #38bdf8;
}

.products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.product-item {
  background: #1f2937;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #374151;
  transition: all 0.3s;
}

.product-item:hover {
  transform: translateY(-5px);
  border-color: #38bdf8;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.product-image {
  height: 180px;
  background: linear-gradient(135deg, #374151, #1f2937);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #9ca3af;
  font-size: 48px;
}

.product-content {
  padding: 20px;
}

.product-title {
  font-size: 18px;
  color: #f3f4f6;
  margin-bottom: 10px;
  line-height: 1.4;
}

.product-price {
  font-size: 22px;
  color: #38bdf8;
  font-weight: bold;
  margin-bottom: 10px;
}

.product-meta {
  display: flex;
  gap: 15px;
  color: #9ca3af;
  font-size: 14px;
  margin-bottom: 15px;
}

.product-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.product-actions .btn {
  flex: 1;
  padding: 10px;
  font-size: 14px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #9ca3af;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 15px;
  color: #6b7280;
}

/* ===== قسم إدارة الحساب ===== */
.account-settings {
  background: #1f2937;
  border-radius: 15px;
  padding: 25px;
  border: 1px solid #374151;
}

.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  margin-bottom: 15px;
  border: 1px solid rgba(255,255,255,0.1);
}

.setting-info {
  flex: 1;
}

.setting-title {
  font-size: 16px;
  color: #f3f4f6;
  margin-bottom: 5px;
}

.setting-desc {
  font-size: 14px;
  color: #9ca3af;
}

.setting-value {
  color: #38bdf8;
  font-weight: 500;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  background-color: #374151;
  transition: .4s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  right: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: #38bdf8;
}

input:checked + .toggle-slider:before {
  transform: translateX(-24px);
}

/* ===== قسم التوثيق ===== */
.verification-card {
  background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 25px;
  color: white;
  border: 1px solid #3b82f6;
}

.verification-steps {
  display: flex;
  gap: 20px;
  margin: 25px 0;
  flex-wrap: wrap;
}

.step {
  flex: 1;
  min-width: 200px;
  text-align: center;
  padding: 20px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
}

.step-number {
  width: 40px;
  height: 40px;
  background: white;
  color: #1e40af;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin: 0 auto 15px;
}

.step-title {
  font-size: 16px;
  margin-bottom: 10px;
}

.step-desc {
  font-size: 14px;
  opacity: 0.9;
}

/* ===== الرسائل والتنبيهات ===== */
.alert {
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateY(-10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.alert-success {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: #10b981;
}

.alert-error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

.alert-info {
  background: rgba(56, 189, 248, 0.1);
  border: 1px solid rgba(56, 189, 248, 0.3);
  color: #38bdf8;
}

.alert-warning {
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
  color: #f59e0b;
}

/* ===== الوضع الداكم ===== */
.theme-toggle {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 50px;
  height: 50px;
  background: #1f2937;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border: 2px solid #374151;
}

/* ===== تحسينات للجوال ===== */
@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  .profile-header {
    flex-direction: column;
    text-align: center;
  }
  
  .profile-avatar {
    width: 80px;
    height: 80px;
    font-size: 32px;
  }
  
  .profile-name {
    font-size: 24px;
    justify-content: center;
  }
  
  .tabs {
    overflow-x: scroll;
    padding-bottom: 5px;
  }
  
  .tab-btn {
    padding: 10px 15px;
    font-size: 14px;
  }
  
  .products-grid {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .verification-steps {
    flex-direction: column;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .setting-item {
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
  
  .product-actions {
    flex-direction: column;
  }
}

@media (max-width: 480px) {
  .topbar {
    padding: 10px;
  }
  
  .logo {
    font-size: 18px;
  }
  
  .tagline {
    font-size: 10px;
  }
  
  .sidebar {
    width: 100%;
    right: -100%;
  }
  
  .profile-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stat-card {
    padding: 15px;
  }
  
  .stat-number {
    font-size: 22px;
  }
}

/* ===== تحميل ===== */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 50px;
  color: #9ca3af;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid #374151;
  border-top-color: #38bdf8;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<header class="topbar">
  <div class="menu-toggle" onclick="toggleSidebar()">☰</div>
  <div class="logo">a3len</div>
  <div class="tagline">حسابي الشخصي</div>
</header>

<div class="overlay" onclick="closeSidebar()"></div>

<aside class="sidebar">
  <button onclick="showTab('profile')" class="tab-btn active" data-tab="profile">
    <i class="fas fa-user"></i> الملف الشخصي
  </button>
  <button onclick="showTab('ads')" class="tab-btn" data-tab="ads">
    <i class="fas fa-box"></i> إعلاناتي
  </button>
  <button onclick="showTab('edit')" class="tab-btn" data-tab="edit">
    <i class="fas fa-edit"></i> تعديل البيانات
  </button>
  <button onclick="showTab('settings')" class="tab-btn" data-tab="settings">
    <i class="fas fa-cog"></i> إدارة الحساب
  </button>
  <button onclick="showTab('verification')" class="tab-btn" data-tab="verification">
    <i class="fas fa-shield-alt"></i> توثيق الحساب
  </button>
  <button onclick="window.location.href='index.html'" style="margin-top: 20px;">
    <i class="fas fa-home"></i> الرئيسية
  </button>
  <button onclick="window.location.href='index.html?publish=1'">
    <i class="fas fa-plus"></i> نشر إعلان جديد
  </button>
  <button class="logout-btn" onclick="logout()" style="background:#ef4444; color:white; margin-top:auto;">
    <i class="fas fa-sign-out-alt"></i> تسجيل خروج
  </button>
</aside>

<main>
  <div class="profile-container">
    
    <!-- رسائل التنبيه -->
    <div id="alertContainer"></div>
    
    <!-- قسم الملف الشخصي -->
    <div id="profile-tab" class="tab-content active">
      <div class="profile-card">
        <div class="profile-header">
          <div class="avatar-upload">
            <div class="profile-avatar" id="profileAvatar">
              <!-- سيتم إضافة الحرف الأول -->
            </div>
            <div class="avatar-overlay">
              <i class="fas fa-camera" style="color:white; font-size:24px;"></i>
            </div>
            <input type="file" id="avatarInput" accept="image/*" onchange="uploadAvatar(event)">
          </div>
          <div class="profile-info">
            <h1 class="profile-name" id="profileFullName">
              <!-- سيتم تحميل الاسم -->
              <span id="verificationBadge" class="badge verified-badge" style="display:none;">
                <i class="fas fa-check-circle"></i> موثّق
              </span>
              <span id="adminBadge" class="badge admin-badge" style="display:none;">
                <i class="fas fa-crown"></i> مدير
              </span>
            </h1>
            <p class="profile-username" id="profileUsername">@username</p>
            <p class="profile-email" id="profileEmail">
              <i class="fas fa-envelope"></i> user@example.com
            </p>
            <p class="profile-phone" id="profilePhone" style="color:#d1d5db; margin-bottom:10px;">
              <i class="fas fa-phone"></i> 07XX XXX XXXX
            </p>
            <p class="profile-join-date" id="joinDate" style="color:#9ca3af; font-size:14px;">
              <i class="fas fa-calendar-alt"></i> عضو منذ: 2024-01-01
            </p>
          </div>
        </div>
        
        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-number" id="totalAds">0</div>
            <div class="stat-label">إعلان نشط</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="soldAds">0</div>
            <div class="stat-label">مباع</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="reservedAds">0</div>
            <div class="stat-label">محجوز</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalViews">0</div>
            <div class="stat-label">مشاهدات</div>
          </div>
        </div>
      </div>
      
      <div class="profile-card">
        <h2 style="color:#f3f4f6; margin-bottom:20px; font-size:20px;">
          <i class="fas fa-chart-line"></i> نشاطي الأخير
        </h2>
        <div id="recentActivity">
          <!-- سيتم تحميل النشاط -->
          <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>لا يوجد نشاط مؤخراً</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- قسم الإعلانات -->
    <div id="ads-tab" class="tab-content">
      <div class="profile-card">
        <h2 style="color:#f3f4f6; margin-bottom:20px; font-size:20px;">
          <i class="fas fa-box"></i> إعلاناتي
        </h2>
        
        <div class="products-filter">
          <button class="filter-btn active" onclick="filterAds('all')">الكل</button>
          <button class="filter-btn" onclick="filterAds('active')">نشطة</button>
          <button class="filter-btn" onclick="filterAds('sold')">مباعة</button>
          <button class="filter-btn" onclick="filterAds('reserved')">محجوزة</button>
          <button class="filter-btn" onclick="filterAds('expired')">منتهية</button>
        </div>
        
        <div id="adsList" class="products-grid">
          <!-- سيتم تحميل الإعلانات -->
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>جاري تحميل الإعلانات...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- قسم تعديل البيانات -->
    <div id="edit-tab" class="tab-content">
      <div class="edit-profile-form">
        <h2 style="color:#f3f4f6; margin-bottom:25px; font-size:22px;">
          <i class="fas fa-user-edit"></i> تعديل البيانات الشخصية
        </h2>
        
        <form id="editProfileForm">
          <div class="form-row">
            <div class="form-group">
              <label for="editFullName"><i class="fas fa-user"></i> الاسم الكامل</label>
              <input type="text" id="editFullName" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="editUsername"><i class="fas fa-at"></i> اسم المستخدم</label>
              <input type="text" id="editUsername" class="form-control" required>
              <small style="color:#9ca3af; font-size:12px;">يمكن تغييره مرة كل 30 يوم</small>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="editEmail"><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
              <input type="email" id="editEmail" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="editPhone"><i class="fas fa-phone"></i> رقم الهاتف</label>
              <input type="tel" id="editPhone" class="form-control" pattern="[0][0-9]{10}" required>
              <small style="color:#9ca3af; font-size:12px;">يجب أن يبدأ بـ 0 ويتكون من 11 رقم</small>
            </div>
          </div>
          
          <div class="form-group">
            <label for="editBio"><i class="fas fa-address-card"></i> نبذة عني</label>
            <textarea id="editBio" class="form-control" rows="4" maxlength="200"></textarea>
            <small style="color:#9ca3af; font-size:12px;">اختياري - الحد الأقصى 200 حرف</small>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="editProvince"><i class="fas fa-map-marker-alt"></i> المحافظة</label>
              <select id="editProvince" class="form-control">
                <option value="">اختر المحافظة</option>
                <option value="بغداد">بغداد</option>
                <option value="البصرة">البصرة</option>
                <option value="الموصل">الموصل</option>
                <option value="أربيل">أربيل</option>
                <option value="دهوك">دهوك</option>
                <option value="السليمانية">السليمانية</option>
                <option value="نينوى">نينوى</option>
                <option value="الأنبار">الأنبار</option>
                <option value="ذي قار">ذي قار</option>
                <option value="بابل">بابل</option>
                <option value="كربلاء">كربلاء</option>
                <option value="واسط">واسط</option>
                <option value="الديوانية">الديوانية</option>
                <option value="القادسية">القادسية</option>
                <option value="صلاح الدين">صلاح الدين</option>
                <option value="المثنى">المثنى</option>
                <option value="ميسان">ميسان</option>
                <option value="النجف">النجف</option>
                <option value="كركوك">كركوك</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="editCity"><i class="fas fa-city"></i> المدينة/المنطقة</label>
              <input type="text" id="editCity" class="form-control">
            </div>
          </div>
          
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> حفظ التغييرات
            </button>
            <button type="button" class="btn btn-secondary" onclick="showTab('profile')">
              <i class="fas fa-times"></i> إلغاء
            </button>
          </div>
        </form>
      </div>
      
      <div class="edit-profile-form">
        <h2 style="color:#f3f4f6; margin-bottom:25px; font-size:22px;">
          <i class="fas fa-lock"></i> تغيير كلمة المرور
        </h2>
        
        <form id="changePasswordForm">
          <div class="form-group">
            <label for="currentPassword"><i class="fas fa-key"></i> كلمة المرور الحالية</label>
            <input type="password" id="currentPassword" class="form-control" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="newPassword"><i class="fas fa-lock"></i> كلمة المرور الجديدة</label>
              <input type="password" id="newPassword" class="form-control" minlength="6" required>
            </div>
            
            <div class="form-group">
              <label for="confirmPassword"><i class="fas fa-lock"></i> تأكيد كلمة المرور</label>
              <input type="password" id="confirmPassword" class="form-control" minlength="6" required>
            </div>
          </div>
          
          <div class="btn-group">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-sync-alt"></i> تغيير كلمة المرور
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- قسم إدارة الحساب -->
    <div id="settings-tab" class="tab-content">
      <div class="account-settings">
        <h2 style="color:#f3f4f6; margin-bottom:25px; font-size:22px;">
          <i class="fas fa-sliders-h"></i> إعدادات الحساب
        </h2>
        
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">الإشعارات</div>
            <div class="setting-desc">تلقي إشعارات عند تفاعل المستخدمين مع إعلاناتك</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notificationsToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">الخصوصية</div>
            <div class="setting-desc">إخفاء رقم الهاتف عن المستخدمين الآخرين</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="privacyToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">الوضع الداكن</div>
            <div class="setting-desc">تفعيل الوضع الداكن دائماً</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">لغة الواجهة</div>
            <div class="setting-desc">العربية</div>
          </div>
          <div class="setting-value">AR</div>
        </div>
        
        <div class="btn-group" style="margin-top:30px;">
          <button class="btn btn-primary" onclick="saveSettings()">
            <i class="fas fa-save"></i> حفظ الإعدادات
          </button>
          <button class="btn btn-danger" onclick="deleteAccount()">
            <i class="fas fa-trash-alt"></i> حذف الحساب
          </button>
        </div>
      </div>
    </div>
    
    <!-- قسم توثيق الحساب -->
    <div id="verification-tab" class="tab-content">
      <div class="verification-card">
        <h2 style="color:white; margin-bottom:15px; font-size:24px;">
          <i class="fas fa-shield-alt"></i> توثيق حسابك
        </h2>
        <p style="opacity:0.9; margin-bottom:25px;">
          توثيق حسابك يزيد من ثقة المستخدمين بك ويمكنك من نشر المزيد من الإعلانات
        </p>
        
        <div class="verification-steps">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-title">أكمل بياناتك</div>
            <div class="step-desc">أضف معلوماتك الشخصية ورقم الهاتف</div>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-title">رفع الهوية</div>
            <div class="step-desc">صورة واضحة من بطاقة الهوية الوطنية</div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-title">التأكيد</div>
            <div class="step-desc">سنقوم بالتحقق من المعلومات خلال 48 ساعة</div>
          </div>
        </div>
        
        <div id="verificationStatus" style="text-align:center; margin-top:20px;">
          <!-- سيتم عرض حالة التوثيق -->
        </div>
        
        <div class="btn-group" style="justify-content:center; margin-top:30px;">
          <button class="btn btn-success" onclick="startVerification()" id="verificationBtn">
            <i class="fas fa-check-circle"></i> بدء عملية التوثيق
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- زر تغيير السمة -->
<div class="theme-toggle" onclick="toggleTheme()">
  <i class="fas fa-moon" id="themeIcon"></i>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAl3XunFOwHpGw-4_VYyETMtoLgk4mnRpQ",
  authDomain: "a3len-3ad54.firebasestorage.app",
  databaseURL: "https://a3len-3ad54-default-rtdb.firebaseio.com",
  projectId: "a3len-3ad54",
  storageBucket: "a3len-3ad54.firebasestorage.app",
  messagingSenderId: "767338034080",
  appId: "1:767338034080:web:801d77fb74c0aa56e92ac5"
};

// التحقق من تكرار تهيئة Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// متغيرات عامة
let currentUser = null;
let userData = null;
let userProducts = [];

// ===== دوال التنقل =====
function showTab(tabId) {
  // إخفاء جميع المحتويات
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // إلغاء تنشيط جميع الأزرار
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // إظهار المحتوى المحدد
  document.getElementById(`${tabId}-tab`).classList.add('active');
  
  // تنشيط الزر المحدد
  document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
  
  // تحميل البيانات حسب التبويب
  switch(tabId) {
    case 'profile':
      loadProfileData();
      break;
    case 'ads':
      loadUserProducts();
      break;
    case 'edit':
      loadEditForm();
      break;
    case 'settings':
      loadSettings();
      break;
    case 'verification':
      loadVerificationStatus();
      break;
  }
  
  // إغلاق الشريط الجانبي على الجوال
  if (window.innerWidth < 768) {
    closeSidebar();
  }
}

function toggleSidebar() {
  document.querySelector(".sidebar").classList.toggle("active");
  document.querySelector(".overlay").classList.toggle("active");
}

function closeSidebar() {
  document.querySelector(".sidebar").classList.remove("active");
  document.querySelector(".overlay").classList.remove("active");
}

// ===== إظهار رسائل التنبيه =====
function showAlert(message, type = 'info', duration = 5000) {
  const alertContainer = document.getElementById('alertContainer');
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" style="margin-right:auto; background:none; border:none; color:inherit; cursor:pointer;">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  alertContainer.appendChild(alertDiv);
  
  // إزالة التنبيه بعد المدة المحددة
  setTimeout(() => {
    if (alertDiv.parentElement) {
      alertDiv.style.opacity = '0';
      alertDiv.style.transform = 'translateY(-10px)';
      setTimeout(() => alertDiv.remove(), 300);
    }
  }, duration);
}

// ===== تحميل بيانات المستخدم =====
function loadProfileData() {
  if (!currentUser || !userData) return;
  
  // تحديث الصورة الرمزية
  const firstLetter = userData.fullName ? userData.fullName.charAt(0).toUpperCase() : 'م';
  document.getElementById('profileAvatar').textContent = firstLetter;
  
  // إذا كان هناك صورة رمزية محفوظة
  if (userData.avatarUrl) {
    document.getElementById('profileAvatar').style.backgroundImage = `url('${userData.avatarUrl}')`;
    document.getElementById('profileAvatar').style.backgroundSize = 'cover';
    document.getElementById('profileAvatar').style.backgroundPosition = 'center';
    document.getElementById('profileAvatar').textContent = '';
  }
  
  // تحديث البيانات
  document.getElementById('profileFullName').innerHTML = `
    ${userData.fullName || 'مستخدم'}
    ${userData.isVerified ? '<span id="verificationBadge" class="badge verified-badge"><i class="fas fa-check-circle"></i> موثّق</span>' : ''}
    ${userData.isAdmin ? '<span id="adminBadge" class="badge admin-badge"><i class="fas fa-crown"></i> مدير</span>' : ''}
  `;
  
  document.getElementById('profileUsername').textContent = `@${userData.username}`;
  document.getElementById('profileEmail').innerHTML = `<i class="fas fa-envelope"></i> ${currentUser.email || 'لا يوجد بريد إلكتروني'}`;
  document.getElementById('profilePhone').innerHTML = `<i class="fas fa-phone"></i> ${userData.phone ? maskPhoneNumber(userData.phone) : 'غير محدد'}`;
  
  // تاريخ الانضمام
  if (userData.joinDate) {
    const joinDate = new Date(userData.joinDate);
    document.getElementById('joinDate').innerHTML = `<i class="fas fa-calendar-alt"></i> عضو منذ: ${joinDate.toLocaleDateString('ar-SA')}`;
  }
  
  // حساب الإحصائيات
  calculateStatistics();
  
  // تحميل النشاط الأخير
  loadRecentActivity();
}

function calculateStatistics() {
  if (!userProducts || userProducts.length === 0) {
    document.getElementById('totalAds').textContent = '0';
    document.getElementById('soldAds').textContent = '0';
    document.getElementById('reservedAds').textContent = '0';
    return;
  }
  
  const total = userProducts.length;
  const sold = userProducts.filter(p => p.status === 'sold').length;
  const reserved = userProducts.filter(p => p.status === 'reserved').length;
  const active = total - sold - reserved;
  
  document.getElementById('totalAds').textContent = active;
  document.getElementById('soldAds').textContent = sold;
  document.getElementById('reservedAds').textContent = reserved;
  
  // حساب المشاهدات (افتراضي)
  const totalViews = userProducts.reduce((sum, product) => sum + (product.views || 0), 0);
  document.getElementById('totalViews').textContent = totalViews.toLocaleString('ar-SA');
}

async function loadRecentActivity() {
  try {
    const snapshot = await db.ref(`userActivity/${currentUser.uid}`).limitToLast(5).once('value');
    const activities = snapshot.val();
    const container = document.getElementById('recentActivity');
    
    if (!activities) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-history"></i>
          <p>لا يوجد نشاط مؤخراً</p>
        </div>
      `;
      return;
    }
    
    let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
    Object.keys(activities).forEach(key => {
      const activity = activities[key];
      const time = activity.timestamp ? new Date(activity.timestamp).toLocaleString('ar-SA') : 'الآن';
      
      let icon = 'fas fa-info-circle';
      let text = '';
      let color = '#38bdf8';
      
      switch(activity.type) {
        case 'product_created':
          icon = 'fas fa-plus-circle';
          text = 'نشرت إعلاناً جديداً';
          color = '#10b981';
          break;
        case 'product_updated':
          icon = 'fas fa-edit';
          text = 'قمت بتعديل إعلان';
          color = '#f59e0b';
          break;
        case 'product_deleted':
          icon = 'fas fa-trash-alt';
          text = 'حذفت إعلاناً';
          color = '#ef4444';
          break;
        case 'login':
          icon = 'fas fa-sign-in-alt';
          text = 'تم تسجيل الدخول';
          color = '#8b5cf6';
          break;
        default:
          text = activity.type || 'نشاط جديد';
      }
      
      html += `
        <div style="display:flex; align-items:center; gap:15px; padding:12px; background:rgba(255,255,255,0.03); border-radius:8px;">
          <div style="width:40px; height:40px; background:${color}20; border-radius:50%; display:flex; align-items:center; justify-content:center;">
            <i class="${icon}" style="color:${color};"></i>
          </div>
          <div style="flex:1;">
            <div style="color:#f3f4f6; font-size:14px;">${text}</div>
            <div style="color:#9ca3af; font-size:12px;">${time}</div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading recent activity:', error);
  }
}

// ===== تحميل إعلانات المستخدم =====
async function loadUserProducts() {
  try {
    const snapshot = await db.ref("products")
      .orderByChild("uid")
      .equalTo(currentUser.uid)
      .once("value");
    
    const products = snapshot.val();
    const container = document.getElementById('adsList');
    
    if (!products) {
      container.innerHTML = `
        <div class="empty-state" style="grid-column:1/-1;">
          <i class="fas fa-box-open" style="font-size:60px; margin-bottom:20px;"></i>
          <h3 style="color:#e5e7eb; margin-bottom:10px;">لا توجد إعلانات</h3>
          <p style="color:#9ca3af; margin-bottom:20px;">لم تقم بنشر أي إعلانات بعد</p>
          <button class="btn btn-primary" onclick="window.location.href='index.html?publish=1'">
            <i class="fas fa-plus"></i> نشر أول إعلان
          </button>
        </div>
      `;
      userProducts = [];
      return;
    }
    
    userProducts = Object.keys(products).map(key => ({
      id: key,
      ...products[key]
    }));
    
    displayProducts(userProducts);
  } catch (error) {
    console.error('Error loading user products:', error);
    showAlert('حدث خطأ في تحميل الإعلانات', 'error');
  }
}

function displayProducts(products) {
  const container = document.getElementById('adsList');
  
  if (products.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column:1/-1;">
        <i class="fas fa-search" style="font-size:60px; margin-bottom:20px;"></i>
        <h3 style="color:#e5e7eb; margin-bottom:10px;">لا توجد إعلانات</h3>
        <p style="color:#9ca3af;">لم يتم العثور على إعلانات تطابق الفلتر المحدد</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  products.forEach(product => {
    let statusBadge = '';
    let statusColor = '#10b981';
    
    switch(product.status) {
      case 'sold':
        statusBadge = '<span class="badge" style="background:rgba(239,68,68,0.2); color:#ef4444;">مباع</span>';
        statusColor = '#ef4444';
        break;
      case 'reserved':
        statusBadge = '<span class="badge" style="background:rgba(245,158,11,0.2); color:#f59e0b;">محجوز</span>';
        statusColor = '#f59e0b';
        break;
      default:
        statusBadge = '<span class="badge" style="background:rgba(16,185,129,0.2); color:#10b981;">نشط</span>';
    }
    
    html += `
      <div class="product-item">
        <div class="product-image" style="background:${statusColor}20; color:${statusColor};">
          <i class="fas fa-desktop"></i>
        </div>
        <div class="product-content">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
            <h3 class="product-title">${escapeHTML(product.name)}</h3>
            ${statusBadge}
          </div>
          <div class="product-price">${formatPrice(product.price)} د.ع</div>
          <div class="product-meta">
            <span><i class="fas fa-tag"></i> ${product.category || 'غير محدد'}</span>
            <span><i class="fas fa-map-marker-alt"></i> ${product.province || 'غير محدد'}</span>
          </div>
          <div style="color:#9ca3af; font-size:13px; margin-bottom:15px;">
            <i class="far fa-eye"></i> ${product.views || 0} مشاهدة
          </div>
          <div class="product-actions">
            <button class="btn btn-primary" onclick="viewProduct('${product.id}')">
              <i class="fas fa-eye"></i> عرض
            </button>
            <button class="btn btn-secondary" onclick="editProduct('${product.id}')">
              <i class="fas fa-edit"></i> تعديل
            </button>
            <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">
              <i class="fas fa-trash"></i> حذف
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function filterAds(filterType) {
  // تحديث أزرار الفلتر
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  let filteredProducts = [...userProducts];
  
  switch(filterType) {
    case 'active':
      filteredProducts = userProducts.filter(p => p.status === 'available');
      break;
    case 'sold':
      filteredProducts = userProducts.filter(p => p.status === 'sold');
      break;
    case 'reserved':
      filteredProducts = userProducts.filter(p => p.status === 'reserved');
      break;
    case 'expired':
      // يمكن إضافة منطق للتحقق من انتهاء صلاحية الإعلان
      filteredProducts = userProducts.filter(p => {
        const createdAt = p.createdAt ? new Date(p.createdAt) : new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return createdAt < thirtyDaysAgo;
      });
      break;
    // 'all' يعرض الكل
  }
  
  displayProducts(filteredProducts);
}

// ===== تحميل نموذج التعديل =====
function loadEditForm() {
  if (!userData) return;
  
  // تعبئة الحقول ببيانات المستخدم
  document.getElementById('editFullName').value = userData.fullName || '';
  document.getElementById('editUsername').value = userData.username || '';
  document.getElementById('editEmail').value = currentUser.email || '';
  document.getElementById('editPhone').value = userData.phone || '';
  document.getElementById('editBio').value = userData.bio || '';
  document.getElementById('editProvince').value = userData.province || '';
  document.getElementById('editCity').value = userData.city || '';
}

// تحديث بيانات المستخدم
document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const updatedData = {
    fullName: document.getElementById('editFullName').value.trim(),
    username: document.getElementById('editUsername').value.trim().toLowerCase(),
    phone: document.getElementById('editPhone').value.trim(),
    bio: document.getElementById('editBio').value.trim(),
    province: document.getElementById('editProvince').value,
    city: document.getElementById('editCity').value.trim(),
    lastUpdated: firebase.database.ServerValue.TIMESTAMP
  };
  
  // التحقق من صحة البيانات
  if (!updatedData.fullName || updatedData.fullName.length < 2) {
    showAlert('الاسم الكامل يجب أن يكون على الأقل حرفين', 'error');
    return;
  }
  
  if (!updatedData.username || updatedData.username.length < 3) {
    showAlert('اسم المستخدم يجب أن يكون على الأقل 3 أحرف', 'error');
    return;
  }
  
  if (updatedData.phone && !/^[0][0-9]{10}$/.test(updatedData.phone)) {
    showAlert('رقم الهاتف يجب أن يكون 11 رقم ويبدأ بصفر', 'error');
    return;
  }
  
  try {
    // التحقق من عدم تكرار اسم المستخدم
    if (updatedData.username !== userData.username) {
      const usernameSnapshot = await db.ref("usernames/" + updatedData.username).once('value');
      if (usernameSnapshot.exists() && usernameSnapshot.val() !== currentUser.uid) {
        showAlert('اسم المستخدم هذا مستخدم بالفعل', 'error');
        return;
      }
      
      // تحديث أسماء المستخدمين
      await db.ref("usernames/" + userData.username).remove();
      await db.ref("usernames/" + updatedData.username).set(currentUser.uid);
    }
    
    // تحديث بيانات المستخدم
    await db.ref("users/" + currentUser.uid).update(updatedData);
    
    // تحديث بيانات المستخدم المحلية
    userData = { ...userData, ...updatedData };
    
    // إذا كان البريد الإلكتروني مختلفاً
    const newEmail = document.getElementById('editEmail').value.trim();
    if (newEmail && newEmail !== currentUser.email) {
      await currentUser.updateEmail(newEmail);
    }
    
    showAlert('تم تحديث بياناتك بنجاح', 'success');
    loadProfileData();
    showTab('profile');
  } catch (error) {
    console.error('Error updating profile:', error);
    showAlert('حدث خطأ أثناء تحديث البيانات: ' + error.message, 'error');
  }
});

// تغيير كلمة المرور
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (newPassword !== confirmPassword) {
    showAlert('كلمات المرور غير متطابقة', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showAlert('كلمة المرور يجب أن تكون على الأقل 6 أحرف', 'error');
    return;
  }
  
  try {
    // إعادة المصادقة لتأكيد كلمة المرور الحالية
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      currentPassword
    );
    
    await currentUser.reauthenticateWithCredential(credential);
    
    // تغيير كلمة المرور
    await currentUser.updatePassword(newPassword);
    
    showAlert('تم تغيير كلمة المرور بنجاح', 'success');
    document.getElementById('changePasswordForm').reset();
  } catch (error) {
    console.error('Error changing password:', error);
    showAlert('خطأ في تغيير كلمة المرور: ' + error.message, 'error');
  }
});

// ===== رفع الصورة الرمزية =====
async function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // التحقق من حجم الصورة (5MB كحد أقصى)
  if (file.size > 5 * 1024 * 1024) {
    showAlert('حجم الصورة كبير جداً (الحد الأقصى 5MB)', 'error');
    return;
  }
  
  // التحقق من نوع الصورة
  if (!file.type.match('image.*')) {
    showAlert('الملف يجب أن يكون صورة', 'error');
    return;
  }
  
  try {
    showAlert('جاري رفع الصورة...', 'info');
    
    // رفع الصورة إلى Firebase Storage
    const storageRef = storage.ref();
    const avatarRef = storageRef.child(`avatars/${currentUser.uid}/${Date.now()}_${file.name}`);
    const snapshot = await avatarRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();
    
    // تحديث رابط الصورة في قاعدة البيانات
    await db.ref("users/" + currentUser.uid).update({
      avatarUrl: downloadURL
    });
    
    // تحديث بيانات المستخدم المحلية
    userData.avatarUrl = downloadURL;
    
    // تحديث الصورة في الواجهة
    document.getElementById('profileAvatar').style.backgroundImage = `url('${downloadURL}')`;
    document.getElementById('profileAvatar').style.backgroundSize = 'cover';
    document.getElementById('profileAvatar').style.backgroundPosition = 'center';
    document.getElementById('profileAvatar').textContent = '';
    
    showAlert('تم تحديث صورتك بنجاح', 'success');
  } catch (error) {
    console.error('Error uploading avatar:', error);
    showAlert('حدث خطأ أثناء رفع الصورة', 'error');
  }
}

// ===== إدارة الإعلانات =====
function viewProduct(productId) {
  window.open(`index.html?view=${productId}`, '_blank');
}

function editProduct(productId) {
  window.open(`index.html?edit=${productId}`, '_blank');
}

async function deleteProduct(productId) {
  if (!confirm('هل أنت متأكد من حذف هذا الإعلان؟ هذا الإجراء لا يمكن التراجع عنه.')) {
    return;
  }
  
  try {
    // حذف المنتج
    await db.ref("products/" + productId).remove();
    
    // تحديث عداد المنتجات
    if (userData.totalProducts > 0) {
      await db.ref("users/" + currentUser.uid).update({
        totalProducts: userData.totalProducts - 1
      });
      userData.totalProducts--;
    }
    
    // تسجيل النشاط
    await db.ref("userActivity/" + currentUser.uid).push().set({
      type: 'product_deleted',
      productId: productId,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    
    // تحديث قائمة المنتجات
    userProducts = userProducts.filter(p => p.id !== productId);
    
    showAlert('تم حذف الإعلان بنجاح', 'success');
    displayProducts(userProducts);
    calculateStatistics();
  } catch (error) {
    console.error('Error deleting product:', error);
    showAlert('حدث خطأ أثناء حذف الإعلان', 'error');
  }
}

// ===== إعدادات الحساب =====
function loadSettings() {
  // تحميل الإعدادات المحفوظة
  const settings = JSON.parse(localStorage.getItem(`user_settings_${currentUser.uid}`)) || {
    notifications: true,
    privacy: false,
    darkMode: false
  };
  
  document.getElementById('notificationsToggle').checked = settings.notifications;
  document.getElementById('privacyToggle').checked = settings.privacy;
  document.getElementById('darkModeToggle').checked = settings.darkMode;
  
  // تطبيق الوضع الداكن
  if (settings.darkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeIcon').className = 'fas fa-sun';
  }
}

function saveSettings() {
  const settings = {
    notifications: document.getElementById('notificationsToggle').checked,
    privacy: document.getElementById('privacyToggle').checked,
    darkMode: document.getElementById('darkModeToggle').checked
  };
  
  localStorage.setItem(`user_settings_${currentUser.uid}`, JSON.stringify(settings));
  
  // تطبيق الوضع الداكن مباشرة
  if (settings.darkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeIcon').className = 'fas fa-sun';
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('themeIcon').className = 'fas fa-moon';
  }
  
  showAlert('تم حفظ الإعدادات بنجاح', 'success');
}

function deleteAccount() {
  if (!confirm('⚠️ تحذير: حذف الحساب نهائي!\n\nسيتم:\n• حذف جميع إعلاناتك\n• حذف بياناتك الشخصية\n• لا يمكن استرجاع الحساب\n\nهل أنت متأكد؟')) {
    return;
  }
  
  if (!confirm('يرجى كتابة "حذف" للتأكيد:')) {
    const confirmation = prompt('اكتب "حذف" للتأكيد:');
    if (confirmation !== 'حذف') {
      showAlert('تم إلغاء عملية حذف الحساب', 'info');
      return;
    }
  }
  
  // هنا يمكن إضافة منطق حذف الحساب من Firebase
  // Note: حذف حساب Firebase يتطلب صلاحيات إدارية إضافية
  
  showAlert('لحذف حسابك نهائياً، يرجى التواصل مع الدعم الفني', 'info');
}

// ===== نظام التوثيق =====
async function loadVerificationStatus() {
  const container = document.getElementById('verificationStatus');
  const btn = document.getElementById('verificationBtn');
  
  if (userData.isVerified) {
    container.innerHTML = `
      <div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); color:#10b981; padding:15px; border-radius:10px;">
        <i class="fas fa-check-circle" style="font-size:24px; margin-bottom:10px;"></i>
        <h3 style="margin:10px 0; color:#10b981;">حسابك موثّق ✓</h3>
        <p>تم التحقق من هويتك وبياناتك بنجاح</p>
        <p style="font-size:12px; margin-top:10px;">تاريخ التوثيق: ${new Date(userData.verificationDate || Date.now()).toLocaleDateString('ar-SA')}</p>
      </div>
    `;
    btn.style.display = 'none';
    return;
  }
  
  if (userData.verificationPending) {
    container.innerHTML = `
      <div style="background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); color:#f59e0b; padding:15px; border-radius:10px;">
        <i class="fas fa-clock" style="font-size:24px; margin-bottom:10px;"></i>
        <h3 style="margin:10px 0; color:#f59e0b;">طلبك قيد المراجعة ⏳</h3>
        <p>نقوم بمراجعة بياناتك، سيتم إعلامك عند الانتهاء</p>
        <p style="font-size:12px; margin-top:10px;">يمكن أن تستغرق العملية حتى 48 ساعة</p>
      </div>
    `;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-clock"></i> قيد المراجعة';
    return;
  }
  
  container.innerHTML = `
    <div style="background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.3); color:#3b82f6; padding:15px; border-radius:10px;">
      <i class="fas fa-shield-alt" style="font-size:24px; margin-bottom:10px;"></i>
      <h3 style="margin:10px 0; color:#3b82f6;">حسابك غير موثّق</h3>
      <p>توثيق حسابك يزيد من ثقة المستخدمين بك</p>
    </div>
  `;
}

async function startVerification() {
  // التحقق من اكتمال البيانات المطلوبة
  if (!userData.phone || !userData.fullName || !userData.province) {
    showAlert('يرجى إكمال بياناتك الشخصية أولاً (الاسم، الهاتف، المحافظة)', 'warning');
    showTab('edit');
    return;
  }
  
  if (confirm('لبدء عملية التوثيق، يرجى:\n\n1. إكمال جميع بياناتك الشخصية\n2. التأكد من صحة رقم الهاتف\n3. ستحتاج لرفع صورة بطاقة الهوية\n\nهل تريد المتابعة؟')) {
    // هنا يمكن إضافة منطق رفع بطاقة الهوية
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.onchange = async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        showAlert('جاري رفع المستندات والتحقق...', 'info');
        
        // رفع صورة بطاقة الهوية
        const storageRef = storage.ref();
        const idCardRef = storageRef.child(`verification/${currentUser.uid}/id_card_${Date.now()}.jpg`);
        await idCardRef.put(file);
        
        // تحديث حالة المستخدم
        await db.ref("users/" + currentUser.uid).update({
          verificationPending: true,
          verificationRequestDate: firebase.database.ServerValue.TIMESTAMP,
          idCardUrl: await idCardRef.getDownloadURL()
        });
        
        userData.verificationPending = true;
        
        showAlert('تم تقديم طلب التوثيق بنجاح، سيتم مراجعته خلال 48 ساعة', 'success');
        loadVerificationStatus();
      } catch (error) {
        console.error('Error uploading ID card:', error);
        showAlert('حدث خطأ أثناء رفع المستندات', 'error');
      }
    };
    
    fileInput.click();
  }
}

// ===== دوال مساعدة =====
function maskPhoneNumber(phone) {
  if (!phone || phone.length !== 11) return phone;
  return phone.substring(0, 4) + '****' + phone.substring(8);
}

function formatPrice(price) {
  return parseInt(price).toLocaleString('ar-SA');
}

function escapeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function toggleTheme() {
  const body = document.body;
  const icon = document.getElementById('themeIcon');
  
  if (body.classList.contains('dark-mode')) {
    body.classList.remove('dark-mode');
    icon.className = 'fas fa-moon';
    // تحديث الإعدادات المحلية
    if (currentUser) {
      const settings = JSON.parse(localStorage.getItem(`user_settings_${currentUser.uid}`)) || {};
      settings.darkMode = false;
      localStorage.setItem(`user_settings_${currentUser.uid}`, JSON.stringify(settings));
    }
  } else {
    body.classList.add('dark-mode');
    icon.className = 'fas fa-sun';
    // تحديث الإعدادات المحلية
    if (currentUser) {
      const settings = JSON.parse(localStorage.getItem(`user_settings_${currentUser.uid}`)) || {};
      settings.darkMode = true;
      localStorage.setItem(`user_settings_${currentUser.uid}`, JSON.stringify(settings));
    }
  }
}

// تسجيل الخروج
function logout() {
  if (confirm('هل تريد تسجيل الخروج؟')) {
    auth.signOut().then(() => {
      window.location.href = 'index.html';
    }).catch(error => {
      console.error('Logout error:', error);
      showAlert('حدث خطأ أثناء تسجيل الخروج', 'error');
    });
  }
}

// ===== تهيئة الصفحة =====
document.addEventListener('DOMContentLoaded', async function() {
  // التحقق من تسجيل الدخول
  auth.onAuthStateChanged(async (user) => {
    if (!user || user.isAnonymous) {
      showAlert('يرجى تسجيل الدخول للوصول إلى هذه الصفحة', 'error');
      setTimeout(() => window.location.href = 'index.html', 2000);
      return;
    }
    
    currentUser = user;
    
    try {
      // جلب بيانات المستخدم
      const snapshot = await db.ref("users/" + user.uid).once("value");
      userData = snapshot.val();
      
      if (!userData) {
        // إنشاء بيانات افتراضية
        userData = {
          username: user.email ? user.email.split('@')[0] : 'user',
          fullName: 'مستخدم جديد',
          email: user.email,
          phone: '',
          isVerified: false,
          isAdmin: false,
          totalProducts: 0,
          joinDate: firebase.database.ServerValue.TIMESTAMP
        };
        
        await db.ref("users/" + user.uid).set(userData);
        
        // تسجيل اسم المستخدم
        await db.ref("usernames/" + userData.username).set(user.uid);
      }
      
      // تحميل البيانات الأولية
      loadProfileData();
      await loadUserProducts();
      loadSettings();
      
      // تحميل بيانات التبويب الأول
      showTab('profile');
      
    } catch (error) {
      console.error('Error loading user data:', error);
      showAlert('حدث خطأ في تحميل بيانات الحساب', 'error');
    }
  });
  
  // إغلاق الشريط الجانبي عند النقر خارجها
  document.addEventListener('click', function(event) {
    if (window.innerWidth < 768 && 
        !event.target.closest('.sidebar') && 
        !event.target.closest('.menu-toggle')) {
      closeSidebar();
    }
  });
});
</script>
</body>
</html>
